#Se quiser ainda um m√≠nimo (por exemplo, nunca descer abaixo de 150¬∞C), defina:
#- SET_GCODE_VARIABLE MACRO=TROCA VARIABLE=min_standby VALUE=150

[gcode_macro TOOL_DATA]
variable_debugativo: False
variable_z_antes: 0.0
variable_dist_tool: 67.5  # Ajustado para T4=279mm exato mantendo T0=9mm refer√™ncia
# üìç Posi√ß√µes f√≠sicas no dock
variable_dock_x1: 10.0
variable_dock_x2: 90.0
variable_dock_x3: 169.0
variable_dock_x4: 249.0
variable_dock_x5: 0.0

variable_standby_temp_T1: 170
variable_standby_temp_T2: 170
variable_standby_temp_T3: 170
variable_standby_temp_T4: 170

# üõ†Ô∏è Offsets da ferramenta T0~T3 (apenas X/Y - Z lido diretamente de variables.cfg)
#  T0   branco (refer√™ncia BLTouch)
variable_offset_x1: 0 #@-0.1 #0.1 #0.0
variable_offset_y1: 0 #-0.1 #0.1  #0.0

#  T1 azul - X/Y fixos calibrados manualmente
variable_offset_x2: -1.0 #0.2  #0.1 # Valor fixo calibrado manualmente
variable_offset_y2: -1.1 #-0.8  #-1.0 #1.1 # -0.3   # Valor fixo calibrado manualmente

#  T2 marrom - X/Y fixos calibrados manualmente
variable_offset_x3: -1.0 #0.9 #0.8 # Valor fixo calibrado manualmente
variable_offset_y3: -1.8 #-1.8  #-1.1 #0.0  #0.1   # Valor fixo calibrado manualmente
#  T3 - X/Y iniciais para calibra√ß√£o posterior
variable_offset_x4: 0 #0.1
variable_offset_y4: 0 #@0.1



variable_offset_x5: 0 #0.1
variable_offset_y5: 0 #@0.1
### üéØ Resumo Pr√°tico
#Com os valores atuais offset_x3: 0.2 e offset_y3: 0.5 , a ferramenta T2 est√° sendo compensada:
#- 0.2mm para a direita (eixo X)
#- 0.5mm para frente (eixo Y)
#X POSITIVO MOVE PRA DIREITA
#Y POSITIVO MOVE PARA CIMA


# offset_z4 removido - Z lido diretamente de variables.cfg como tool_2_offset_z

# üß† Dados auxiliares
variable_tool_y: 279 #278  # Posi√ß√£o necess√°ria para travamento magn√©tico das ferramentas
variable_secure_y: 200
variable_approach_speed: 10000
variable_feedrate_troca: 20000
variable_servo_open_min_y: 260


gcode:
  {% if printer["gcode_macro TOOL_DATA"].debugativo %}
    RESPOND MSG="TOOL_DATA carregada"
  {% endif %}
  {% set base_x = printer["gcode_macro TOOL_DATA"].dock_x1|float %}
  {% set dist = printer["gcode_macro TOOL_DATA"].dist_tool|default(0)|float %}
  {% if dist > 0 %}
    {% set x2 = base_x + dist %}
    {% set x3 = x2 + dist %}
    {% set x4 = x3 + dist %}
    {% set x5 = x4 + dist %}
    SET_GCODE_VARIABLE MACRO=TOOL_DATA VARIABLE=dock_x2 VALUE={x2}
    SET_GCODE_VARIABLE MACRO=TOOL_DATA VARIABLE=dock_x3 VALUE={x3}
    SET_GCODE_VARIABLE MACRO=TOOL_DATA VARIABLE=dock_x4 VALUE={x4}
    SET_GCODE_VARIABLE MACRO=TOOL_DATA VARIABLE=dock_x5 VALUE={x5}
    RESPOND PREFIX="TOOL" MSG="dock_x: [x1={base_x}, x2={x2}, x3={x3}, x4={x4}, x5={x5}] (dist={dist})"
  {% else %}
    {% set x2 = printer["gcode_macro TOOL_DATA"].dock_x2|float %}
    {% set x3 = printer["gcode_macro TOOL_DATA"].dock_x3|float %}
    {% set x4 = printer["gcode_macro TOOL_DATA"].dock_x4|float %}
    {% set x5 = printer["gcode_macro TOOL_DATA"].dock_x5|float %}
    RESPOND PREFIX="TOOL" MSG="dock_x: [x1={base_x}, x2={x2}, x3={x3}, x4={x4}, x5={x5}] (dist={dist})"
  {% endif %}

[delayed_gcode INIT_TOOL_DATA]
initial_duration: 0.3
gcode:
  TOOL_DATA
  {% set base_x = printer["gcode_macro TOOL_DATA"].dock_x1|float %}
  {% set dist = printer["gcode_macro TOOL_DATA"].dist_tool|default(0)|float %}
  {% if dist > 0 %}
    {% if printer["gcode_macro TOOL_DATA"].dock_x2|float == 0.0 %}
      SET_GCODE_VARIABLE MACRO=TOOL_DATA VARIABLE=dock_x2 VALUE={base_x + 1*dist}
    {% endif %}
    {% if printer["gcode_macro TOOL_DATA"].dock_x3|float == 0.0 %}
      SET_GCODE_VARIABLE MACRO=TOOL_DATA VARIABLE=dock_x3 VALUE={base_x + 2*dist}
    {% endif %}
    {% if printer["gcode_macro TOOL_DATA"].dock_x4|float == 0.0 %}
      SET_GCODE_VARIABLE MACRO=TOOL_DATA VARIABLE=dock_x4 VALUE={base_x + 3*dist}
    {% endif %}
    {% if printer["gcode_macro TOOL_DATA"].dock_x5|float == 0.0 %}
      SET_GCODE_VARIABLE MACRO=TOOL_DATA VARIABLE=dock_x5 VALUE={base_x + 4*dist}
    {% endif %}
  {% endif %}

[delayed_gcode INIT_TOOL_STATE]
initial_duration: 0.2
gcode:
  TOOL_STATE


  
 
[gcode_macro G12]
description: "Limpeza/Purga do bico (X=-19 Y=0, E10; varredura Y13‚ÜîY88 5x a 100mm/s)"
gcode:
  G90
  RESPOND PREFIX="INFO" MSG="üîÑ G12: Iniciando purga (X=-19 Y=0, E10)"
  G1 X-13 Y5 F26000
  SET_FAN_SPEED FAN=Print_Cooling SPEED=1
  G92 E0
  G1 E55 F1000
  G92 E0
  g4 P2000
  SET_FAN_SPEED FAN=Print_Cooling SPEED=0
  RESPOND PREFIX="INFO" MSG="üîÑ G12: Iniciando limpeza vai-e-vem (Y13‚ÜîY88, 5x, 100mm/s)"
  G1 X-13 Y13 F16000
  {% for i in range(3) %}
    G1 Y88 F16000
    G1 Y13 F16000
  {% endfor %}
  G1 Y100 F6000
  RESPOND PREFIX="INFO" MSG="‚úÖ G12: Limpeza conclu√≠da"
  M117 G12 conclu√≠do

[gcode_macro CLEAN_NOZZLE_T0]
description: "Limpeza do bico usando offset correto da ferramenta ativa"
gcode:
  {% set start_x = printer.toolhead.position.x|default(0) %}
  {% set start_y = printer.toolhead.position.y|default(0) %}
  {% set start_z = printer.toolhead.position.z|default(5) %}
  {% set active_tool = printer.toolhead.extruder %}
  {% set temp = printer[active_tool].temperature|float %}
  {% if temp >= 170 %}
  #{% if printer.extruder.temperature|float >= 170 %}

     SET_SERVO SERVO=tool_servo WIDTH=1
    ; üîß CORRE√á√ÉO: T0 deve ter offset ZERO (√© a refer√™ncia com BLTouch)
    ; T0 = ferramenta f√≠sica 1, mas offset deve ser 0,0,0 (refer√™ncia)
    {% set current_tool = printer["gcode_macro TOOL_STATE"].tool|int %}
    {% set vars = printer.save_variables.variables %}
    {% if current_tool == 1 %}
        ; T0 (ferramenta f√≠sica 1) = offset ZERO (refer√™ncia BLTouch)
        {% set x = 0.0 %}
        {% set y = 0.0 %}
        {% set z = 0.0 %}
        {% if printer["gcode_macro TOOL_DATA"].debugativo %}
            RESPOND PREFIX="INFO" MSG="T0 (refer√™ncia): Offset ZERO aplicado X={x} Y={y} Z={z}"
          {% endif %}
    {% elif current_tool == 2 %}
        ; T1 - X/Y fixos do TOOL_DATA, Z direto do variables.cfg
        {% set x = printer["gcode_macro TOOL_DATA"].get("offset_x2")|default(0)|float %}
        {% set y = printer["gcode_macro TOOL_DATA"].get("offset_y2")|default(0)|float %}
        {% set z = vars.get('tool_0_offset_z', 0.0)|float %}
        {% if printer["gcode_macro TOOL_DATA"].debugativo %}
            RESPOND PREFIX="INFO" MSG="T1: Offset aplicado X={x} Y={y} Z={z} (Z direto de variables.cfg)"
          {% endif %}
    {% elif current_tool == 3 %}
        ; T2 - X/Y fixos do TOOL_DATA, Z direto do variables.cfg
        {% set x = printer["gcode_macro TOOL_DATA"].get("offset_x3")|default(0)|float %}
        {% set y = printer["gcode_macro TOOL_DATA"].get("offset_y3")|default(0)|float %}
        {% set z = vars.get('tool_1_offset_z', 0.0)|float %}
        {% if printer["gcode_macro TOOL_DATA"].debugativo %}
            RESPOND PREFIX="INFO" MSG="T2: Offset aplicado X={x} Y={y} Z={z} (Z direto de variables.cfg)"
          {% endif %}
    {% else %}
        {% set x = printer["gcode_macro TOOL_DATA"].get("offset_x" ~ current_tool)|default(0)|float %}
        {% set y = printer["gcode_macro TOOL_DATA"].get("offset_y" ~ current_tool)|default(0)|float %}
        {% set z = vars.get('tool_' ~ (current_tool - 2) ~ '_offset_z', 0.0)|float %}
        {% if printer["gcode_macro TOOL_DATA"].debugativo %}
          RESPOND PREFIX="INFO" MSG="T{current_tool}: Offset aplicado X={x} Y={y} Z={z} (Z direto de variables.cfg)"
        {% endif %}
    {% endif %}
    SET_GCODE_OFFSET X={x} Y={y} Z={z} MOVE=1
  
  
  
    ; Aproxima pela rota segura com Y ‚â§ 200
    G90 
    G1 X235 Y200 F10000
    G1 X280 Y260 F10000
    G1 x315 Y251 F10000
    G91
    #G1 E15 F3000
    G4 P1000
    G90
    ; Posi√ß√£o de limpeza
    G1 x315 Y223 F10000
    
    ; Sequ√™ncia de limpeza
    G91
    #G1 E5 F3000
    G1 Y-12 F3000
    G4 P1000
    G1 Y12 F3000
    G90
    
    ; Retorno via rota segura
    G1 x315 Y200 F10000
    G1  Y{start_y} F10000 #X{start_x}
    G1 Z{start_z} F6000
    
    ; Aplica offset da ferramenta ativa
    APPLY_TOOL_OFFSET
    
    ; Restaura velocidade de impress√£o padr√£o
    G1 F{printer.configfile.settings.printer.max_velocity * 60}
  {% else %}
    {% if printer["gcode_macro TOOL_DATA"].debugativo %}
      RESPOND PREFIX="WARN" MSG="‚ùå Temperatura do extrusor est√° abaixo de 170 ¬∞C. Macro abortado."
    {% endif %}
  
  {% endif %}

   SET_SERVO SERVO=tool_servo WIDTH=0
  


  

#[gcode_macro TOOL_STATE]
#variable_tool: 0
#gcode:
#  {% set saved_tool = printer.save_variables.variables.tool|default(0)|int %}
#  SET_GCODE_VARIABLE MACRO=TOOL_STATE VARIABLE=tool VALUE={saved_tool}
#  RESPOND PREFIX="DEBUG" MSG="TOOL_STATE restaurado: Tool {saved_tool}"
#  M117 TOOL_STATE restaurado: Tool {saved_tool}
[gcode_macro TOOL_STATE]
variable_tool: 1
variable_switch_present: True
gcode:
  {% set saved_tool = printer.save_variables.variables.tool|default(0)|int %}
  {% set confirmed_present = 0 %}
  {% for k in range(3) %}
    QUERY_ENDSTOPS
    {% set s = printer.query_endstops.last_query["manual_stepper tool_dock_stepper"]|default(0)|int %}
    {% set confirmed_present = confirmed_present + s %}
    G4 P150
  {% endfor %}
  {% set present = (confirmed_present >= 2)|int %}
  RESPOND PREFIX="TRACK" MSG="TROCA present_maj={present} (3x)"
  {% if present and saved_tool > 0 %}
    SET_GCODE_VARIABLE MACRO=TOOL_STATE VARIABLE=tool VALUE={saved_tool}
  {% else %}
    SET_GCODE_VARIABLE MACRO=TOOL_STATE VARIABLE=tool VALUE=0
  {% endif %}
  {% if printer["gcode_macro TOOL_DATA"].debugativo %}
    RESPOND PREFIX="DEBUG" MSG="TOOL_STATE: present={present} saved_tool={saved_tool}"
  {% endif %}
  M117 TOOL_STATE: present={present} saved={saved_tool}

# [gcode_macro SET_GCODE_OFFSET] - INTERCEPTA√á√ÉO DESATIVADA
# rename_existing: SET_GCODE_OFFSET_BASE
# gcode:
#   RESPOND PREFIX="DEBUG" MSG="Interceptado: SET_GCODE_OFFSET Z={params.Z|default('')} X={params.X|default('')} Y={params.Y|default('')}"
#   SET_GCODE_OFFSET_BASE {rawparams}

[gcode_macro APPLY_TOOL_OFFSET]
gcode:
  {% set tool = printer["gcode_macro TOOL_STATE"].tool|int %}
  {% set vars = printer.save_variables.variables %}
  
  ; üîß CORRE√á√ÉO: T0 (tool=1) deve ter offset ZERO (refer√™ncia BLTouch)
  {% if tool == 1 %}
    ; T0 = ferramenta f√≠sica 1, mas √© a refer√™ncia (offset zero)
    {% set x = 0.0 %}
    {% set y = 0.0 %}
    {% set z = 0.0 %}
    RESPOND PREFIX="INFO" MSG="T0 (refer√™ncia): Offset ZERO aplicado X={x} Y={y} Z={z}"
  {% elif tool == 2 %}
    ; T1 - X/Y fixos do TOOL_DATA, Z direto do variables.cfg
    {% set x = printer["gcode_macro TOOL_DATA"].get("offset_x2")|default(0)|float %}
    {% set y = printer["gcode_macro TOOL_DATA"].get("offset_y2")|default(0)|float %}
    {% set z = vars.get('tool_0_offset_z', 0.0)|float %}
    RESPOND PREFIX="INFO" MSG="T1: Offset aplicado X={x} Y={y} Z={z} (Z direto de variables.cfg)"
  {% elif tool == 3 %}
    ; T2 - X/Y fixos do TOOL_DATA, Z direto do variables.cfg
    {% set x = printer["gcode_macro TOOL_DATA"].get("offset_x3")|default(0)|float %}
    {% set y = printer["gcode_macro TOOL_DATA"].get("offset_y3")|default(0)|float %}
    {% set z = vars.get('tool_1_offset_z', 0.0)|float %}
    RESPOND PREFIX="INFO" MSG="T2: Offset aplicado X={x} Y={y} Z={z} (Z direto de variables.cfg)"
  {% elif tool == 4 %}
    ; T3 - X/Y fixos do TOOL_DATA, Z direto do variables.cfg
    {% set x = printer["gcode_macro TOOL_DATA"].get("offset_x4")|default(0)|float %}
    {% set y = printer["gcode_macro TOOL_DATA"].get("offset_y4")|default(0)|float %}
    {% set z = vars.get('tool_2_offset_z', 0.0)|float %}
    {% if printer["gcode_macro TOOL_DATA"].debugativo %}
       RESPOND PREFIX="INFO" MSG="T3: Offset aplicado X={x} Y={y} Z={z} (Z direto de variables.cfg)"
     {% endif %}
  {% else %}
    {% set x = printer["gcode_macro TOOL_DATA"].get("offset_x" ~ tool)|default(0)|float %}
    {% set y = printer["gcode_macro TOOL_DATA"].get("offset_y" ~ tool)|default(0)|float %}
    {% set z = vars.get('tool_' ~ (tool - 2) ~ '_offset_z', 0.0)|float %}
    {% if printer["gcode_macro TOOL_DATA"].debugativo %}
       RESPOND PREFIX="INFO" MSG="TOOL={tool}: Offset aplicado X={x} Y={y} Z={z} (Z direto de variables.cfg)"
     {% endif %}
  {% endif %}
  
  G1 f10000
  M117 Offset aplicado: TOOL={tool}
  {% set homed = printer.toolhead.homed_axes %}
  {% set can_move = 'x' in homed and 'y' in homed and 'z' in homed %}
  {% if can_move %}
    SET_GCODE_OFFSET X={x} Y={y}  MOVE=1
    SET_GCODE_OFFSET Z={z}  X={x} Y={y} MOVE=1
  {% else %}
    SET_GCODE_OFFSET X={x} Y={y}
    SET_GCODE_OFFSET Z={z}  X={x} Y={y}
  {% endif %}


[gcode_macro APPLY_TOOLZ_OFFSET]
gcode:
  {% set tool = printer["gcode_macro TOOL_STATE"].tool|int %}
  {% set vars = printer.save_variables.variables %}
  
  ; üîß CORRE√á√ÉO: T0 (tool=1) deve ter offset ZERO (refer√™ncia BLTouch)
  {% if tool == 1 %}
    ; T0 = ferramenta f√≠sica 1, mas √© a refer√™ncia (offset zero) 
    {% set z = 0.0 %}
    RESPOND PREFIX="INFO" MSG="T0 (refer√™ncia): Offset ZERO aplicado X={x} Y={y} Z={z}"
  {% elif tool == 2 %}
    ; T1 - X/Y fixos do TOOL_DATA, Z direto do variables.cfg 
    {% set z = vars.get('tool_0_offset_z', 0.0)|float %}
    RESPOND PREFIX="INFO" MSG="T1: Offset aplicado X={x} Y={y} Z={z} (Z direto de variables.cfg)"
  {% elif tool == 3 %}
    ; T2 - X/Y fixos do TOOL_DATA, Z direto do variables.cfg 
    {% set z = vars.get('tool_1_offset_z', 0.0)|float %}
    RESPOND PREFIX="INFO" MSG="T2: Offset aplicado X={x} Y={y} Z={z} (Z direto de variables.cfg)"
  {% elif tool == 4 %}
    ; T3 - X/Y fixos do TOOL_DATA, Z direto do variables.cfg 
    {% set z = vars.get('tool_2_offset_z', 0.0)|float %}
    {% if printer["gcode_macro TOOL_DATA"].debugativo %}
       RESPOND PREFIX="INFO" MSG="T3: Offset aplicado X={x} Y={y} Z={z} (Z direto de variables.cfg)"
     {% endif %}
  {% elif tool == 4 %}
    ; T3 - X/Y fixos do TOOL_DATA, Z direto do variables.cfg 
    {% set z = vars.get('tool_3_offset_z', 0.0)|float %}
    {% if printer["gcode_macro TOOL_DATA"].debugativo %}
       RESPOND PREFIX="INFO" MSG="T4: Offset aplicado X={x} Y={y} Z={z} (Z direto de variables.cfg)"
     {% endif %}
  {% else %}
    {% set z = vars.get('tool_' ~ (tool - 2) ~ '_offset_z', 0.0)|float %}
    {% if printer["gcode_macro TOOL_DATA"].debugativo %}
       RESPOND PREFIX="INFO" MSG="TOOL={tool}: Offset aplicado X={x} Y={y} Z={z} (Z direto de variables.cfg)"
     {% endif %}
  {% endif %}
  
  G1 f10000
  M117 Offset Z aplicado: TOOL={tool}
 
  SET_GCODE_OFFSET Z={z}    MOVE=1

  
[gcode_macro APPLY_TOOL_OFFSET_UNSEC]
gcode:
  {% set tool = printer["gcode_macro TOOL_STATE"].tool|int %}
  {% set vars = printer.save_variables.variables %}
  
  ; üîß CORRE√á√ÉO: T0 (tool=1) deve ter offset ZERO (refer√™ncia BLTouch)
  {% if tool == 1 %}
    ; T0 = ferramenta f√≠sica 1, mas √© a refer√™ncia (offset zero)
    {% set x = 0.0 %}
    {% set y = 0.0 %}
    {% set z = 0.0 %}
    RESPOND PREFIX="INFO" MSG="T0 (refer√™ncia): Offset ZERO aplicado X={x} Y={y} Z={z}"
  {% elif tool == 2 %}
    ; T1 - X/Y fixos do TOOL_DATA, Z direto do variables.cfg
    {% set x = printer["gcode_macro TOOL_DATA"].get("offset_x2")|default(0)|float %}
    {% set y = printer["gcode_macro TOOL_DATA"].get("offset_y2")|default(0)|float %}
    {% set z = vars.get('tool_0_offset_z', 0.0)|float %}
    RESPOND PREFIX="INFO" MSG="T1: Offset aplicado X={x} Y={y} Z={z} (Z direto de variables.cfg)"
  {% elif tool == 3 %}
    ; T2 - X/Y fixos do TOOL_DATA, Z direto do variables.cfg
    {% set x = printer["gcode_macro TOOL_DATA"].get("offset_x3")|default(0)|float %}
    {% set y = printer["gcode_macro TOOL_DATA"].get("offset_y3")|default(0)|float %}
    {% set z = vars.get('tool_1_offset_z', 0.0)|float %}
    RESPOND PREFIX="INFO" MSG="T2: Offset aplicado X={x} Y={y} Z={z} (Z direto de variables.cfg)"
  {% elif tool == 4 %}
    ; T3 - X/Y fixos do TOOL_DATA, Z direto do variables.cfg
    {% set x = printer["gcode_macro TOOL_DATA"].get("offset_x4")|default(0)|float %}
    {% set y = printer["gcode_macro TOOL_DATA"].get("offset_y4")|default(0)|float %}
    {% set z = vars.get('tool_2_offset_z', 0.0)|float %}
    RESPOND PREFIX="INFO" MSG="T3: Offset aplicado X={x} Y={y} Z={z} (Z direto de variables.cfg)"
      {% elif tool == 4 %}
    ; T3 - X/Y fixos do TOOL_DATA, Z direto do variables.cfg
    {% set x = printer["gcode_macro TOOL_DATA"].get("offset_x4")|default(0)|float %}
    {% set y = printer["gcode_macro TOOL_DATA"].get("offset_y4")|default(0)|float %}
    {% set z = vars.get('tool_3_offset_z', 0.0)|float %}
    RESPOND PREFIX="INFO" MSG="T4: Offset aplicado X={x} Y={y} Z={z} (Z direto de variables.cfg)" 
  {% else %}
    {% set x = printer["gcode_macro TOOL_DATA"].get("offset_x" ~ tool)|default(0)|float %}
    {% set y = printer["gcode_macro TOOL_DATA"].get("offset_y" ~ tool)|default(0)|float %}
    {% set z = vars.get('tool_' ~ (tool - 2) ~ '_offset_z', 0.0)|float %}
    RESPOND PREFIX="INFO" MSG="TOOL={tool}: Offset aplicado X={x} Y={y} Z={z} (Z direto de variables.cfg)"
  {% endif %}
  
  G1 f10000
  M117 Offset aplicado: TOOL={tool}

  SET_GCODE_OFFSET X={x} Y={y}  MOVE=1 
  SET_GCODE_OFFSET Z={z}  X={x} Y={y} MOVE=1

[gcode_macro SET_DIF_TEMP]
description: "Define o delta de resfriamento na macro TROCA (ex.: SET_DIF_TEMP delta=25)"
gcode:
  {% set delta = params.DELTA|default(20)|int %}  ; Default 20 se n√£o especificado
  SET_GCODE_VARIABLE MACRO=TROCA VARIABLE=dif_temp VALUE={delta}
  RESPOND PREFIX="INFO" MSG="DIF_TEMP definido para {delta}¬∞C na macro TROCA"

 
 

# Adicionar no in√≠cio da macro TROCA (logo ap√≥s as vari√°veis)
[gcode_macro TROCA]
variable_dif_temp: 25
variable_z_antes: 0.0

variable_skip_filamento: False
variable_skip_move: False
variable_skip_extruder: False
variable_min_standby: 0
variable_next_tool: 0
variable_ignore_lidar: 0
variable_disconnected: False
gcode:
  PSU_ON_SAFE
  {% set homed = printer.toolhead.homed_axes %}
  {% set ignore_init = printer.save_variables.variables.ignore_init_tool_check|default(False) %}
  {% if 'x' not in homed or 'y' not in homed %}
    {% if ignore_init %}
      RESPOND PREFIX="WARNING" MSG="Homing bloqueado (ignore_init_tool_check ativo) ‚Äî TROCA abortada"
      G90
      VERIFICA_CONEXAO_TOOL ACAO=11 TOOL=0  # 11=movimento_y_seguro_condicional (sensor fechado)
      PAUSE
    {% else %}
      G28
    {% endif %}
  {% endif %}
  {% set ignore_lidar = params.IGNORE_LIDAR|default(0)|int %}
  {% set tool = params.TOOL|default(0)|int %}
  SET_GCODE_VARIABLE MACRO=TROCA VARIABLE=next_tool VALUE={tool}
  SET_GCODE_VARIABLE MACRO=TROCA VARIABLE=ignore_lidar VALUE={ignore_lidar}
  {% set vars = printer.save_variables.variables %}
  {% set new_temp = vars.get('tool_temp_' ~ tool, 0)|int %}
  {% set new_extr = 'extruder' if tool == 1 else 'extruder' ~ (tool - 1) %}
  {% if new_temp > 0 %}
    M104.0 T{tool - 1} S{new_temp}
    RESPOND MSG="Pr√©-aquecendo Tool {tool - 1} para {new_temp}¬∞C (early)"
  {% else %}
    RESPOND MSG="Nenhuma temperatura salva para Tool {tool - 1} ‚Äî pr√©-aquecimento ser√° aplicado quando dispon√≠vel"
  {% endif %}

  
  {% set z_atual = printer.toolhead.position.z|float %}
  SET_GCODE_VARIABLE MACRO=TROCA VARIABLE=z_antes VALUE={z_atual}
  {% set tool_y = printer["gcode_macro TOOL_DATA"].tool_y|int %}
  {% set secure_y = printer["gcode_macro TOOL_DATA"].secure_y|int %}
  {% set approach_speed = printer["gcode_macro TOOL_DATA"].approach_speed|int %}
  {% set x_pos = printer["gcode_macro TOOL_DATA"].get("dock_x" ~ tool)|float %}
  {% set approach_pre = tool_y - 10 %}
  {% set approach_slow = approach_speed // 20 %}
  {% set active_tool = printer["gcode_macro TOOL_STATE"].tool|int %}
 
  {% set extruders = {1: "extruder", 2: "extruder1", 3: "extruder2", 4: "extruder3", 5: "extruder4"} %}
  {% set standby = {
    1: printer["gcode_macro TOOL_DATA"].standby_temp_T1|default(170)|int,
    2: printer["gcode_macro TOOL_DATA"].standby_temp_T2|default(170)|int,
    3: printer["gcode_macro TOOL_DATA"].standby_temp_T3|default(170)|int,
    4: printer["gcode_macro TOOL_DATA"].standby_temp_T4|default(170)|int
  } %}
  
  # Nova l√≥gica de temperatura: Resfriar todas as outras ativas respeitando dif_temp (sem quedas cumulativas)
  {% set all_tools = [1,2,3,4] %}  # Ferramentas dispon√≠veis (ajuste se necess√°rio)
  {% for i in all_tools %}
    {% if i != tool %}
      {% set extr_name = "extruder" if i == 1 else "extruder" ~ (i - 1) %}
      {% set curr_temp = printer[extr_name].temperature|float %}
      {% if curr_temp > 50 %}  # Considera "ativa" se >50¬∞C (ajuste o limiar se quiser)
        {% set saved_temp = vars.get('tool_temp_' ~ i, 0)|int %}
        {% if saved_temp == 0 and printer[extr_name].target|default(0)|int > 0 %}
          {% set saved_temp = printer[extr_name].target|int %}
          SAVE_VARIABLE VARIABLE=tool_temp_{i} VALUE={saved_temp}
        {% endif %}
        {% if saved_temp > 0 %}
          {% set standby_temp = [saved_temp - dif_temp, printer["gcode_macro TROCA"].min_standby|default(0)]|max %}
          M104.0 T{i - 1} S{standby_temp}  # Resfria (sem wait)
          RESPOND MSG="Resfriando Tool {i - 1}: base={saved_temp} ‚Üí standby={standby_temp} (‚àí{dif_temp}¬∞C)"
        {% endif %}
      {% endif %}
    {% endif %}
  {% endfor %}
  

  {% if active_tool != tool %}
    SAVE_GCODE_STATE NAME=toolchange
    RESPOND PREFIX="TRACK" MSG="TROCA start tool={tool} active_tool={active_tool} present={present} x_pos={x_pos} tool_y={tool_y} secure_y={secure_y}"
    SET_GCODE_OFFSET X=0 Y=0 Z=0
    G90

    {% set active_tool = printer["gcode_macro TOOL_STATE"].tool|int %}
    QUERY_ENDSTOPS
    {% set endstops = printer.query_endstops.last_query %}
    {% set s = 0 %}
    {% for kk in endstops %}
      {% if 'tool_dock_stepper' in kk %}
        {% set v = endstops[kk] %}
        {% set s = 1 if (v == 1 or v|string == 'TRIGGERED' or v|string == 'triggered') else 0 %}
      {% endif %}
    {% endfor %}
    {% set saved_last = printer.save_variables.variables.last_tool|default(0)|int %}
    {% set active_eff = active_tool if active_tool > 0 else saved_last %}
    RESPOND PREFIX="TRACK" MSG="TROCA active_tool={active_tool} saved_last={saved_last} sensor={s}"
    {% if active_tool > 0 or (active_eff > 0 and s == 1) %}
      RESPOND PREFIX="TRACK" MSG="TROCA undock_decision: active_tool={active_tool} active_eff={active_eff} sensor={s} ‚Üí DESCONECTA"
      DESCONECTA NEXT_TOOL={tool}
    {% else %}
      RESPOND PREFIX="TRACK" MSG="TROCA undock_decision: active_tool={active_tool} active_eff={active_eff} sensor={s} ‚Üí SKIP"
    {% endif %}
    CONECTA TOOL={tool}
  {% else %}
    {% set msg = "Tool " ~ tool ~ " j√° est√° ativa" %}
    RESPOND MSG="{msg}"
    M117 {msg}
  {% endif %}
  G1 F20000
  G91
  G1 y-5 F18000
  G90
  # No final da macro TROCA (antes do movimento para torre de purga)

  
  G1 Y200 F{printer["gcode_macro TOOL_DATA"].feedrate_troca}  # volta na posicao segura para nao trombar as ferramentas
  #G1 X150 F11000 ; Move para a posi√ß√£o da torre de purga (sequ√™ncia segura)



[gcode_macro TROCA_DESACOPLA]
gcode:
  {% set tool = params.TOOL|default(printer["gcode_macro TROCA"].next_tool)|int %}
  TROCA TOOL={tool}

[gcode_macro TROCA_ACOPLA]
gcode:
  RESPOND PREFIX="INFO" MSG="TROCA_ACOPLA desativada (sem delayed_gcode)"


# --- Macros para T0 ---
[gcode_macro MAP_T0_E0]
gcode:
  SET_SPOOL_MAP T0=1

[gcode_macro MAP_T0_E1]
gcode:
  SET_SPOOL_MAP T0=2

[gcode_macro MAP_T0_E2]
gcode:
  SET_SPOOL_MAP T0=3

[gcode_macro MAP_T0_E3]
gcode:
  SET_SPOOL_MAP T0=4

[gcode_macro MAP_T0_E4]
gcode:
  SET_SPOOL_MAP T0=5

# --- Macros para T1 ---
[gcode_macro MAP_T1_E0]
gcode:
  SET_SPOOL_MAP T1=1

[gcode_macro MAP_T1_E1]
gcode:
  SET_SPOOL_MAP T1=2

[gcode_macro MAP_T1_E2]
gcode:
  SET_SPOOL_MAP T1=3

[gcode_macro MAP_T1_E3]
gcode:
  SET_SPOOL_MAP T1=4

[gcode_macro MAP_T1_E4]
gcode:
  SET_SPOOL_MAP T1=5

# --- Macros para T2 ---
[gcode_macro MAP_T2_E0]
gcode:
  SET_SPOOL_MAP T2=1

[gcode_macro MAP_T2_E1]
gcode:
  SET_SPOOL_MAP T2=2

[gcode_macro MAP_T2_E2]
gcode:
  SET_SPOOL_MAP T2=3

[gcode_macro MAP_T2_E3]
gcode:
  SET_SPOOL_MAP T2=4

[gcode_macro MAP_T2_E4]
gcode:
  SET_SPOOL_MAP T2=5

# --- Macros para T3 ---
[gcode_macro MAP_T3_E0]
gcode:
  SET_SPOOL_MAP T3=1

[gcode_macro MAP_T3_E1]
gcode:
  SET_SPOOL_MAP T3=2

[gcode_macro MAP_T3_E2]
gcode:
  SET_SPOOL_MAP T3=3

[gcode_macro MAP_T3_E3]
gcode:
  SET_SPOOL_MAP T3=4

[gcode_macro MAP_T3_E4]
gcode:
  SET_SPOOL_MAP T3=5

# --- Macros para T4 ---
[gcode_macro MAP_T4_E0]
gcode:
  SET_SPOOL_MAP T4=1

[gcode_macro MAP_T4_E1]
gcode:
  SET_SPOOL_MAP T4=2

[gcode_macro MAP_T4_E2]
gcode:
  SET_SPOOL_MAP T4=3

[gcode_macro MAP_T4_E3]
gcode:
  SET_SPOOL_MAP T4=4

[gcode_macro MAP_T4_E4]
gcode:
  SET_SPOOL_MAP T4=5
  
[gcode_macro T0]
gcode:
  {% set target = (printer["gcode_macro SET_SPOOL_MAP"].variable_T0|default(1, True) if printer["gcode_macro SET_SPOOL_MAP"] is defined else 1)|int %}
  {% set current_tool = printer["gcode_macro TOOL_STATE"].tool|int %}
  {% if current_tool == target %}
    RECARREGAR_FERRAMENTA TOOL={target}
  {% else %}
    TROCA TOOL={target}
  {% endif %}

[gcode_macro T1]
gcode:
  {% set target = (printer["gcode_macro SET_SPOOL_MAP"].variable_T1|default(2, True) if printer["gcode_macro SET_SPOOL_MAP"] is defined else 2)|int %}
  {% set current_tool = printer["gcode_macro TOOL_STATE"].tool|int %}
  {% if current_tool == target %}
    RECARREGAR_FERRAMENTA TOOL={target}
  {% else %}
    TROCA TOOL={target}
  {% endif %}

[gcode_macro T2]
gcode:
  {% set target = (printer["gcode_macro SET_SPOOL_MAP"].variable_T2|default(3, True) if printer["gcode_macro SET_SPOOL_MAP"] is defined else 3)|int %}
  {% set current_tool = printer["gcode_macro TOOL_STATE"].tool|int %}
  {% if current_tool == target %}
    RECARREGAR_FERRAMENTA TOOL={target}
  {% else %}
    TROCA TOOL={target}
  {% endif %}

[gcode_macro T3]
gcode:
  {% set target = (printer["gcode_macro SET_SPOOL_MAP"].variable_T3|default(4, True) if printer["gcode_macro SET_SPOOL_MAP"] is defined else 4)|int %}
  {% set current_tool = printer["gcode_macro TOOL_STATE"].tool|int %}
  {% if current_tool == target %}
    RECARREGAR_FERRAMENTA TOOL={target}
  {% else %}
    TROCA TOOL={target}
  {% endif %}

[gcode_macro T4]
gcode:
  {% set target = (printer["gcode_macro SET_SPOOL_MAP"].variable_T4|default(5, True) if printer["gcode_macro SET_SPOOL_MAP"] is defined else 5)|int %}
  {% set current_tool = printer["gcode_macro TOOL_STATE"].tool|int %}
  {% if current_tool == target %}
    RECARREGAR_FERRAMENTA TOOL={target}
  {% else %}
    TROCA TOOL={target}
  {% endif %}
[gcode_macro SET_SPOOL_MAP]
variable_T0: 1
variable_T1: 2
variable_T2: 3
variable_T3: 4
variable_T4: 5
gcode:
    {% for key in params %}
    SET_GCODE_VARIABLE MACRO=SET_SPOOL_MAP VARIABLE=variable_{key} VALUE={params[key]}
    {% endfor %}
    M117 Novo mapeamento aplicado


[gcode_macro TOOL_LOCK]
variable_enabled: True
gcode:
  {% if params.ACTION|default("") == "OFF" %}
    SET_GCODE_VARIABLE MACRO=TOOL_LOCK VARIABLE=enabled VALUE=False
    {% if printer["gcode_macro TOOL_DATA"].debugativo %}
      RESPOND PREFIX="INFO" MSG="Movimentos de troca de ferramenta DESATIVADOS"
    {% endif %}
  {% elif params.ACTION|default("") == "ON" %}
    SET_GCODE_VARIABLE MACRO=TOOL_LOCK VARIABLE=enabled VALUE=True
    {% if printer["gcode_macro TOOL_DATA"].debugativo %}
      RESPOND PREFIX="INFO" MSG="Movimentos de troca de ferramenta ATIVADOS"
    {% endif %}
  {% else %}
    {% if printer["gcode_macro TOOL_DATA"].debugativo %}
      RESPOND PREFIX="INFO" MSG="Uso: TOOL_LOCK ACTION=ON ou ACTION=OFF"
    {% endif %}
  {% endif %}

[gcode_macro SHOW_TOOL_STATUS]
description: Mostra o status de todas as ferramentas
gcode:
  {% set active = printer["gcode_macro TOOL_STATE"].tool|int %}
  {% for i in range(1, 5) %}
    {% if i == active %}
      {% if printer["gcode_macro TOOL_DATA"].debugativo %}
        RESPOND PREFIX="TOOL" MSG="Tool {i} ‚Üí ATIVA"
      {% endif %}
    {% else %}
      {% if printer["gcode_macro TOOL_DATA"].debugativo %}
        RESPOND PREFIX="TOOL" MSG="Tool {i} - inativa"
      {% endif %}
    {% endif %}
  {% endfor %}
  M117 Tool ativa: {active}

[gcode_macro _ATTEMPT_DISCONNECT]
gcode:
  # Sistema inteligente - usa VERIFICA_CONEXAO_TOOL ACAO=7 (sem recurs√£o)
  {% set active_tool = printer["gcode_macro TOOL_STATE"].tool|default(0)|int %}
  VERIFICA_CONEXAO_TOOL ACAO=7 TOOL={active_tool}  # 7=desconex√£o linear segura
[gcode_macro CHECK_SENSOR_NOW]
variable_present: 0          # 1 = tool carregada, 0 = sem tool
gcode:
  # For√ßa atualiza√ß√£o do sensor com delay
  G4 P200  # Delay maior para estabilizar
  QUERY_ENDSTOPS
  QUERY_ENDSTOPS
  G4 P200  # Delay maior para estabilizar
  {% set sensor_val = printer.query_endstops.last_query["manual_stepper tool_dock_stepper"] %}
  {% set ispresent = 1 if (sensor_val == 1 or sensor_val == true) else 0 %}
  SAVE_VARIABLE VARIABLE=head_sensor_now VALUE={ispresent} 
  SAVE_VARIABLE VARIABLE=head_sensor_now VALUE={ispresent}
  SET_GCODE_VARIABLE MACRO=CHECK_SENSOR_NOW VARIABLE=present VALUE={ispresent}
  RESPOND PREFIX="SENSOR" MSG="check_now={ispresent}   raw={sensor_val}"
 
 

 

 

[gcode_macro RECARREGAR_FERRAMENTA]
description: Recarrega a ferramenta atual abrindo servo a 1cm do estacionamento
gcode:

[gcode_macro RECARREGAR_FERRAMENTA_old]
gcode:
  {% set tool = params.TOOL|default(0)|int %}
  {% set homed = printer.toolhead.homed_axes %}
  {% if 'x' not in homed or 'y' not in homed %}
    {% if printer.save_variables.variables.ignore_init_tool_check|default(False) %}
      RESPOND PREFIX="WARNING" MSG="Homing bloqueado (ignore_init_tool_check ativo) ‚Äî RECARREGAR_FERRAMENTA abortada"
      PAUSE
    {% else %}
      G28
    {% endif %}
  {% endif %}
  {% set tool_y = printer["gcode_macro TOOL_DATA"].tool_y|int %}
  {% set secure_y = printer["gcode_macro TOOL_DATA"].secure_y|int %}
  {% set approach_speed = printer["gcode_macro TOOL_DATA"].approach_speed|int %}
  {% set x_pos = printer["gcode_macro TOOL_DATA"].get("dock_x" ~ tool)|float %}
  {% set approach_pre = tool_y - 10 %}  # 1cm antes do estacionamento
  {% set approach_slow = approach_speed // 10 %}
  
  {% if tool == 0 %}
    {% if printer["gcode_macro TOOL_DATA"].debugativo %}
      RESPOND PREFIX="ERROR" MSG="TOOL inv√°lida para recarregamento"
    {% endif %}
  {% else %}

  {% if printer["gcode_macro TOOL_DATA"].debugativo %}
    RESPOND PREFIX="INFO" MSG="üîÑ Recarregando ferramenta TOOL={tool} - abrindo servo a 1cm do estacionamento"
  {% endif %}
  M117 Recarregando TOOL={tool}...

  SAVE_GCODE_STATE NAME=reload_tool
  G90
  
  # Aplicar apenas offset de T0 (zero) para movimentos de troca sem mudar extrusor
  {% set x_t0 = printer["gcode_macro TOOL_DATA"].get("offset_x1")|default(0)|float %}
  {% set y_t0 = printer["gcode_macro TOOL_DATA"].get("offset_y1")|default(0)|float %}
  {% set z_t0 = 0.0 %}
  SET_GCODE_OFFSET X={x_t0} Y={y_t0} Z={z_t0}
  
  # Ir para posi√ß√£o de recarregamento (1cm antes do estacionamento)
  G1 Y200 F{printer["gcode_macro TOOL_DATA"].feedrate_troca}
  G1 X{x_pos} Y200 F{printer["gcode_macro TOOL_DATA"].feedrate_troca}
  G1 Y{approach_pre} F{approach_speed}  # Para a 1cm do estacionamento
  
  # Abrir servo para permitir reposicionamento
  ABRIR SAFE=1
  G4 P500
  
  # Avan√ßar para posi√ß√£o final e fechar
  G1 Y{tool_y} F{approach_slow}
  G4 P300
  FECHAR
  G4 P500
  
  # Retornar para posi√ß√£o segura - s√≥ se tool detectada
  VERIFICA_CONEXAO_TOOL ACAO=12 TOOL={tool}  # 12=movimento_y_seguro_sensor_detectado
  
  # Aplicar offsets da ferramenta recarregada - usando VERIFICA_CONEXAO_TOOL
  {% set tool_atual = printer["gcode_macro TOOL_STATE"].tool|default(0)|int %}
  VERIFICA_CONEXAO_TOOL ACAO=10 TOOL={tool_atual}  # 10=verifica_para_offset
  
  RESTORE_GCODE_STATE NAME=reload_tool
  {% if printer["gcode_macro TOOL_DATA"].debugativo %}
    RESPOND PREFIX="INFO" MSG="‚úÖ Ferramenta TOOL={tool} recarregada com sucesso"
  {% endif %}
  M117 TOOL={tool} recarregada
  {% endif %}

[gcode_macro DESCARREGAR]
description: Descarrega a ferramenta atual e retorna √† posi√ß√£o segura
gcode:
  {% set cur_tool = printer["gcode_macro TOOL_STATE"].tool|int %}
  {% set tool_y = printer["gcode_macro TOOL_DATA"].tool_y|int %}
  {% set approach_speed = printer["gcode_macro TOOL_DATA"].approach_speed|int %}
  {% set cur_x = printer["gcode_macro TOOL_DATA"].get("dock_x" ~ cur_tool)|int %}

  {% if cur_tool == 0 %}
    {% if printer["gcode_macro TOOL_DATA"].debugativo %}
      RESPOND PREFIX="INFO" MSG="Nenhuma ferramenta carregada"
    {% endif %}
  {% else %}

  {% if printer["gcode_macro TOOL_DATA"].debugativo %}
    RESPOND MSG="Descarregando ferramenta TOOL={cur_tool}"
  {% endif %}
  M117 Descarregando ferramenta TOOL={cur_tool}

  G90
  G1 Y200 F{printer["gcode_macro TOOL_DATA"].feedrate_troca}
  G1 X{cur_x} F{printer["gcode_macro TOOL_DATA"].feedrate_troca}
  G1 Y{tool_y} F{approach_speed}
  ABRIR SAFE=1
  G4 P300
  G91
  G1 Y-100 F{printer["gcode_macro TOOL_DATA"].feedrate_troca}
  G90
  SET_GCODE_VARIABLE MACRO=TOOL_STATE VARIABLE=tool VALUE=0
  SAVE_VARIABLE VARIABLE=tool VALUE=0
  M117 Tool descarregada
  {% endif %}

[gcode_macro FECHAR]
description: Fecha a trava da ferramenta (servo a 180¬∞)
gcode:
  SET_SERVO SERVO=tool_servo WIDTH=1  
  SET_SERVO SERVO=tool_servo ANGLE=180  
  G4 P300
  SET_SERVO SERVO=tool_servo ANGLE=150  
  G4 P500
  SET_SERVO SERVO=tool_servo ANGLE=180  
  G4 P300 
  # Remover: SET_SERVO SERVO=tool_servo WIDTH=0
  # Iniciar timer de 50 segundos para desligar o servo
 
  {% if printer["gcode_macro TOOL_DATA"].debugativo %}
    RESPOND MSG="Trava fechada (180¬∞) - Servo ser√° desligado em 50s"
  {% endif %}

[gcode_macro ABRIR]
description: Abre a trava da ferramenta (servo a 0¬∞)
gcode:
  {% set min_open_y = printer["gcode_macro TOOL_DATA"].servo_open_min_y|default(250)|int %}
  {% set cur_y = printer.toolhead.position.y|float %}
  {% set homed = printer.toolhead.homed_axes %}
  {% set safe = params.SAFE|default(0)|int %}
  {% if safe and ('y' in homed) and cur_y < min_open_y %}
    G90
    G1 Y{min_open_y} F{printer["gcode_macro TOOL_DATA"].approach_speed}
  {% endif %}
  {% set homed_y = ('y' in homed)|int %}
  RESPOND PREFIX="TRACK" MSG="ABRIR safe={safe} homed_y={homed_y} cur_y={cur_y} min_open_y={min_open_y}"
  SET_SERVO SERVO=tool_servo WIDTH=1 
  SET_SERVO SERVO=tool_servo ANGLE=0 
  G4 P820
  UPDATE_DELAYED_GCODE ID=servo_auto_off DURATION=50
  #SET_SERVO SERVO=tool_servo WIDTH=0
  {% if printer["gcode_macro TOOL_DATA"].debugativo %}
    RESPOND MSG="Trava aberta (0¬∞) - Timer de desligamento cancelado"
  {% endif %}

# Adicionar no final do arquivo
[delayed_gcode servo_auto_off]
gcode:
  SET_SERVO SERVO=tool_servo WIDTH=0
  {% if printer["gcode_macro TOOL_DATA"].debugativo %}
    RESPOND MSG="üîå Servo desligado automaticamente ap√≥s 50s"
  {% endif %}

[gcode_macro WHOAMI]
gcode:
  {% if printer["gcode_macro TOOL_DATA"].debugativo %}
    RESPOND PREFIX="DEBUG" MSG="tool={printer['gcode_macro TOOL_STATE'].tool} active_extruder={printer.toolhead.extruder}"
  {% endif %}

[gcode_macro QUAL_EXTRUSORA]
gcode:
  {% set t = printer["gcode_macro TOOL_STATE"].tool|int %}
  {% set extr = printer.toolhead.extruder %}
  RESPOND PREFIX="INFO" MSG="Tool ativa: T{t-1} extrusor={extr}"
  M117 Tool ativa: T{t-1}
 
 
  


[gcode_macro FM104]
#rename_existing: M104_BASE
gcode:
  {% set s = params.S|default(0)|float %}
  {% if 'T' in params %}
    {% set t = params.T|int %}
    {% set extr = "extruder" if t==0 else "extruder" ~ t %}
  {% else %}
    {% set extr = printer.toolhead.extruder %}
  {% endif %}
  {% if printer["gcode_macro TOOL_DATA"].debugativo %}
    RESPOND PREFIX="DEBUG" MSG="M104 -> {extr}  S={s}"
  {% endif %}
  SET_HEATER_TEMPERATURE HEATER={extr} TARGET={s}


[gcode_macro FM109]
#rename_existing: M109_BASE
gcode:
  {% set s = params.S|default(0)|float %}
  {% if 'T' in params %}
    {% set t = params.T|int %}
    {% set extr = "extruder" if t==0 else "extruder" ~ t %}
  {% else %}
    {% set extr = printer.toolhead.extruder %}
  {% endif %}
  {% if printer["gcode_macro TOOL_DATA"].debugativo %}
    RESPOND PREFIX="DEBUG" MSG="M109 -> {extr}  S={s}"
  {% endif %}
  SET_HEATER_TEMPERATURE HEATER={extr} TARGET={s}
  TEMPERATURE_WAIT SENSOR={extr} MINIMUM={s-1} MAXIMUM={s+5}


[gcode_macro DEBUG_ATIVO]
description: Ativa ou desativa as mensagens de debug
gcode:
  {% if params.ACAO|default("") == "ON" %}
    SET_GCODE_VARIABLE MACRO=TOOL_DATA VARIABLE=debugativo VALUE=True
    RESPOND PREFIX="INFO" MSG="üîß Debug ATIVADO - mensagens ser√£o exibidas"
  {% elif params.ACAO|default("") == "OFF" %}
    SET_GCODE_VARIABLE MACRO=TOOL_DATA VARIABLE=debugativo VALUE=False
    RESPOND PREFIX="INFO" MSG="üîá Debug DESATIVADO - mensagens ocultadas"
  {% else %}
    {% set status = "ATIVO" if printer["gcode_macro TOOL_DATA"].debugativo else "INATIVO" %}
    RESPOND PREFIX="INFO" MSG="Debug est√° {status}. Use: DEBUG_ATIVO ACAO=ON ou ACAO=OFF"
  {% endif %}

#[include global_probe_config.cfg]  # CONFIGURA√á√ïES GLOBAIS DE COORDENADAS
#[include calibracao_probe_automatica.cfg]  # SISTEMA DE CALIBRA√á√ÉO AUTOM√ÅTICA COM PROBE
[gcode_macro VERIFICAR_FERRAMENTA]
description: Verifica se a ferramenta ainda est√° acoplada durante a impress√£o
gcode:
  {% set current_tool = printer["gcode_macro TOOL_STATE"].tool|int %}
  {% if current_tool > 0 %}
    {% if printer["gcode_macro TOOL_STATE"].switch_present %}
      RESPOND PREFIX="INFO" MSG="‚úÖ Ferramenta T{current_tool} OK"
    {% else %}
      RESPOND PREFIX="ERROR" MSG="‚ùå FERRAMENTA PERDIDA!"
      M117 ERRO: Ferramenta perdida!
      G90
      VERIFICA_CONEXAO_TOOL ACAO=11 TOOL=0  # 11=movimento_y_seguro_condicional (sem tool)
      PAUSE
    {% endif %}
  {% else %}
    RESPOND PREFIX="DEBUG" MSG="üîç Nenhuma ferramenta ativa - verifica√ß√£o ignorada"
  {% endif %}

[gcode_macro VERIFICACAO_AUTOMATICA]
description: Ativa verifica√ß√£o autom√°tica da ferramenta a cada 15 segundos
gcode:
  RESPOND PREFIX="INFO" MSG="Verifica√ß√£o autom√°tica desativada"

[delayed_gcode check_tool_timer]
gcode:
  G4 P0

#[include global_probe_config.cfg]  # CONFIGURA√á√ïES GLOBAIS DE COORDENADAS

[gcode_macro DESCONECTA]
gcode:
  {% set next = params.NEXT_TOOL|default(0)|int %}
  {% set tool_y = printer["gcode_macro TOOL_DATA"].tool_y|int %}
  {% set secure_y = printer["gcode_macro TOOL_DATA"].secure_y|int %}
  {% set approach_speed = printer["gcode_macro TOOL_DATA"].approach_speed|int %}
  {% set approach_slow = approach_speed // 10 %}
  {% set active_tool = printer["gcode_macro TOOL_STATE"].tool|int %}
  {% set extruders = {1: "extruder", 2: "extruder1", 3: "extruder2", 4: "extruder3", 5: "extruder4"} %}
  # Estrutura inteligente - usando VERIFICA_CONEXAO_TOOL
  VERIFICA_CONEXAO_TOOL ACAO=2 TOOL={active_tool}  # 2=desconecta
  {% set cur_tool = active_tool if active_tool > 0 else printer.save_variables.variables.last_tool|default(0)|int %}
  {% if cur_tool != 0 or sensor_present == 1 %}
    SAVE_VARIABLE VARIABLE=last_tool VALUE={cur_tool}
    {% set cur_x = printer["gcode_macro TOOL_DATA"].get("dock_x" ~ active_tool)|float %}
    {% if cur_tool <= 5 %}
      {% set extruder_name = extruders[cur_tool] %}
      {% set atual = printer[extruder_name].temperature|float %}
      {% if not printer["gcode_macro TROCA"].skip_filamento|default(False) and atual >= 0 %}
        G91
        G1 E-5 F4000
        G90
      {% endif %}
    {% endif %}
    G1 Y200 F{printer["gcode_macro TOOL_DATA"].feedrate_troca}
    G1 X{cur_x} Y200 F{printer["gcode_macro TOOL_DATA"].feedrate_troca}
    {% set approach_pre = tool_y - 10 %}
    G1 Y{approach_pre} F{approach_speed}
    _ATTEMPT_DISCONNECT
    # Sistema inteligente - verifica falha de desconex√£o (a√ß√£o 6)
    VERIFICA_CONEXAO_TOOL ACAO=6 TOOL={active_tool}  # 6=verifica_falha_desconexao
  {% else %}
    # Movimento Y seguro CONDICIONAL - s√≥ se sensor estiver fechado
    VERIFICA_CONEXAO_TOOL ACAO=11 TOOL={active_tool}  # 11=movimento_y_seguro_condicional
  {% endif %}


# ============================================================
# Macro DT1 - Descarrega TOOL espec√≠fica independentemente da tool atual
# ============================================================
[gcode_macro DT1]
gcode:
  {% set tool = params.TOOL|default(1)|int %}  # Tool padr√£o = 1, mas pode ser informada
  {% set tool_y = printer["gcode_macro TOOL_DATA"].tool_y|int %}
  {% set secure_y = printer["gcode_macro TOOL_DATA"].secure_y|int %}
  {% set approach_speed = printer["gcode_macro TOOL_DATA"].approach_speed|int %}
  
  RESPOND PREFIX="DT1" MSG="Descarregando TOOL {tool}... (independente da mem√≥ria)"
  
  # Move para posi√ß√£o segura
  G1 Y200 F{printer["gcode_macro TOOL_DATA"].feedrate_troca}
  
  # Move para posi√ß√£o X da tool especificada (dock_x1, dock_x2, etc)
  {% set tool_x = printer["gcode_macro TOOL_DATA"].get("dock_x" ~ tool)|float %}
  G1 X{tool_x} Y200 F{printer["gcode_macro TOOL_DATA"].feedrate_troca}
  
  # Aproxima√ß√£o
  {% set approach_pre = tool_y - 10 %}
  G1 Y{approach_pre} F{approach_speed}
  G1 Y{tool_y} F{approach_speed // 10}
  ABRIR
 
  # Move para posi√ß√£o segura - s√≥ se sem tool (sensor fechado)
  VERIFICA_CONEXAO_TOOL ACAO=11 TOOL={tool}  # 11=movimento_y_seguro_condicional (sem tool)
  
  {% set sensor_final = printer.query_endstops.last_query['manual_stepper tool_dock_stepper'] %}
  {% set present_final = 1 if (sensor_final == 1 or sensor_final == true or sensor_final|string == 'TRIGGERED') else 0 %}
  {% if present_final == 0 %}
    RESPOND PREFIX="DT1" MSG="‚úì TOOL {tool} descarregada com sucesso"
  {% else %}
    RESPOND PREFIX="DT1" MSG="‚ö† TOOL {tool} ainda detectada (verificar mecanismo)"
  {% endif %}
  {% set secure_y = printer["gcode_macro TOOL_DATA"].secure_y|int %}
   G1 Y{secure_y} F{approach_speed // 10}


[delayed_gcode PROCESS]
gcode:
 G4 P100



# ============================================================
# Macro CONECTA - agora usa apenas a vari√°vel da HEAD_ENDSTOP_STATUS
# ============================================================
[gcode_macro CONECTA]
gcode:
  {% set tool = params.TOOL|default(0)|int %}
  {% set tool_y = printer["gcode_macro TOOL_DATA"].tool_y|int %}
  {% set secure_y = printer["gcode_macro TOOL_DATA"].secure_y|int %}
  {% set approach_speed = printer["gcode_macro TOOL_DATA"].approach_speed|int %}
  {% set approach_slow = approach_speed // 10 %}
  {% set x_pos = printer["gcode_macro TOOL_DATA"].get("dock_x" ~ tool)|float %}
  {% set extruders = {1: "extruder", 2: "extruder1", 3: "extruder2", 4: "extruder3", 5: "extruder4"} %}

  RESPOND PREFIX="TRACK" MSG="CONECTA start tool={tool} x_pos={x_pos} tool_y={tool_y} secure_y={secure_y}"

  G90
  # Verifica estado inicial - usando c√≥digo num√©rico para evitar erro de literal
  
  #SET_GCODE_VARIABLE MACRO=VERIFICA_CONEXAO_TOOL VARIABLE=acao VALUE=4  # 4=conectou
  VERIFICA_CONEXAO_TOOL ACAO=4 TOOL={tool} # J√° setamos a vari√°vel acao internamente
  MOVE_EXTRUDER EXTRUDER={tool-1}
     

  G1 X{x_pos} F{printer["gcode_macro TOOL_DATA"].feedrate_troca}
  #G4 P300

  # Sequ√™ncia de acoplamento
  G1 Y{tool_y - 10} F{approach_speed}
  ABRIR SAFE=1
  #G4 P300
  G1 Y{tool_y} F{approach_slow}
  G4 P300
  FECHAR
  M400
  G4 P100  # Tempo para o mecanismo e switch estabilizarem
  #SET_GCODE_VARIABLE MACRO=VERIFICA_CONEXAO_TOOL VARIABLE=acao VALUE=1  # 1=conecta
  G1 Y{tool_y - 10} F{approach_slow}
  G1 Y{tool_y - 5} F{approach_slow}
  VERIFICA_CONEXAO_TOOL ACAO=1 TOOL={tool}


[gcode_macro EXECUTA_ACOES]
variable_endstop_x: 0
# 1=conecta, 2=desconecta, 3=verifica, 4=conectou, 5=pula_y_seguro, 6=verifica_falha_desconexao, 7=tentativa_desconexao_completa, 8=leitura_sensor_atualizada, 10=verifica_para_offset
gcode:
  # --- ler ENDSTOP_X / SENSOR (params t√™m prioridade; aceita v√°rios nomes)
  {% set end_param = params.get('ENDSTOP_X') or params.get('endstop_x') or params.get('SENSOR') %}
  {% if end_param is not none %}
    {% set endstop_x = end_param|int %}
  {% else %}
    {% set stored = printer['gcode_macro EXECUTA_ACOES'].endstop_x|default(None) %}
    {% if stored is not none %}
      {% set endstop_x = stored|int %}
    {% else %}
      {% set endstop_x = 0 %}
    {% endif %}
  {% endif %}

  # --- ler ACAO (params t√™m prioridade)
  {% set acao_param = params.get('ACAO') or params.get('acao') %}
  {% if acao_param is not none %}
    {% set acao_num = acao_param|int %}
  {% else %}
    {% set acao_num = printer['gcode_macro EXECUTA_ACOES'].acao|default('0')|int %}
  {% endif %}

  # --- ler TOOL (params t√™m prioridade)
  {% set tool_param = params.get('TOOL') or params.get('tool') %}
  {% if tool_param is not none %}
    {% set tool = tool_param|int %}
  {% else %}
    {% set tool = printer['gcode_macro EXECUTA_ACOES'].tool|default('0')|int %}
  {% endif %}


  {% set tool_y = printer["gcode_macro TOOL_DATA"].tool_y|default(0)|int %}
  {% set secure_y = printer["gcode_macro TOOL_DATA"].secure_y|default(0)|int %}
  {% set approach_speed = printer["gcode_macro TOOL_DATA"].approach_speed|default(3000)|int %}
  {% set approach_slow = (approach_speed // 10) %}
  {% set x_pos = printer["gcode_macro TOOL_DATA"].get("dock_x" ~ tool)|default(0)|float %}
  {% set extruders = {1: "extruder", 2: "extruder1", 3: "extruder2", 4: "extruder3", 5: "extruder4"} %}

  # --- TOOL_DATA (valores padr√£o para evitar erro se n√£o definidos)

  RESPOND MSG="DEBUG: acao={acao_num} sensor={endstop_x} tool={tool} x_pos={x_pos}"

  {% if acao_num == 1 %}  # conecta
    {% if endstop_x == 1 %}
      RESPOND MSG="A√ß√£o CONECTA: sensor detectado - SUCESSO"
      SET_GCODE_VARIABLE MACRO=TOOL_STATE VARIABLE=switch_present VALUE=1
      SET_GCODE_VARIABLE MACRO=TOOL_STATE VARIABLE=tool VALUE={tool}
      SAVE_VARIABLE VARIABLE=tool VALUE={tool}
      {% set extruder_name = extruders.get(tool) %}
      {% if extruder_name is defined and extruder_name != none and printer[extruder_name] is defined %}
        ACTIVATE_EXTRUDER EXTRUDER={extruder_name}
        SYNC_EXTRUDER_MOTION EXTRUDER=belted_extruder MOTION_QUEUE={extruder_name}
        SET_PRESSURE_ADVANCE EXTRUDER=belted_extruder ADVANCE={printer["extruder_stepper belted_extruder"].pressure_advance}
      {% endif %}
      G90
      G1 Y200 F2000
      RESPOND PREFIX="INFO" MSG="Tool {tool} acoplada com sucesso!"
      {% if endstop_x == 1 %}
        G1 Y{secure_y} F{approach_speed}
      {% endif %}
      APPLY_TOOL_OFFSET
      G4 P300
      G1 F20000 Y200
      G12
    {% else %}
      RESPOND PREFIX="ERROR" MSG="A√ß√£o CONECTA: sensor n√£o detectado - FALHA"
      SET_GCODE_VARIABLE MACRO=TOOL_STATE VARIABLE=switch_present VALUE=0
      SET_GCODE_VARIABLE MACRO=TOOL_STATE VARIABLE=tool VALUE=0
      SAVE_VARIABLE VARIABLE=tool VALUE=0
      M117 ERRO: Troca falhou
      G90
      #{% if endstop_x == 1 %}
        G1 Y{secure_y} F{approach_speed}
      #{% endif %}
      PAUSE
    {% endif %}

  {% elif acao_num == 2 %}  # desconecta
    {% if endstop_x == 0 %}
      RESPOND PREFIX="INFO" MSG="A√ß√£o DESCONECTA: sensor n√£o detectado - SUCESSO"
      SET_GCODE_VARIABLE MACRO=TOOL_STATE VARIABLE=switch_present VALUE=0
      SET_GCODE_VARIABLE MACRO=TOOL_STATE VARIABLE=tool VALUE=0
      SAVE_VARIABLE VARIABLE=tool VALUE=0
      G90
     # 
      RESPOND PREFIX="INFO" MSG="Tool descarregada - movendo para posi√ß√£o segura"
    {% else %}
      {% if endstop_x == 1 %}
        G1 Y{secure_y} F{approach_speed}
      {% endif %}
      RESPOND PREFIX="WARNING" MSG="A√ß√£o DESCONECTA: sensor detectado - FALHA"
      RESPOND PREFIX="WARNING" MSG="Tool ainda detectada ap√≥s tentativa de descarga"
    {% endif %}

  {% elif acao_num == 3 %}  # verifica
    {% if endstop_x == 1 %}
      RESPOND MSG="A√ß√£o VERIFICA: sensor detectado - TOOL PRESENTE"
    {% else %}
      RESPOND MSG="A√ß√£o VERIFICA: sensor n√£o detectado - TOOL AUSENTE"
    {% endif %}

  {% elif acao_num == 4 %}  # conectou
    {% if endstop_x == 1 %}
      RESPOND MSG="A√ß√£o CONECTOU: sensor detectado"
    {% else %}
      M117 ERRO: Conex√£o falhou
    {% endif %}

  {% elif acao_num == 5 %}  # 5=pula_y_seguro - apenas movimento Y seguro
    {% if endstop_x == 0 %}
      {% if endstop_x == 1 %}
        G1 Y{secure_y} F{approach_speed}
      {% endif %}
      RESPOND MSG="A√ß√£o PULA_Y_SEGURO: Y seguro alcan√ßado (sensor ausente)"
    {% else %}
      RESPOND MSG="A√ß√£o PULA_Y_SEGURO: sensor detectado - pulando Y seguro"
      {% if endstop_x == 1 %}
        G1 Y{secure_y} F{approach_speed}
      {% endif %}
    {% endif %}

  {% elif acao_num == 6 %}  # 6=verifica_falha_desconexao - verifica se tool ainda est√° conectada
    {% if endstop_x == 1 %}
      RESPOND PREFIX="ERROR" MSG="üö® FALHA DETECTADA: Tool ainda conectada ap√≥s desconex√£o!"
      M117 ERRO: DESCONEX√ÉO FALHOU!
      # N√£o move - exige interven√ß√£o manual
    {% else %}
      RESPOND PREFIX="INFO" MSG="‚úÖ Desconex√£o verificada: Tool removida com sucesso"
      {% if endstop_x == 1 %}
        G1 Y{secure_y} F{approach_speed}
      {% endif %}
      RESPOND PREFIX="INFO" MSG="Posi√ß√£o segura alcan√ßada"
    {% endif %}

  {% elif acao_num == 7 %}  # 7=tentativa_desconexao_completa - SEM recurs√£o
    {% set tool_y = printer["gcode_macro TOOL_DATA"].tool_y|default(0)|int %}
    {% set approach_speed = printer["gcode_macro TOOL_DATA"].approach_speed|default(3000)|int %}
    {% set approach_slow = (approach_speed // 10) %}
    RESPOND PREFIX="INFO" MSG="Desconex√£o linear: sensor inicial={endstop_x}"
    ABRIR SAFE=1
    G4 P300
    G1 Y{tool_y} F{approach_slow}
    G91
    G1 Y-15 F2000
    G90
    M400
    G4 P300

    # Atualiza endstops antes de ler o estado final
    QUERY_ENDSTOPS
    G4 P200
    {% set sensor_final_raw = printer.query_endstops.last_query.get('manual_stepper tool_dock_stepper') if printer.query_endstops.last_query is defined else 'open' %}
    {% set sensor_final_str = sensor_final_raw|string %}
    {% set sensor_final_num = 1 if sensor_final_str|lower in ['triggered','true','1'] else 0 %}
    RESPOND PREFIX="TRACK" MSG="DESCONNECT linear final sensor={sensor_final_num} raw={sensor_final_raw} pos=({printer.toolhead.position.x},{printer.toolhead.position.y})"

    {% if sensor_final_num == 0 %}
      RESPOND PREFIX="INFO" MSG="‚úÖ Desconex√£o linear bem-sucedida"
      SET_GCODE_VARIABLE MACRO=TOOL_STATE VARIABLE=switch_present VALUE=0
      SET_GCODE_VARIABLE MACRO=TOOL_STATE VARIABLE=tool VALUE=0
      SAVE_VARIABLE VARIABLE=tool VALUE=0
    {% else %}
      RESPOND PREFIX="WARNING" MSG="‚ö†Ô∏è Tool ainda detectada ap√≥s recuo linear - Verificar mecanismo!"
      SET_GCODE_VARIABLE MACRO=TOOL_STATE VARIABLE=switch_present VALUE=1
    {% endif %}

  {% elif acao_num == 8 %}  # 8=leitura_sensor_atualizada - SEM recurs√£o, leitura direta
    # Atualiza cache e espera curto para garantir leitura atualizada
    QUERY_ENDSTOPS
    G4 P200
    {% set sensor_novo_raw = printer.query_endstops.last_query.get('manual_stepper tool_dock_stepper') if printer.query_endstops.last_query is defined else 'open' %}
    {% set sensor_novo_str = sensor_novo_raw|string %}
    {% set sensor_novo_num = 1 if sensor_novo_str|lower in ['triggered','true','1'] else 0 %}
    RESPOND PREFIX="TRACK" MSG="SENSOR ATUALIZADO: raw={sensor_novo_raw} num={sensor_novo_num}"

  {% elif acao_num == 10 %}  # 10=verifica_para_offset - verifica sensor antes de aplicar offset
    {% if endstop_x == 1 %}
      RESPOND PREFIX="INFO" MSG="‚úÖ Sensor confirma ferramenta - Aplicando offset"
      APPLY_TOOL_OFFSET
    {% else %}
      RESPOND PREFIX="WARNING" MSG="‚ö†Ô∏è Offset n√£o aplicado: sensor n√£o confirma ferramenta"
      M117 AVISO: OFFSET BLOQUEADO
    {% endif %}

  {% elif acao_num == 11 %}  # 11=movimento_y_seguro_condicional - s√≥ move se sensor fechado
    {% if endstop_x == 0 %}
      
      RESPOND PREFIX="INFO" MSG="‚úÖ Movimento Y seguro executado (sensor fechado)"
    {% else %}
      {% if endstop_x == 1 %}
        G1 Y{secure_y} F{approach_speed}
      {% endif %}
      RESPOND PREFIX="WARNING" MSG="‚ö†Ô∏è Movimento Y bloqueado: sensor detecta tool!"
      M117 AVISO: MOVIMENTO BLOQUEADO
    {% endif %}
  
  {% elif acao_num == 12 %}  # 12=movimento_y_seguro_sensor_detectado - s√≥ move se sensor detectar tool
    {% if endstop_x == 1 %}
      {% if endstop_x == 1 %}
        G1 Y{secure_y} F{approach_speed}
      {% endif %}
      RESPOND PREFIX="INFO" MSG="‚úÖ Movimento Y seguro executado (tool detectada)"
    {% else %}
      RESPOND PREFIX="WARNING" MSG="‚ö†Ô∏è Tool n√£o detectada - movimento Y seguro bloqueado!"
      M117 AVISO: TOOL AUSENTE
    {% endif %}
  
  {% else %}
    RESPOND MSG="A√ß√£o {acao_num} n√£o reconhecida (sensor={endstop_x})"
  {% endif %}

[gcode_macro QUERY_ENDSTOPS_ONLY]
gcode:
  QUERY_ENDSTOPS

[gcode_macro SHOW_LAST_QUERY]
gcode:
  RESPOND MSG="RAW last_query: {printer.query_endstops.last_query}"
  RESPOND MSG="Endstop tool_dock_stepper = {printer.query_endstops.last_query['manual_stepper tool_dock_stepper']}"

[gcode_macro QUERYENDSTOPS]
gcode:
  QUERY_ENDSTOPS
  QUERY_ENDSTOPS

[gcode_macro UPDATE_ENDSTOPS]
gcode:
  {% set acao = params.get('ACAO','0')|string %}
  {% set tool = params.get('TOOL','0')|string %}
  QUERYENDSTOPS
  {% set sensor_raw = printer.query_endstops.last_query['manual_stepper tool_dock_stepper'] %}
  {% set sensor = 1 if (sensor_raw == 1 or sensor_raw == true or sensor_raw|string == 'TRIGGERED') else 0 %}
  RESPOND PREFIX="TRACK" MSG="UPDATE_ENDSTOPS raw={sensor_raw} sensor={sensor}"

[gcode_macro READ_ENDSTOP_VAR_VCT]
gcode:
  {% set acao_param = params.get('ACAO','0')|string %}
  {% set tool_param = params.get('TOOL','0')|string %}
  {% set raw = printer.query_endstops.last_query.get('manual_stepper tool_dock_stepper') if printer.query_endstops.last_query is defined else 'open' %}
  {% set raw_str = raw|string %}
  {% set endstop_val = 1 if raw_str in ['triggered','TRIGGERED','true','True','1'] else 0 %}
  RESPOND MSG="READ_ENDSTOP_VAR_VCT: raw={raw_str} mapped={endstop_val} ACAO={acao_param} TOOL={tool_param}"
  EXECUTA_ACOES ACAO={acao_param} ENDSTOP_X={endstop_val} TOOL={tool_param}

[gcode_macro VERIFICA_CONEXAO_TOOL]
gcode:
  # recebe ACAO e TOOL (opcional) ao ser chamado
  {% set acao = params.get('ACAO','0')|string %}
  {% set tool = params.get('TOOL','0')|string %}
  RESPOND MSG="VERIFICA_CONEXAO_TOOL chamado: ACAO={acao} TOOL={tool}"
  # 1) solicita leitura dos endstops (separado)
  QUERY_ENDSTOPS_ONLY
  G4 P200
  # Exibir conte√∫do lido
  {% set raw = printer.query_endstops.last_query.get('manual_stepper tool_dock_stepper') if printer.query_endstops.last_query is defined else 'open' %}
  {% set raw_str = raw|string %}
  {% set sensor = 1 if raw_str in ['triggered','TRIGGERED','true','True','1'] else 0 %}
  RESPOND PREFIX="TRACK" MSG="VERIFICA_CONEXAO_TOOL raw={raw_str} sensor={sensor}"
  # 2) chama a macro que mapeia e encaminha via params
  READ_ENDSTOP_VAR_VCT ACAO={acao} TOOL={tool}


[gcode_macro QUERY_ENDSTOPS_ONLY]
gcode:
  QUERY_ENDSTOPS

[gcode_macro SHOW_LAST_QUERY]
gcode:
  RESPOND MSG="RAW last_query: {printer.query_endstops.last_query}"
  RESPOND MSG="Endstop tool_dock_stepper = {printer.query_endstops.last_query['manual_stepper tool_dock_stepper']}"



