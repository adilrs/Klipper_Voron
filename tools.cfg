#Se quiser ainda um m√≠nimo (por exemplo, nunca descer abaixo de 150¬∞C), defina:
#- SET_GCODE_VARIABLE MACRO=TROCA VARIABLE=min_standby VALUE=150

[gcode_macro TOOL_DATA]
variable_debugativo: False
variable_z_antes: 0.0
# üìç Posi√ß√µes f√≠sicas no dock
variable_dock_x1: 10.0
variable_dock_x2: 90.0
variable_dock_x3: 169.0
variable_dock_x4: 249.0

variable_standby_temp_T1: 170
variable_standby_temp_T2: 170
variable_standby_temp_T3: 170
variable_standby_temp_T4: 170

# üõ†Ô∏è Offsets da ferramenta T0~T3 (apenas X/Y - Z lido diretamente de variables.cfg)
#  T0   AMARELO (refer√™ncia BLTouch)
variable_offset_x1: 0 #@-0.1 #0.1 #0.0
variable_offset_y1: 0 #-0.1 #0.1  #0.0

#  T1 BRANCO - X/Y fixos calibrados manualmente
variable_offset_x2: 0.60 #0.2  #0.1 # Valor fixo calibrado manualmente
variable_offset_y2: -1.50 #-0.8  #-1.0 #1.1 # -0.3   # Valor fixo calibrado manualmente

#  T2 ROXO - X/Y fixos calibrados manualmente
variable_offset_x3: 1.0 #0.9 #0.8 # Valor fixo calibrado manualmente
variable_offset_y3: -1.0 #-1.8  #-1.1 #0.0  #0.1   # Valor fixo calibrado manualmente
#  T3 - X/Y iniciais para calibra√ß√£o posterior
variable_offset_x4: 0 #0.1
variable_offset_y4: 0 #@0.1
### üéØ Resumo Pr√°tico
#Com os valores atuais offset_x3: 0.2 e offset_y3: 0.5 , a ferramenta T2 est√° sendo compensada:
#- 0.2mm para a direita (eixo X)
#- 0.5mm para frente (eixo Y)
#X POSITIVO MOVE PRA DIREITA
#Y POSITIVO MOVE PARA CIMA


# offset_z4 removido - Z lido diretamente de variables.cfg como tool_2_offset_z

# üß† Dados auxiliares
variable_tool_y: 280 #278  # Posi√ß√£o necess√°ria para travamento magn√©tico das ferramentas
variable_secure_y: 200
variable_approach_speed: 10000

gcode:
  {% if printer["gcode_macro TOOL_DATA"].debugativo %}
    RESPOND MSG="TOOL_DATA carregada"
  {% endif %}


  
 
[gcode_macro G12]
gcode:
  ; comandos de limpeza aqui
  #CLEAN_NOZZLE_T0

[gcode_macro CLEAN_NOZZLE_T0]
description: "Limpeza do bico usando offset correto da ferramenta ativa"
gcode:
  {% set start_x = printer.toolhead.position.x|default(0) %}
  {% set start_y = printer.toolhead.position.y|default(0) %}
  {% set start_z = printer.toolhead.position.z|default(5) %}
  {% set active_tool = printer.toolhead.extruder %}
  {% set temp = printer[active_tool].temperature|float %}
  {% if temp >= 170 %}
  #{% if printer.extruder.temperature|float >= 170 %}

     SET_SERVO SERVO=tool_servo WIDTH=1  
    ; üîß CORRE√á√ÉO: T0 deve ter offset ZERO (√© a refer√™ncia com BLTouch)
    ; T0 = ferramenta f√≠sica 1, mas offset deve ser 0,0,0 (refer√™ncia)
    {% set current_tool = printer["gcode_macro TOOL_STATE"].tool|int %}
    {% set vars = printer.save_variables.variables %}
    {% if current_tool == 1 %}
        ; T0 (ferramenta f√≠sica 1) = offset ZERO (refer√™ncia BLTouch)
        {% set x = 0.0 %}
        {% set y = 0.0 %}
        {% set z = 0.0 %}
        {% if printer["gcode_macro TOOL_DATA"].debugativo %}
            RESPOND PREFIX="INFO" MSG="T0 (refer√™ncia): Offset ZERO aplicado X={x} Y={y} Z={z}"
          {% endif %}
    {% elif current_tool == 2 %}
        ; T1 - X/Y fixos do TOOL_DATA, Z direto do variables.cfg
        {% set x = printer["gcode_macro TOOL_DATA"].get("offset_x2")|default(0)|float %}
        {% set y = printer["gcode_macro TOOL_DATA"].get("offset_y2")|default(0)|float %}
        {% set z = vars.get('tool_0_offset_z', 0.0)|float %}
        {% if printer["gcode_macro TOOL_DATA"].debugativo %}
            RESPOND PREFIX="INFO" MSG="T1: Offset aplicado X={x} Y={y} Z={z} (Z direto de variables.cfg)"
          {% endif %}
    {% elif current_tool == 3 %}
        ; T2 - X/Y fixos do TOOL_DATA, Z direto do variables.cfg
        {% set x = printer["gcode_macro TOOL_DATA"].get("offset_x3")|default(0)|float %}
        {% set y = printer["gcode_macro TOOL_DATA"].get("offset_y3")|default(0)|float %}
        {% set z = vars.get('tool_1_offset_z', 0.0)|float %}
        {% if printer["gcode_macro TOOL_DATA"].debugativo %}
            RESPOND PREFIX="INFO" MSG="T2: Offset aplicado X={x} Y={y} Z={z} (Z direto de variables.cfg)"
          {% endif %}
    {% else %}
        ; Fallback para outras ferramentas
        {% set x = printer["gcode_macro TOOL_DATA"].get("offset_x" ~ current_tool)|default(0)|float %}
        {% set y = printer["gcode_macro TOOL_DATA"].get("offset_y" ~ current_tool)|default(0)|float %}
        {% set z = vars.get('tool_' ~ (current_tool - 1) ~ '_offset_z', 0.0)|float %}
        {% if printer["gcode_macro TOOL_DATA"].debugativo %}
          RESPOND PREFIX="INFO" MSG="T{current_tool}: Offset aplicado X={x} Y={y} Z={z} (Z direto de variables.cfg)"
        {% endif %}
    {% endif %}
    SET_GCODE_OFFSET X={x} Y={y} Z={z} MOVE=1
  
  
  
    ; Aproxima pela rota segura com Y ‚â§ 200
    G90 
    G1 X235 Y200 F10000
    G1 X280 Y260 F10000
    G1 x315 Y251 F10000
    G91
    #G1 E15 F3000
    G4 P1000
    G90
    ; Posi√ß√£o de limpeza
    G1 x315 Y223 F10000
    
    ; Sequ√™ncia de limpeza
    G91
    #G1 E5 F3000
    G1 Y-12 F3000
    G4 P1000
    G1 Y12 F3000
    G90
    
    ; Retorno via rota segura
    G1 x315 Y200 F10000
    G1  Y{start_y} F10000 #X{start_x}
    G1 Z{start_z} F6000
    
    ; Aplica offset da ferramenta ativa
    APPLY_TOOL_OFFSET
    
    ; Restaura velocidade de impress√£o padr√£o
    G1 F{printer.configfile.settings.printer.max_velocity * 60}
  {% else %}
    {% if printer["gcode_macro TOOL_DATA"].debugativo %}
      RESPOND PREFIX="WARN" MSG="‚ùå Temperatura do extrusor est√° abaixo de 170 ¬∞C. Macro abortado."
    {% endif %}
  
  {% endif %}

   SET_SERVO SERVO=tool_servo WIDTH=0
  


  

#[gcode_macro TOOL_STATE]
#variable_tool: 0
#gcode:
#  {% set saved_tool = printer.save_variables.variables.tool|default(0)|int %}
#  SET_GCODE_VARIABLE MACRO=TOOL_STATE VARIABLE=tool VALUE={saved_tool}
#  RESPOND PREFIX="DEBUG" MSG="TOOL_STATE restaurado: Tool {saved_tool}"
#  M117 TOOL_STATE restaurado: Tool {saved_tool}
[gcode_macro TOOL_STATE]
variable_tool: 1
gcode:
  {% set saved_tool = printer.save_variables.variables.tool|default(1)|int %}
  SET_GCODE_VARIABLE MACRO=TOOL_STATE VARIABLE=tool VALUE={saved_tool}
  {% set show_t = saved_tool - 1 %}  # s√≥ para exibir T0..T3
  {% if printer["gcode_macro TOOL_DATA"].debugativo %}
    RESPOND PREFIX="DEBUG" MSG="TOOL_STATE restaurado: T{show_t}"
  {% endif %}
  M117 TOOL_STATE restaurado: T{show_t}

# [gcode_macro SET_GCODE_OFFSET] - INTERCEPTA√á√ÉO DESATIVADA
# rename_existing: SET_GCODE_OFFSET_BASE
# gcode:
#   RESPOND PREFIX="DEBUG" MSG="Interceptado: SET_GCODE_OFFSET Z={params.Z|default('')} X={params.X|default('')} Y={params.Y|default('')}"
#   SET_GCODE_OFFSET_BASE {rawparams}

[gcode_macro APPLY_TOOL_OFFSET]
gcode:
  {% set tool = printer["gcode_macro TOOL_STATE"].tool|int %}
  {% set vars = printer.save_variables.variables %}
  
  ; üîß CORRE√á√ÉO: T0 (tool=1) deve ter offset ZERO (refer√™ncia BLTouch)
  {% if tool == 1 %}
    ; T0 = ferramenta f√≠sica 1, mas √© a refer√™ncia (offset zero)
    {% set x = 0.0 %}
    {% set y = 0.0 %}
    {% set z = 0.0 %}
    RESPOND PREFIX="INFO" MSG="T0 (refer√™ncia): Offset ZERO aplicado X={x} Y={y} Z={z}"
  {% elif tool == 2 %}
    ; T1 - X/Y fixos do TOOL_DATA, Z direto do variables.cfg
    {% set x = printer["gcode_macro TOOL_DATA"].get("offset_x2")|default(0)|float %}
    {% set y = printer["gcode_macro TOOL_DATA"].get("offset_y2")|default(0)|float %}
    {% set z = vars.get('tool_0_offset_z', 0.0)|float %}
    RESPOND PREFIX="INFO" MSG="T1: Offset aplicado X={x} Y={y} Z={z} (Z direto de variables.cfg)"
  {% elif tool == 3 %}
    ; T2 - X/Y fixos do TOOL_DATA, Z direto do variables.cfg
    {% set x = printer["gcode_macro TOOL_DATA"].get("offset_x3")|default(0)|float %}
    {% set y = printer["gcode_macro TOOL_DATA"].get("offset_y3")|default(0)|float %}
    {% set z = vars.get('tool_1_offset_z', 0.0)|float %}
    RESPOND PREFIX="INFO" MSG="T2: Offset aplicado X={x} Y={y} Z={z} (Z direto de variables.cfg)"
  {% elif tool == 4 %}
    ; T3 - X/Y fixos do TOOL_DATA, Z direto do variables.cfg
    {% set x = printer["gcode_macro TOOL_DATA"].get("offset_x4")|default(0)|float %}
    {% set y = printer["gcode_macro TOOL_DATA"].get("offset_y4")|default(0)|float %}
    {% set z = vars.get('tool_2_offset_z', 0.0)|float %}
    {% if printer["gcode_macro TOOL_DATA"].debugativo %}
       RESPOND PREFIX="INFO" MSG="T3: Offset aplicado X={x} Y={y} Z={z} (Z direto de variables.cfg)"
     {% endif %}
  {% else %}
    ; Fallback para outras ferramentas
    {% set x = printer["gcode_macro TOOL_DATA"].get("offset_x" ~ tool)|default(0)|float %}
    {% set y = printer["gcode_macro TOOL_DATA"].get("offset_y" ~ tool)|default(0)|float %}
    {% set z = vars.get('tool_' ~ (tool - 1) ~ '_offset_z', 0.0)|float %}
    {% if printer["gcode_macro TOOL_DATA"].debugativo %}
       RESPOND PREFIX="INFO" MSG="TOOL={tool}: Offset aplicado X={x} Y={y} Z={z} (Z direto de variables.cfg)"
     {% endif %}
  {% endif %}
  
  G1 f10000
  M117 Offset aplicado: TOOL={tool}
  {% set homed = printer.toolhead.homed_axes %}
  {% set can_move = 'x' in homed and 'y' in homed and 'z' in homed %}
  {% if can_move %}
    SET_GCODE_OFFSET X={x} Y={y}  MOVE=1
    SET_GCODE_OFFSET Z={z}  X={x} Y={y} MOVE=1
  {% else %}
    SET_GCODE_OFFSET X={x} Y={y}
    SET_GCODE_OFFSET Z={z}  X={x} Y={y}
  {% endif %}


[gcode_macro APPLY_TOOLZ_OFFSET]
gcode:
  {% set tool = printer["gcode_macro TOOL_STATE"].tool|int %}
  {% set vars = printer.save_variables.variables %}
  
  ; üîß CORRE√á√ÉO: T0 (tool=1) deve ter offset ZERO (refer√™ncia BLTouch)
  {% if tool == 1 %}
    ; T0 = ferramenta f√≠sica 1, mas √© a refer√™ncia (offset zero) 
    {% set z = 0.0 %}
    RESPOND PREFIX="INFO" MSG="T0 (refer√™ncia): Offset ZERO aplicado X={x} Y={y} Z={z}"
  {% elif tool == 2 %}
    ; T1 - X/Y fixos do TOOL_DATA, Z direto do variables.cfg 
    {% set z = vars.get('tool_0_offset_z', 0.0)|float %}
    RESPOND PREFIX="INFO" MSG="T1: Offset aplicado X={x} Y={y} Z={z} (Z direto de variables.cfg)"
  {% elif tool == 3 %}
    ; T2 - X/Y fixos do TOOL_DATA, Z direto do variables.cfg 
    {% set z = vars.get('tool_1_offset_z', 0.0)|float %}
    RESPOND PREFIX="INFO" MSG="T2: Offset aplicado X={x} Y={y} Z={z} (Z direto de variables.cfg)"
  {% elif tool == 4 %}
    ; T3 - X/Y fixos do TOOL_DATA, Z direto do variables.cfg 
    {% set z = vars.get('tool_2_offset_z', 0.0)|float %}
    {% if printer["gcode_macro TOOL_DATA"].debugativo %}
       RESPOND PREFIX="INFO" MSG="T3: Offset aplicado X={x} Y={y} Z={z} (Z direto de variables.cfg)"
     {% endif %}
  {% else %}
    ; Fallback para outras ferramentas 
    {% set z = vars.get('tool_' ~ (tool - 1) ~ '_offset_z', 0.0)|float %}
    {% if printer["gcode_macro TOOL_DATA"].debugativo %}
       RESPOND PREFIX="INFO" MSG="TOOL={tool}: Offset aplicado X={x} Y={y} Z={z} (Z direto de variables.cfg)"
     {% endif %}
  {% endif %}
  
  G1 f10000
  M117 Offset Z aplicado: TOOL={tool}
 
  SET_GCODE_OFFSET Z={z}    MOVE=1

  
[gcode_macro APPLY_TOOL_OFFSET_UNSEC]
gcode:
  {% set tool = printer["gcode_macro TOOL_STATE"].tool|int %}
  {% set vars = printer.save_variables.variables %}
  
  ; üîß CORRE√á√ÉO: T0 (tool=1) deve ter offset ZERO (refer√™ncia BLTouch)
  {% if tool == 1 %}
    ; T0 = ferramenta f√≠sica 1, mas √© a refer√™ncia (offset zero)
    {% set x = 0.0 %}
    {% set y = 0.0 %}
    {% set z = 0.0 %}
    RESPOND PREFIX="INFO" MSG="T0 (refer√™ncia): Offset ZERO aplicado X={x} Y={y} Z={z}"
  {% elif tool == 2 %}
    ; T1 - X/Y fixos do TOOL_DATA, Z direto do variables.cfg
    {% set x = printer["gcode_macro TOOL_DATA"].get("offset_x2")|default(0)|float %}
    {% set y = printer["gcode_macro TOOL_DATA"].get("offset_y2")|default(0)|float %}
    {% set z = vars.get('tool_0_offset_z', 0.0)|float %}
    RESPOND PREFIX="INFO" MSG="T1: Offset aplicado X={x} Y={y} Z={z} (Z direto de variables.cfg)"
  {% elif tool == 3 %}
    ; T2 - X/Y fixos do TOOL_DATA, Z direto do variables.cfg
    {% set x = printer["gcode_macro TOOL_DATA"].get("offset_x3")|default(0)|float %}
    {% set y = printer["gcode_macro TOOL_DATA"].get("offset_y3")|default(0)|float %}
    {% set z = vars.get('tool_1_offset_z', 0.0)|float %}
    RESPOND PREFIX="INFO" MSG="T2: Offset aplicado X={x} Y={y} Z={z} (Z direto de variables.cfg)"
  {% elif tool == 4 %}
    ; T3 - X/Y fixos do TOOL_DATA, Z direto do variables.cfg
    {% set x = printer["gcode_macro TOOL_DATA"].get("offset_x4")|default(0)|float %}
    {% set y = printer["gcode_macro TOOL_DATA"].get("offset_y4")|default(0)|float %}
    {% set z = vars.get('tool_2_offset_z', 0.0)|float %}
    RESPOND PREFIX="INFO" MSG="T3: Offset aplicado X={x} Y={y} Z={z} (Z direto de variables.cfg)"
  {% else %}
    ; Fallback para outras ferramentas
    {% set x = printer["gcode_macro TOOL_DATA"].get("offset_x" ~ tool)|default(0)|float %}
    {% set y = printer["gcode_macro TOOL_DATA"].get("offset_y" ~ tool)|default(0)|float %}
    {% set z = vars.get('tool_' ~ (tool - 1) ~ '_offset_z', 0.0)|float %}
    RESPOND PREFIX="INFO" MSG="TOOL={tool}: Offset aplicado X={x} Y={y} Z={z} (Z direto de variables.cfg)"
  {% endif %}
  
  G1 f10000
  M117 Offset aplicado: TOOL={tool}

  SET_GCODE_OFFSET X={x} Y={y}  MOVE=1 
  SET_GCODE_OFFSET Z={z}  X={x} Y={y} MOVE=1

[gcode_macro SET_DIF_TEMP]
description: "Define o delta de resfriamento na macro TROCA (ex.: SET_DIF_TEMP delta=25)"
gcode:
  {% set delta = params.DELTA|default(20)|int %}  ; Default 20 se n√£o especificado
  SET_GCODE_VARIABLE MACRO=TROCA VARIABLE=dif_temp VALUE={delta}
  RESPOND PREFIX="INFO" MSG="DIF_TEMP definido para {delta}¬∞C na macro TROCA"

 
 

# Adicionar no in√≠cio da macro TROCA (logo ap√≥s as vari√°veis)
[gcode_macro TROCA]
variable_dif_temp: 25
variable_z_antes: 0.0
variable_verificacao_pausada: False
variable_skip_filamento: False
variable_skip_move: False
variable_min_standby: 0
gcode:
  PSU_ON_SAFE
  {% set ignore_lidar = params.IGNORE_LIDAR|default(0)|int %}
  {% set tool = params.TOOL|default(0)|int %}
  {% set vars = printer.save_variables.variables %}
  {% set new_temp = vars.get('tool_temp_' ~ tool, 0)|int %}
  {% set new_extr = 'extruder' if tool == 1 else 'extruder' ~ (tool - 1) %}
  {% if new_temp > 0 %}
    M104.0 T{tool - 1} S{new_temp}
    RESPOND MSG="Pr√©-aquecendo Tool {tool - 1} para {new_temp}¬∞C (early)"
  {% else %}
    RESPOND MSG="Nenhuma temperatura salva para Tool {tool - 1} ‚Äî pr√©-aquecimento ser√° aplicado quando dispon√≠vel"
  {% endif %}
  # Pausar verifica√ß√£o autom√°tica durante a troca
  SET_GCODE_VARIABLE MACRO=TROCA VARIABLE=verificacao_pausada VALUE=True
  RESPOND PREFIX="DEBUG" MSG="üîß Verifica√ß√£o autom√°tica pausada durante troca"
  
  {% set z_atual = printer.toolhead.position.z|float %}
  SET_GCODE_VARIABLE MACRO=TROCA VARIABLE=z_antes VALUE={z_atual}
  {% set tool_y = printer["gcode_macro TOOL_DATA"].tool_y|int %}
  {% set secure_y = printer["gcode_macro TOOL_DATA"].secure_y|int %}
  {% set approach_speed = printer["gcode_macro TOOL_DATA"].approach_speed|int %}
  {% set x_pos = printer["gcode_macro TOOL_DATA"].get("dock_x" ~ tool)|float %}
  {% set approach_pre = tool_y - 10 %}
  {% set approach_slow = approach_speed // 10 %}
  {% set active_tool = printer["gcode_macro TOOL_STATE"].tool|int %}
  {% set extruders = {
    1: "extruder", 2: "extruder1", 3: "extruder2", 4: "extruder3"   
    } %}
  {% set standby = {
    1: printer["gcode_macro TOOL_DATA"].standby_temp_T1|default(170)|int,
    2: printer["gcode_macro TOOL_DATA"].standby_temp_T2|default(170)|int,
    3: printer["gcode_macro TOOL_DATA"].standby_temp_T3|default(170)|int,
    4: printer["gcode_macro TOOL_DATA"].standby_temp_T4|default(170)|int
  } %}
  
  # Nova l√≥gica de temperatura: Resfriar todas as outras ativas respeitando dif_temp (sem quedas cumulativas)
  {% set all_tools = [1,2,3,4] %}  # Ferramentas dispon√≠veis (ajuste se necess√°rio)
  {% for i in all_tools %}
    {% if i != tool %}
      {% set extr_name = "extruder" if i == 1 else "extruder" ~ (i - 1) %}
      {% set curr_temp = printer[extr_name].temperature|float %}
      {% if curr_temp > 50 %}  # Considera "ativa" se >50¬∞C (ajuste o limiar se quiser)
        {% set saved_temp = vars.get('tool_temp_' ~ i, 0)|int %}
        {% if saved_temp == 0 and printer[extr_name].target|default(0)|int > 0 %}
          {% set saved_temp = printer[extr_name].target|int %}
          SAVE_VARIABLE VARIABLE=tool_temp_{i} VALUE={saved_temp}
        {% endif %}
        {% if saved_temp > 0 %}
          {% set standby_temp = [saved_temp - dif_temp, printer["gcode_macro TROCA"].min_standby|default(0)]|max %}
          M104.0 T{i - 1} S{standby_temp}  # Resfria (sem wait)
          RESPOND MSG="Resfriando Tool {i - 1}: base={saved_temp} ‚Üí standby={standby_temp} (‚àí{dif_temp}¬∞C)"
        {% endif %}
      {% endif %}
    {% endif %}
  {% endfor %}
  
  {% if active_tool != tool %}
    SAVE_GCODE_STATE NAME=toolchange
    SET_GCODE_OFFSET X=0 Y=0 Z=0
    G90

    # Verificar presen√ßa inicial de ferramenta
    {% if printer["gcode_macro LIDAR_MODE"].status %}
      {% set lidar = printer["gcode_macro DISTANCIA_VL53"].distancia|float %}
    {% else %}
        {% set lidar = 100.0 %}
    {% endif %}

    {% if lidar > 110 %}
      {% if printer["gcode_macro TOOL_DATA"].debugativo %}
        RESPOND PREFIX="INFO" MSG="üîé Aus√™ncia de ferramenta detectada ‚Äî abrindo trava"
      {% endif %}
      M117 "Aus√™ncia de ferramenta detectada ‚Äî abrindo trava" 
      ABRIR
      G4 P300
    {% endif %}

    # Processo de remo√ß√£o da ferramenta ativa
    {% if active_tool != 0 and printer["gcode_macro TOOL_LOCK"].enabled %}
      SAVE_VARIABLE VARIABLE=last_tool VALUE={active_tool}
      {% set cur_x = printer["gcode_macro TOOL_DATA"].get("dock_x" ~ active_tool)|float %}
      {% set extruder_name = extruders[active_tool] %}
      {% set temp_minima = 0 %}
      #{% set temp_minima = 160 %}
      {% set atual = printer[extruder_name].temperature|float %}
      M117 "Extruder Name  {extruder_name}"
       
      {% if not printer["gcode_macro TROCA"].skip_filamento|default(False) and atual >= temp_minima %}
        M117 "Retraindo filamento na Tool {active_tool}"
        G91
        G1 E-5 F4000
        G90
      {% else %}
        {% set msg = "Tool " ~ active_tool ~ " carregada, mas extrusora est√° em " ~ atual ~ " ¬∞C ‚Äî sem retra√ß√£o" %}
        {% if printer["gcode_macro TOOL_DATA"].debugativo %}
          RESPOND PREFIX="INFO" MSG="{msg}"
        {% endif %}
      {% endif %}

      # Movimento para posi√ß√£o de remo√ß√£o
      G1  Y200 F8000
      G1 X{cur_x} Y200 F8000
      G1 Y{approach_pre} F{approach_speed}
      # Parar a 1cm antes para abrir servo (facilita desconex√£o)
      {% set remove_pre = tool_y - 10 %}
      G1 Y{remove_pre} F{approach_speed}
      ABRIR
      G4 P300
      # Avan√ßar para posi√ß√£o final de remo√ß√£o
      G1 Y{tool_y} F{approach_slow}
      G4 P300
      # Retornar com servo aberto para buscar pr√≥xima ferramenta
      G1 Y{secure_y} F{approach_speed}  # Movimento absoluto para posi√ß√£o segura
      G4 P800
      
      # Verificar se ferramenta foi removida
      {% if printer["gcode_macro LIDAR_MODE"].STATUS   %}
        {% set lidar = printer["gcode_macro DISTANCIA_VL53"].distancia|float %}
      {% else %}
        {% set lidar = 150.0 %}
      {% endif %}
      
      {% if lidar > 140 %}
        {% set msg = "DISTANCIA " ~ lidar ~ "mm - ferramenta removida com sucesso" %}
        M117 {msg}
        {% if printer["gcode_macro TOOL_DATA"].debugativo %}
          RESPOND PREFIX="INFO" MSG="‚úÖ Ferramenta removida com sucesso"
        {% endif %}
        SET_GCODE_VARIABLE MACRO=TOOL_STATE VARIABLE=tool VALUE=0
        
        # Verificar se nova ferramenta est√° dispon√≠vel
         
        {% if printer["gcode_macro LIDAR_MODE"].STATUS  %}
          {% set lidar = printer["gcode_macro DISTANCIA_VL53"].distancia|float %}
        {% else %}
          {% set lidar = 150.0 %}
        {% endif %}
        {% if lidar <= 220 %}
          {% if printer["gcode_macro TOOL_DATA"].debugativo %}
             RESPOND PREFIX="INFO" MSG="‚úÖ Ferramenta {tool} detectada no dock ‚Äî prosseguindo"
           {% endif %}
          
          {% if printer["gcode_macro TOOL_LOCK"].enabled %}
          G1 X{x_pos} F{approach_speed}
          # Parar a 1cm antes do fim para abrir servo (ajuda desconex√£o)
          {% set approach_pre = tool_y - 10 %}
          G1 Y{approach_pre} F{approach_speed}
          ABRIR
          G4 P300
          # Avan√ßar para posi√ß√£o final
          G1 Y{tool_y} F{approach_slow}
          G4 P300
          FECHAR
          G4 P300
        {% endif %}

          SET_GCODE_VARIABLE MACRO=TOOL_STATE VARIABLE=tool VALUE={tool}
          SAVE_VARIABLE VARIABLE=tool VALUE={tool}

          {% set extruder_name = extruders[tool] %}
          {% set atual = printer[extruder_name].temperature|float %}
          {% set temp_minima = 180 %}
          
          {% if printer[extruder_name] is defined %}
            ACTIVATE_EXTRUDER EXTRUDER={extruder_name}
            SYNC_EXTRUDER_MOTION EXTRUDER=belted_extruder MOTION_QUEUE={extruder_name}
            SET_PRESSURE_ADVANCE EXTRUDER=belted_extruder ADVANCE={printer["extruder_stepper belted_extruder"].pressure_advance}


            #SYNC_EXTRUDER_MOTION STEPPER=extruder EXTRUDER=extruder
            #SYNC_EXTRUDER_MOTION STEPPER=extruder EXTRUDER=extruder1
            #SYNC_EXTRUDER_MOTION STEPPER=extruder EXTRUDER=extruder2
            #SYNC_EXTRUDER_MOTION STEPPER=extruder EXTRUDER=extruder3
            #ACTIVATE_EXTRUDER EXTRUDER={extruder_name}  # S√≥ funciona para tool 1 (extruder real)
          {% else %}

            RESPOND PREFIX="INFO" MSG="Tool {tool} selecionada. Use comandos espec√≠ficos: M104 T{tool-1} S220"
          {% endif %}
          {% if not printer["gcode_macro TROCA"].skip_move|default(False) %}
            MOVE_EXTRUDER EXTRUDER={tool-1}
          {% endif %}
          APPLY_TOOLZ_OFFSET

           
          {% else %}
            {% if printer["gcode_macro TOOL_DATA"].debugativo %}
               RESPOND PREFIX="WARNING" MSG="Tool {tool} carregada, mas extrusora n√£o est√° definida."
             {% endif %}
          {% endif %}

          {% if not printer["gcode_macro TROCA"].skip_filamento|default(False) and atual >= temp_minima %}
            M117 "Inserindo filamento na Tool {tool}"
            G91
            G1 E5 F500
            G90
          {% endif %}
          
          # Anulado: N√£o retorna mais automaticamente (fatiador gerencia torre e posicionamento)
          # RESTORE_GCODE_STATE NAME=toolchange MOVE=1  ; Comentado para evitar oozing no retorno
          
          # Nova: Posi√ß√£o segura p√≥s-troca (ex.: Y=200, ajuste se necess√°rio)
          G90
          G1 Y200 F8000  ; Move para posi√ß√£o segura, aguardando fatiador ou comandos
          
          RESPOND PREFIX="INFO" MSG="Troca conclu√≠da - aguardando fatiador para purga e retomada"
          G1 Y{secure_y} F{approach_speed}  # Movimento absoluto para posi√ß√£o segura
          APPLY_TOOL_OFFSET
          G4 P300

          # Valida√ß√£o final
           
          {% if printer["gcode_macro LIDAR_MODE"].STATUS  %}
            {% set lidar_validacao = printer["gcode_macro DISTANCIA_VL53"].distancia|float %}
          {% else %}
            {% set lidar_validacao = 110.0 %}
          {% endif %}
  

        {% if lidar_validacao <= 110 %}
       # {% if 1 == 1 %}
          #CLEAN_NOZZLE_T0
          RESPOND PREFIX="INFO" MSG="üßº Limpando bico da ferramenta {tool}"
          APPLY_TOOL_OFFSET
        {% else %}
          RESPOND PREFIX="WARNING" MSG="‚ö†Ô∏è Ferramenta n√£o confirmada ‚Äî limpeza ignorada"
          APPLY_TOOL_OFFSET
        {% endif %}
        
      {% else %}
        RESPOND PREFIX="ERROR" MSG="‚ùå Ferramenta {tool} ausente no dock ‚Äî impress√£o pausada"
       # PAUSE
      {% endif %}
    {% endif %}
    
  {% if active_tool == 0 %}
    G1 Y200 F8000  # Move para Y seguro, se necess√°rio
    G1 X{x_pos} F8000  # Move para posi√ß√£o X da nova ferramenta
    G4 P500 # Pausa para estabilizar a leitura do sensor
    {% set lidar = printer["gcode_macro DISTANCIA_VL53"].distancia|float if printer["gcode_macro LIDAR_MODE"].status else 150.0 %}
    G4 P300
    {% set lidar2 = printer["gcode_macro DISTANCIA_VL53"].distancia|float if printer["gcode_macro LIDAR_MODE"].status else lidar %}
    {% if ignore_lidar or lidar <= 220 or lidar2 <= 220 %}
      {% if printer["gcode_macro TOOL_DATA"].debugativo %}
        RESPOND PREFIX="INFO" MSG="‚úÖ Ferramenta {tool} detectada no dock ‚Äî prosseguindo"
      {% endif %}
      {% if printer["gcode_macro TOOL_LOCK"].enabled %}
        G1 Y{approach_pre} F{approach_speed}
        ABRIR
        G4 P300
        G1 Y{tool_y} F{approach_slow}
        G4 P300
        FECHAR
        G4 P300
      {% endif %}
      SET_GCODE_VARIABLE MACRO=TOOL_STATE VARIABLE=tool VALUE={tool}
      SAVE_VARIABLE VARIABLE=tool VALUE={tool}
      {% set extruder_name = extruders[tool] %}
      {% set atual = printer[extruder_name].temperature|float %}
      {% set temp_minima = 180 %}
      {% if printer[extruder_name] is defined %}
        ACTIVATE_EXTRUDER EXTRUDER={extruder_name}
        SYNC_EXTRUDER_MOTION EXTRUDER=belted_extruder MOTION_QUEUE={extruder_name}
        SET_PRESSURE_ADVANCE EXTRUDER=belted_extruder ADVANCE={printer["extruder_stepper belted_extruder"].pressure_advance}


        {% if not printer["gcode_macro TROCA"].skip_move|default(False) %}
          MOVE_EXTRUDER EXTRUDER={tool-1}
        {% endif %}
        APPLY_TOOLZ_OFFSET
      {% else %}
        RESPOND PREFIX="INFO" MSG="Tool {tool} selecionada. Use comandos espec√≠ficos: M104 T{tool-1} S220"
      {% endif %}
      {% if not printer["gcode_macro TROCA"].skip_filamento|default(False) and atual >= temp_minima %}
        M117 "Inserindo filamento na Tool {tool}"
        G91
        G1 E5 F500
        G90
      {% endif %}
      G90
      G1 Y200 F8000
      RESPOND PREFIX="INFO" MSG="Troca conclu√≠da - aguardando fatiador para purga e retomada"
      G1 Y{secure_y} F{approach_speed}
      APPLY_TOOL_OFFSET
      G4 P300
      {% set lidar_validacao = printer["gcode_macro DISTANCIA_VL53"].distancia|float if printer["gcode_macro LIDAR_MODE"].status else 110.0 %}
      {% if lidar_validacao <= 110 %}
        RESPOND PREFIX="INFO" MSG="üßº Limpando bico da ferramenta {tool}"
        APPLY_TOOL_OFFSET
      {% else %}
        {% if ignore_lidar %}
          APPLY_TOOL_OFFSET
        {% else %}
          RESPOND PREFIX="ERROR" MSG="‚ùå FALHA NO ACOPLAMENTO! PARANDO IMPRESS√ÉO!"
          M117 ERRO: Ferramenta n√£o acoplada!
          PAUSE
        {% endif %}
      {% endif %}
    {% else %}
      RESPOND PREFIX="ERROR" MSG="‚ùå Ferramenta {tool} ausente no dock ‚Äî impress√£o pausada"
    {% endif %}
  {% endif %}
  {% else %}
    {% set msg = "Tool " ~ tool ~ " j√° est√° ativa" %}
    RESPOND MSG="{msg}"
    M117 {msg}
  {% endif %}
  G1 F10000
  G91
  G1 y-5 F8000
  G90
  # No final da macro TROCA (antes do movimento para torre de purga)
  # Reabilitar verifica√ß√£o autom√°tica ap√≥s a troca
  SET_GCODE_VARIABLE MACRO=TROCA VARIABLE=verificacao_pausada VALUE=False
  RESPOND PREFIX="DEBUG" MSG="üîß Verifica√ß√£o autom√°tica reabilitada"
  
  G1 X150 Y180 F11000 ; Move para a posi√ß√£o da torre de purga em alta velocidade


[gcode_macro T0]
gcode: 
  {% set current_tool = printer["gcode_macro TOOL_STATE"].tool|int %}
  {% if current_tool == 1 %}
    {% if printer["gcode_macro TOOL_DATA"].debugativo %}
      RESPOND PREFIX="INFO" MSG="T0 j√° est√° ativa"
    {% endif %}
    M117 T0 j√° ativa
  {% else %}
    TROCA TOOL=1
  {% endif %}

[gcode_macro T1]
gcode: 
  {% set current_tool = printer["gcode_macro TOOL_STATE"].tool|int %}
  {% if current_tool == 2 %}
    {% if printer["gcode_macro TOOL_DATA"].debugativo %}
      RESPOND PREFIX="INFO" MSG="T1 j√° est√° ativa - recarregando ferramenta"
    {% endif %}
    M117 Recarregando T1...
    RECARREGAR_FERRAMENTA TOOL=2
  {% else %}
    TROCA TOOL=2
  {% endif %}

[gcode_macro T2]
gcode: 
  {% set current_tool = printer["gcode_macro TOOL_STATE"].tool|int %}
  {% if current_tool == 3 %}
    {% if printer["gcode_macro TOOL_DATA"].debugativo %}
      RESPOND PREFIX="INFO" MSG="T2 j√° est√° ativa - recarregando ferramenta"
    {% endif %}
    M117 Recarregando T2...
    RECARREGAR_FERRAMENTA TOOL=3
  {% else %}
    TROCA TOOL=3
  {% endif %}

[gcode_macro T3]
gcode: 
  {% set current_tool = printer["gcode_macro TOOL_STATE"].tool|int %}
  {% if current_tool == 4 %}
    {% if printer["gcode_macro TOOL_DATA"].debugativo %}
      RESPOND PREFIX="INFO" MSG="T3 j√° est√° ativa - recarregando ferramenta"
    {% endif %}
    M117 Recarregando T3...
    RECARREGAR_FERRAMENTA TOOL=4
  {% else %}
    TROCA TOOL=4
  {% endif %}

[gcode_macro TOOL_LOCK]
variable_enabled: True
gcode:
  {% if params.ACTION|default("") == "OFF" %}
    SET_GCODE_VARIABLE MACRO=TOOL_LOCK VARIABLE=enabled VALUE=False
    {% if printer["gcode_macro TOOL_DATA"].debugativo %}
      RESPOND PREFIX="INFO" MSG="Movimentos de troca de ferramenta DESATIVADOS"
    {% endif %}
  {% elif params.ACTION|default("") == "ON" %}
    SET_GCODE_VARIABLE MACRO=TOOL_LOCK VARIABLE=enabled VALUE=True
    {% if printer["gcode_macro TOOL_DATA"].debugativo %}
      RESPOND PREFIX="INFO" MSG="Movimentos de troca de ferramenta ATIVADOS"
    {% endif %}
  {% else %}
    {% if printer["gcode_macro TOOL_DATA"].debugativo %}
      RESPOND PREFIX="INFO" MSG="Uso: TOOL_LOCK ACTION=ON ou ACTION=OFF"
    {% endif %}
  {% endif %}

[gcode_macro SHOW_TOOL_STATUS]
description: Mostra o status de todas as ferramentas
gcode:
  {% set active = printer["gcode_macro TOOL_STATE"].tool|int %}
  {% for i in range(1, 5) %}
    {% if i == active %}
      {% if printer["gcode_macro TOOL_DATA"].debugativo %}
        RESPOND PREFIX="TOOL" MSG="Tool {i} ‚Üí ATIVA"
      {% endif %}
    {% else %}
      {% if printer["gcode_macro TOOL_DATA"].debugativo %}
        RESPOND PREFIX="TOOL" MSG="Tool {i} - inativa"
      {% endif %}
    {% endif %}
  {% endfor %}
  M117 Tool ativa: {active}

[gcode_macro RECARREGAR_FERRAMENTA]
description: Recarrega a ferramenta atual abrindo servo a 1cm do estacionamento
gcode:
  {% set tool = params.TOOL|default(0)|int %}
  {% set tool_y = printer["gcode_macro TOOL_DATA"].tool_y|int %}
  {% set secure_y = printer["gcode_macro TOOL_DATA"].secure_y|int %}
  {% set approach_speed = printer["gcode_macro TOOL_DATA"].approach_speed|int %}
  {% set x_pos = printer["gcode_macro TOOL_DATA"].get("dock_x" ~ tool)|float %}
  {% set approach_pre = tool_y - 10 %}  # 1cm antes do estacionamento
  {% set approach_slow = approach_speed // 10 %}
  
  {% if tool == 0 %}
    {% if printer["gcode_macro TOOL_DATA"].debugativo %}
      RESPOND PREFIX="ERROR" MSG="TOOL inv√°lida para recarregamento"
    {% endif %}
    RETURN
  {% endif %}

  {% if printer["gcode_macro TOOL_DATA"].debugativo %}
    RESPOND PREFIX="INFO" MSG="üîÑ Recarregando ferramenta TOOL={tool} - abrindo servo a 1cm do estacionamento"
  {% endif %}
  M117 Recarregando TOOL={tool}...

  SAVE_GCODE_STATE NAME=reload_tool
  G90
  
  # Aplicar apenas offset de T0 (zero) para movimentos de troca sem mudar extrusor
  {% set x_t0 = printer["gcode_macro TOOL_DATA"].get("offset_x1")|default(0)|float %}
  {% set y_t0 = printer["gcode_macro TOOL_DATA"].get("offset_y1")|default(0)|float %}
  {% set z_t0 = 0.0 %}
  SET_GCODE_OFFSET X={x_t0} Y={y_t0} Z={z_t0}
  
  # Ir para posi√ß√£o de recarregamento (1cm antes do estacionamento)
  G1 Y200 F8000
  G1 X{x_pos} Y200 F8000
  G1 Y{approach_pre} F{approach_speed}  # Para a 1cm do estacionamento
  
  # Abrir servo para permitir reposicionamento
  ABRIR
  G4 P500
  
  # Avan√ßar para posi√ß√£o final e fechar
  G1 Y{tool_y} F{approach_slow}
  G4 P300
  FECHAR
  G4 P500
  
  # Retornar para posi√ß√£o segura
  G1 Y{secure_y} F{approach_speed}  # Movimento absoluto para posi√ß√£o segura
  
  # Aplicar offsets da ferramenta recarregada
  APPLY_TOOL_OFFSET
  
  RESTORE_GCODE_STATE NAME=reload_tool
  {% if printer["gcode_macro TOOL_DATA"].debugativo %}
    RESPOND PREFIX="INFO" MSG="‚úÖ Ferramenta TOOL={tool} recarregada com sucesso"
  {% endif %}
  M117 TOOL={tool} recarregada

[gcode_macro DESCARREGAR]
description: Descarrega a ferramenta atual e retorna √† posi√ß√£o segura
gcode:
  {% set cur_tool = printer["gcode_macro TOOL_STATE"].tool|int %}
  {% set tool_y = printer["gcode_macro TOOL_DATA"].tool_y|int %}
  {% set approach_speed = printer["gcode_macro TOOL_DATA"].approach_speed|int %}
  {% set cur_x = printer["gcode_macro TOOL_DATA"].get("dock_x" ~ cur_tool)|int %}

  {% if cur_tool == 0 %}
    {% if printer["gcode_macro TOOL_DATA"].debugativo %}
      RESPOND PREFIX="INFO" MSG="Nenhuma ferramenta carregada"
    {% endif %}
    RETURN
  {% endif %}

  {% if printer["gcode_macro TOOL_DATA"].debugativo %}
    RESPOND MSG="Descarregando ferramenta TOOL={cur_tool}"
  {% endif %}
  M117 Descarregando ferramenta TOOL={cur_tool}

  G90
  G1 Y200 F2000
  G1 X{cur_x} F2000
  G1 Y{tool_y} F{approach_speed}
  ABRIR
  G4 P300
  G91
  G1 Y-100 F2000
  G90
  SET_GCODE_VARIABLE MACRO=TOOL_STATE VARIABLE=tool VALUE=0
  SAVE_VARIABLE VARIABLE=tool VALUE=0
  M117 Tool descarregada

[gcode_macro ABRIR]
description: Abre a trava da ferramenta (servo a 0¬∞)
gcode:
  SET_SERVO SERVO=tool_servo WIDTH=1 
  SET_SERVO SERVO=tool_servo ANGLE=0 
  G4 P500
  SET_SERVO SERVO=tool_servo WIDTH=0
  {% if printer["gcode_macro TOOL_DATA"].debugativo %}
    RESPOND MSG="Trava aberta (0¬∞)"
  {% endif %}
[gcode_macro FECHAR]
description: Fecha a trava da ferramenta (servo a 180¬∞)
gcode:
  SET_SERVO SERVO=tool_servo WIDTH=1  
  SET_SERVO SERVO=tool_servo ANGLE=180  
  G4 P300
  SET_SERVO SERVO=tool_servo ANGLE=150  
  G4 P500
  SET_SERVO SERVO=tool_servo ANGLE=180  
  G4 P300 
  # Remover: SET_SERVO SERVO=tool_servo WIDTH=0
  # Iniciar timer de 50 segundos para desligar o servo
  UPDATE_DELAYED_GCODE ID=servo_auto_off DURATION=50
  {% if printer["gcode_macro TOOL_DATA"].debugativo %}
    RESPOND MSG="Trava fechada (180¬∞) - Servo ser√° desligado em 50s"
  {% endif %}

[gcode_macro ABRIR]
description: Abre a trava da ferramenta (servo a 0¬∞)
gcode:
  # Cancelar timer de desligamento autom√°tico se estiver ativo
  UPDATE_DELAYED_GCODE ID=servo_auto_off DURATION=0
  SET_SERVO SERVO=tool_servo WIDTH=1 
  SET_SERVO SERVO=tool_servo ANGLE=0 
  G4 P500
  SET_SERVO SERVO=tool_servo WIDTH=0
  {% if printer["gcode_macro TOOL_DATA"].debugativo %}
    RESPOND MSG="Trava aberta (0¬∞) - Timer de desligamento cancelado"
  {% endif %}

# Adicionar no final do arquivo
[delayed_gcode servo_auto_off]
gcode:
  SET_SERVO SERVO=tool_servo WIDTH=0
  {% if printer["gcode_macro TOOL_DATA"].debugativo %}
    RESPOND MSG="üîå Servo desligado automaticamente ap√≥s 50s"
  {% endif %}

[gcode_macro WHOAMI]
gcode:
  {% if printer["gcode_macro TOOL_DATA"].debugativo %}
    RESPOND PREFIX="DEBUG" MSG="tool={printer['gcode_macro TOOL_STATE'].tool} active_extruder={printer.toolhead.extruder}"
  {% endif %}

[gcode_macro FM104]
#rename_existing: M104_BASE
gcode:
  {% set s = params.S|default(0)|float %}
  {% if 'T' in params %}
    {% set t = params.T|int %}
    {% set extr = "extruder" if t==0 else "extruder" ~ t %}
  {% else %}
    {% set extr = printer.toolhead.extruder %}
  {% endif %}
  {% if printer["gcode_macro TOOL_DATA"].debugativo %}
    RESPOND PREFIX="DEBUG" MSG="M104 -> {extr}  S={s}"
  {% endif %}
  SET_HEATER_TEMPERATURE HEATER={extr} TARGET={s}


[gcode_macro FM109]
#rename_existing: M109_BASE
gcode:
  {% set s = params.S|default(0)|float %}
  {% if 'T' in params %}
    {% set t = params.T|int %}
    {% set extr = "extruder" if t==0 else "extruder" ~ t %}
  {% else %}
    {% set extr = printer.toolhead.extruder %}
  {% endif %}
  {% if printer["gcode_macro TOOL_DATA"].debugativo %}
    RESPOND PREFIX="DEBUG" MSG="M109 -> {extr}  S={s}"
  {% endif %}
  SET_HEATER_TEMPERATURE HEATER={extr} TARGET={s}
  TEMPERATURE_WAIT SENSOR={extr} MINIMUM={s-1} MAXIMUM={s+5}


[gcode_macro DEBUG_ATIVO]
description: Ativa ou desativa as mensagens de debug
gcode:
  {% if params.ACAO|default("") == "ON" %}
    SET_GCODE_VARIABLE MACRO=TOOL_DATA VARIABLE=debugativo VALUE=True
    RESPOND PREFIX="INFO" MSG="üîß Debug ATIVADO - mensagens ser√£o exibidas"
  {% elif params.ACAO|default("") == "OFF" %}
    SET_GCODE_VARIABLE MACRO=TOOL_DATA VARIABLE=debugativo VALUE=False
    RESPOND PREFIX="INFO" MSG="üîá Debug DESATIVADO - mensagens ocultadas"
  {% else %}
    {% set status = "ATIVO" if printer["gcode_macro TOOL_DATA"].debugativo else "INATIVO" %}
    RESPOND PREFIX="INFO" MSG="Debug est√° {status}. Use: DEBUG_ATIVO ACAO=ON ou ACAO=OFF"
  {% endif %}

#[include global_probe_config.cfg]  # CONFIGURA√á√ïES GLOBAIS DE COORDENADAS
#[include calibracao_probe_automatica.cfg]  # SISTEMA DE CALIBRA√á√ÉO AUTOM√ÅTICA COM PROBE
[gcode_macro VERIFICAR_FERRAMENTA]
description: Verifica se a ferramenta ainda est√° acoplada durante a impress√£o
gcode:
  {% set current_tool = printer["gcode_macro TOOL_STATE"].tool|int %}
  {% if current_tool > 0 %}
    {% set lidar_validacao = printer["gcode_macro DISTANCIA_VL53"].distancia|float if printer["gcode_macro LIDAR_MODE"].status else 110.0 %}
    
    # SEMPRE mostra a dist√¢ncia lida no console
    RESPOND PREFIX="DEBUG" MSG="üîç LIDAR: {lidar_validacao}mm | Ferramenta: T{current_tool} | Limite: 110mm"
    
    {% if lidar_validacao > 110 %}
      RESPOND PREFIX="ERROR" MSG="‚ùå FERRAMENTA PERDIDA! Dist√¢ncia: {lidar_validacao}mm > 110mm"
      M117 ERRO: Ferramenta perdida! ({lidar_validacao}mm)
      PAUSE  ; Pausa para interven√ß√£o manual
    {% else %}
      RESPOND PREFIX="INFO" MSG="‚úÖ Ferramenta T{current_tool} OK - Dist√¢ncia: {lidar_validacao}mm"
    {% endif %}
  {% else %}
    RESPOND PREFIX="DEBUG" MSG="üîç Nenhuma ferramenta ativa - verifica√ß√£o ignorada"
  {% endif %}

[gcode_macro VERIFICACAO_AUTOMATICA]
description: Ativa verifica√ß√£o autom√°tica da ferramenta a cada 15 segundos
gcode:
  RESPOND PREFIX="INFO" MSG="üîÑ Verifica√ß√£o autom√°tica ATIVADA (15s)"
  UPDATE_DELAYED_GCODE ID=check_tool_timer DURATION=15

[delayed_gcode check_tool_timer]
gcode:
  {% if printer.print_stats.state == "printing" %}
    # Verifica se a verifica√ß√£o n√£o est√° pausada durante troca
    {% set verificacao_pausada = printer["gcode_macro TROCA"].verificacao_pausada|default(False) %}
    {% if not verificacao_pausada %}
      VERIFICAR_FERRAMENTA
    {% else %}
      RESPOND PREFIX="DEBUG" MSG="üîß Verifica√ß√£o ignorada - troca em andamento"
    {% endif %}
    UPDATE_DELAYED_GCODE ID=check_tool_timer DURATION=15  ; Reagenda para 15s
  {% else %}
    RESPOND PREFIX="INFO" MSG="üõë Verifica√ß√£o autom√°tica parada - impress√£o n√£o ativa"
  {% endif %}

#[include global_probe_config.cfg]  # CONFIGURA√á√ïES GLOBAIS DE COORDENADAS
