# Variáveis persistentes para temperaturas de cada hotend (inicializadas em 0)
#[save_variables]
#variables:
#  tool_temp_1: 0
#  tool_temp_2: 0
#  tool_temp_3: 0
#  tool_temp_4: 0

# Override para M104 com nome único para evitar conflitos
[gcode_macro M104]
rename_existing: BASE_M104  # Nome alternativo para o original
gcode:
  PSU_ON_SAFE
  {% set tool = params.T|default(0)|int + 1 %}  # T0=tool1, T1=tool2, etc.
  {% set temp = params.S|default(0)|int %}
  
  # Salva/atualiza se temp > 50 (captura mudanças dinâmicas)
  {% if tool >= 1 and tool <= 4  %}  #and temp > 50
    SAVE_VARIABLE VARIABLE=tool_temp_{tool} VALUE={temp}
    RESPOND MSG="Temperatura atualizada para Tool {tool-1}: {temp}°C"
  {% endif %}
  
  BASE_M104 {rawparams}  # Chama o comando original

# Mesmo para M109
[gcode_macro M109]
rename_existing: BASE_M109
gcode:
  PSU_ON_SAFE
  {% set tool = params.T|default(0)|int + 1 %}
  {% set temp = params.S|default(0)|int %}
  
  {% if tool >= 1 and tool <= 4  %} #and temp > 50
    SAVE_VARIABLE VARIABLE=tool_temp_{tool} VALUE={temp}
    RESPOND MSG="Temperatura atualizada para Tool {tool-1}: {temp}°C (com wait)"
  {% endif %}
  
  BASE_M109 {rawparams}

# Override para M104 com rename compatível
[gcode_macro M104]
rename_existing: M104.0  # Sufixo .0 para evitar conflito de tipos
gcode:
  PSU_ON_SAFE
  {% set tool = params.T|default(0)|int + 1 %}  # T0=tool1, T1=tool2, etc.
  {% set temp = params.S|default(0)|int %}
  
  # Salva/atualiza se temp > 50 (captura mudanças dinâmicas)
  {% if tool >= 1 and tool <= 4 %} #and temp > 50 
    SAVE_VARIABLE VARIABLE=tool_temp_{tool} VALUE={temp}
    RESPOND MSG="Temperatura atualizada para Tool {tool-1}: {temp}°C"
  {% endif %}
  
  M104.0 {rawparams}  # Chama a versão renomeada

# Mesmo para M109
[gcode_macro M109]
rename_existing: M109.0
gcode:
  PSU_ON_SAFE
  {% set tool = params.T|default(0)|int + 1 %}
  {% set temp = params.S|default(0)|int %}
  
  {% if tool >= 1 and tool <= 4 %} #and temp > 50 
    SAVE_VARIABLE VARIABLE=tool_temp_{tool} VALUE={temp}
    RESPOND MSG="Temperatura atualizada para Tool {tool-1}: {temp}°C (com wait)"
  {% endif %}
  
  M109.0 {rawparams}  # Chama a versão renomeada

# Configuração de salvamento de variáveis (sem inicialização direta)
#[save_variables]
#filename: ~/printer_data/config/variables.cfg  # Arquivo para salvar variáveis persistentes
#on_error_gcode: CANCEL_PRINT  # O


[gcode_macro SET_HEATER_TEMPERATURE]
rename_existing: BASE_SET_HEATER_TEMPERATURE  # Renomeia o nativo para chamar depois
gcode:
  {% set heater = params.HEATER|default('extruder')|string %}
  {% set target = params.TARGET|default(0)|float %}

  # Detecta tipos de heater
  {% set is_extruder = 'extruder' in heater %}
  {% set is_bed = heater in ['heater_bed', 'bed', 'heater_bed0'] %}

  {% if is_extruder %}
    # Extrai índice do extrusor: extruder -> Tool 1, extruder1 -> Tool 2, etc.
    {% set suffix = heater|replace('extruder', '') %}
    {% set idx = 0 if suffix == '' else suffix|int %}
    {% set tool_num = idx + 1 %}

    # Limite de segurança para extrusores
    {% set max_temp = 300.0 %}
    {% if target > max_temp %}
      RESPOND PREFIX="WARN" MSG="TARGET {target} acima do limite para extrusor; limitando a {max_temp}"
      {% set target = max_temp %}
    {% endif %}

    # Salva temperatura somente para extrusores
    SAVE_VARIABLE VARIABLE=tool_temp_{tool_num} VALUE={target}
    RESPOND MSG="Salvando temp {target}°C para Tool {tool_num}"

  {% elif is_bed %}
    # Limite de segurança para cama
    {% set bed_max = 120.0 %}
    {% if target > bed_max %}
      RESPOND PREFIX="WARN" MSG="TARGET {target} acima do limite para cama; limitando a {bed_max}"
      {% set target = bed_max %}
    {% endif %}
    RESPOND MSG="Ajustando cama para {target}°C (sem salvar em tool_temp)"

  {% else %}
    RESPOND PREFIX="INFO" MSG="Heater {heater} não reconhecido — repassando TARGET sem salvar"
  {% endif %}

  # Repassa para o comando nativo renomeado
  BASE_SET_HEATER_TEMPERATURE HEATER={heater} TARGET={target}