[gcode_macro CALIBRAR_HOTENDS]
description: Calibra os offsets Z dos hotends T1 e T2 em rela√ß√£o ao T0
gcode:
    SET_GCODE_OFFSET X=0 Y=0 Z=0 MOVE=1
    RESPOND PREFIX="INFO" MSG="üîß Iniciando calibra√ß√£o dos hotends..."
    {% set initial_tool = printer["gcode_macro TOOL_STATE"].tool|int %}
    SET_GCODE_VARIABLE MACRO=TROCA VARIABLE=skip_filamento VALUE=True
    SET_GCODE_VARIABLE MACRO=TROCA VARIABLE=skip_move VALUE=True

    G28
    SET_GCODE_OFFSET Z=0
    G90

    # T0 - Medir e salvar
    T0
    G1 X320 Y100 F10000
    SET_GCODE_OFFSET Z=0 MOVE=1
    PROBE PROBE_SPEED=1
    _SALVAR_Z_PROBE VARIAVEL=ref0
    G1 Z10 F1000

    # T1 - Medir e salvar
    T1
    G1 X320 Y100 F10000
    SET_GCODE_OFFSET Z=0  MOVE=1
    PROBE PROBE_SPEED=1
    _SALVAR_Z_PROBE VARIAVEL=ref1
    G1 Z10 F1000

    # T2 - Medir e salvar
    T2
    G1 X320 Y100 F10000
    SET_GCODE_OFFSET Z=0  MOVE=1
    PROBE PROBE_SPEED=1
    _SALVAR_Z_PROBE VARIAVEL=ref2
    G1 Z10 F1000

    # T3 - Medir e salvar
    T3
    G1 X320 Y100 F10000
    SET_GCODE_OFFSET Z=0 MOVE=1    
    PROBE PROBE_SPEED=1
    _SALVAR_Z_PROBE VARIAVEL=ref3


    G1 Z10 F1000

    # Calcular offsets com valores salvos
    {% set ref0 = printer.save_variables.variables.ref0|default(0.0) %}
    {% set ref1 = printer.save_variables.variables.ref1|default(0.0) %}
    {% set ref2 = printer.save_variables.variables.ref2|default(0.0) %}
    {% set ref3 = printer.save_variables.variables.ref3|default(0.0) %}
    {% set tool_0_offset = ref1 - ref0 %}
    {% set tool_1_offset = ref2 - ref0 %}
    {% set tool_2_offset = ref3 - ref0 %}

    RESPOND PREFIX="INFO" MSG="üìä Valores salvos - T0: {ref0|round(6)} | T1: {ref1|round(6)} | T2: {ref2|round(6)}| T3: {ref3|round(6)}"
    RESPOND PREFIX="INFO" MSG="üìä Offsets finais: tool_0_offset_z={tool_0_offset|round(6)}, tool_1_offset_z={tool_1_offset|round(6)}, tool_2_offset_z={tool_2_offset|round(6)}"

    {% if initial_tool > 0 %}
    TROCA TOOL={initial_tool}
    {% endif %}
    SET_GCODE_VARIABLE MACRO=TROCA VARIABLE=skip_filamento VALUE=False
    SET_GCODE_VARIABLE MACRO=TROCA VARIABLE=skip_move VALUE=False
    RESPOND PREFIX="INFO" MSG="‚úÖ Calibra√ß√£o conclu√≠da. Execute CALCULAR_OFFSETS para recalcular se necess√°rio."
    CALCULAR_OFFSETS
[gcode_macro _SALVAR_Z_PROBE]
description: Salva o valor atual de Z ap√≥s probe
gcode:
    {% set z_result = printer.probe.last_z_result %}
    SAVE_VARIABLE VARIABLE={params.VARIAVEL} VALUE={z_result}
    RESPOND PREFIX="INFO" MSG="üìè {params.VARIAVEL} salva: Z={z_result|round(6)}"

[gcode_macro CALCULAR_OFFSETS]
description: L√™ valores de ref0, ref1, ref2, ref3 e calcula/salva os offsets Z para T1 e T2 em rela√ß√£o a T0
gcode:
    # Exibir mensagem inicial
    RESPOND PREFIX="INFO" MSG="üîß Iniciando c√°lculo dos offsets Z..."

    # Carregar valores salvos
    {% set ref0 = printer["save_variables"].variables.ref0|float|default(0.0) %}
    {% set ref1 = printer["save_variables"].variables.ref1|float|default(0.0) %}
    {% set ref2 = printer["save_variables"].variables.ref2|float|default(0.0) %}
    {% set ref3 = printer["save_variables"].variables.ref3|float|default(0.0) %}

    RESPOND PREFIX="INFO" MSG="üìä Valores carregados - T0: {ref0|round(6)} | T1: {ref1|round(6)} | T2: {ref2|round(6)}| T3: {ref3|round(6)}"

    # Calcular offsets
    {% set tool_0_offset = (ref1 - ref0)|float %}
    {% set tool_1_offset = (ref2 - ref0)|float %}
    {% set tool_2_offset = (ref3 - ref0)|float %}
    RESPOND PREFIX="INFO" MSG="üìä Offsets calculados - tool_0_offset_z={tool_0_offset|round(6)}, tool_1_offset_z={tool_1_offset|round(6)}, tool_2_offset_z={tool_2_offset|round(6)}"

    # Salvar offsets
    SAVE_VARIABLE VARIABLE=tool_0_offset_z VALUE="{tool_0_offset}"
    SAVE_VARIABLE VARIABLE=tool_1_offset_z VALUE="{tool_1_offset}"
    SAVE_VARIABLE VARIABLE=tool_2_offset_z VALUE="{tool_2_offset}"
    
    RESPOND PREFIX="INFO" MSG="üìä Offsets salvos - tool_0_offset_z={tool_0_offset|round(6)}, tool_1_offset_z={tool_1_offset|round(6)}, tool_2_offset_z={tool_2_offset|round(6)}"

    # Exibir mensagem final
    RESPOND PREFIX="INFO" MSG="‚úÖ C√°lculo e salvamento dos offsets conclu√≠dos."


[gcode_macro TESTAR_OFFSETS]
description: Testa os offsets Z das extrusoras T0, T1 e T2 imprimindo linhas finas
gcode:
    # Exibir mensagem inicial
    RESPOND PREFIX="INFO" MSG="üß™ Iniciando teste dos offsets Z..."

    # Homing para garantir posi√ß√£o inicial
    G28
    G90
    RESPOND PREFIX="INFO" MSG="üè† Homing conclu√≠do."

    # Carregar offsets do variables.cfg
    {% set tool_0_offset = printer["save_variables"].variables.tool_0_offset_z|float|default(0.0) %}
    {% set tool_1_offset = printer["save_variables"].variables.tool_1_offset_z|float|default(0.0) %}
    {% set tool_2_offset = printer["save_variables"].variables.tool_2_offset_z|float|default(0.0) %}
    
    RESPOND PREFIX="INFO" MSG="üìä Offsets carregados - T1: {tool_0_offset|round(6)}, T2: {tool_1_offset|round(6)}, T3: {tool_2_offset|round(6)}"

    # Configura√ß√µes iniciais
    SET_GCODE_OFFSET Z=0
    M106 S255 ; Liga o ventilador (ajuste conforme necess√°rio)
    M190 S60  ; Aquecer a cama a 60¬∞C (ajuste para seu filamento)
    RESPOND PREFIX="INFO" MSG="üî• Aquecendo cama e bicos..."

    # T0 - Imprimir linha
    T0
    M109 S200 ; Aquecer T0 a 200¬∞C (ajuste para seu filamento)
    G1 X50 Y50 Z10 F10000 ; Mover para posi√ß√£o inicial
    SET_GCODE_OFFSET Z=0
    RESPOND PREFIX="INFO" MSG="üñ®Ô∏è Imprimindo linha com T0...")
    G1 Z0.2 F1000 ; Mover para altura da camada (0.2 mm)
    G1 X100 Y50 F1500 E2 ; Imprimir linha de 50 mm (extrus√£o ajustada)
    G1 Z10 F1000 ; Levantar bico

    # T1 - Imprimir linha com offset
    T1
    M109 S200 ; Aquecer T1 a 200¬∞C (ajuste para seu filamento)
    G1 X50 Y60 Z10 F10000 ; Mover para posi√ß√£o inicial (deslocado em Y)
    SET_GCODE_OFFSET Z={tool_0_offset}
    RESPOND PREFIX="INFO" MSG="üñ®Ô∏è Imprimindo linha com T1 (offset Z={tool_0_offset|round(6)})...")
    G1 Z0.2 F1000 ; Mover para altura da camada
    G1 X100 Y60 F1500 E2 ; Imprimir linha de 50 mm
    G1 Z10 F1000 ; Levantar bico

    # T2 - Imprimir linha com offset
    T2
    M109 S200 ; Aquecer T2 a 200¬∞C (ajuste para seu filamento)
    G1 X50 Y70 Z10 F10000 ; Mover para posi√ß√£o inicial (deslocado em Y)
    SET_GCODE_OFFSET Z={tool_1_offset}
    RESPOND PREFIX="INFO" MSG="üñ®Ô∏è Imprimindo linha com T2 (offset Z={tool_1_offset|round(6)})...")
    G1 Z0.2 F1000 ; Mover para altura da camada
    G1 X100 Y70 F1500 E2 ; Imprimir linha de 50 mm
    G1 Z10 F1000 ; Levantar bico

    # Finalizar
    T0
    M104 S0 ; Desligar bicos
    M140 S0 ; Desligar cama
    M106 S0 ; Desligar ventilador
    G1 X0 Y0 Z50 F10000 ; Mover para posi√ß√£o inicial
    RESPOND PREFIX="INFO" MSG="‚úÖ Teste conclu√≠do. Inspecione as linhas para verificar o alinhamento Z."