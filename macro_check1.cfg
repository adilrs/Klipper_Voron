#####################################################################
#                    MACRO CHECK1 - SONDAGEM SIMPLES               #
#####################################################################
# Macro para teste de sondagem com sensor de toque
# Posição: X320 Y100
# Altura inicial: Z6mm
# Sensor: host:gpio22 (chaveia para 0V quando tocado)
#####################################################################

[gcode_macro CHECK1]
description: Simple probing test at specified position (default: X320 Y100 Z6mm)
# Descrição: Teste de sondagem simples na posição especificada (padrão: X320 Y100 Z6mm)
variable_toque_detectado: 0
variable_posicao_toque: 0.0
gcode:
    # Parâmetros configuráveis (defaults: valores originais)
    {% set X_POS = params.X|default(320)|float %}
    {% set Y_POS = params.Y|default(100)|float %}
    {% set Z_INICIAL = params.Z|default(6.0)|float %}
    {% set LIMITE_MINIMO = params.LIMITE|default(0.5)|float %}
    {% set SPEED = params.SPEED|default(300)|float %}  # Velocidade de descida (mm/min)

    # Verificar se impressora está em home
    {% if not 'xyz' in printer.toolhead.homed_axes %}
        RESPOND MSG="[CHECK1][ERRO] Impressora não está em home. Execute G28 primeiro."
        {action_raise_error("Impressora não está em home")}
    {% endif %}

    # Verificar limites da cama
    {% if X_POS < printer.toolhead.axis_minimum.x or X_POS > printer.toolhead.axis_maximum.x or
          Y_POS < printer.toolhead.axis_minimum.y or Y_POS > printer.toolhead.axis_maximum.y %}
        RESPOND MSG="[CHECK1][ERRO] Posição X{Y_POS} Y{Y_POS} fora dos limites da cama!"
        {action_raise_error("Posição fora dos limites")}
    {% endif %}

    RESPOND MSG="[CHECK1] Iniciando sondagem em X{X_POS} Y{Y_POS} Z{Z_INICIAL}mm..."

    # Posicionar para sondagem
    G90  # Coordenadas absolutas
    G1 X{X_POS} Y{Y_POS} F5000  # Move para posição XY
    G1 Z{Z_INICIAL} F1500       # Move para altura inicial

    # Verificar estado inicial do sensor
    QUERY_PROBE
    {% set estado_inicial = printer.probe.last_query %}
    RESPOND MSG="[CHECK1][SENSOR] Estado inicial: {estado_inicial} (1=livre, 0=tocado)"

    {% if estado_inicial == 0 %}
        RESPOND MSG="[CHECK1][ERRO] Sensor já está tocado! Libere o sensor antes de iniciar."
        {action_raise_error("Sensor já está tocado")}
    {% endif %}

    # Executar sondagem
    RESPOND MSG="[CHECK1] Descendo para sondagem..."
    PROBE Z_MIN={LIMITE_MINIMO} SPEED={SPEED/60}  # Converte mm/min para mm/s
    {% set posicao_atual = printer.probe.last_z %}

    # Verificar resultado da sondagem
    {% if printer.probe.last_query == 0 %}
        SET_GCODE_VARIABLE MACRO=CHECK1 VARIABLE=toque_detectado VALUE=1
        SET_GCODE_VARIABLE MACRO=CHECK1 VARIABLE=posicao_toque VALUE={posicao_atual}
        RESPOND MSG="[CHECK1][SUCESSO] Toque detectado em Z={posicao_atual|round(4)}mm"
        G1 Z{posicao_atual + 2} F1500  # Subir para posição segura
    {% else %}
        SET_GCODE_VARIABLE MACRO=CHECK1 VARIABLE=toque_detectado VALUE=0
        RESPOND MSG="[CHECK1][FALHA] Toque não detectado até Z={LIMITE_MINIMO}mm"
        G1 Z5 F1500  # Subir para posição segura
    {% endif %}

# DELAYED_GCODE - PROCESSO DE SONDAGEM INCREMENTAL
[delayed_gcode processo_sondagem_check1]
gcode:
    # Verificar se sondagem ainda está ativa
    {% if printer['gcode_macro CHECK1'].sondagem_ativa == 1 %}
        {% set iteracao = printer['gcode_macro CHECK1'].iteracao_atual %}
        {% set max_iter = printer['gcode_macro CHECK1'].max_iteracoes %}
        {% set posicao_z = printer['gcode_macro CHECK1'].posicao_z_atual %}
        {% set limite_min = printer['gcode_macro CHECK1'].limite_minimo %}
        {% set incremento = printer['gcode_macro CHECK1'].incremento %}
        {% set estado_inicial = printer['gcode_macro CHECK1'].estado_inicial_sensor %}
        
        # Verificar se atingiu máximo de iterações
        {% if iteracao >= max_iter %}
            UPDATE_DELAYED_GCODE ID=processo_sondagem_check1 DURATION=0
            RESPOND MSG="[TIMEOUT] Máximo de iterações atingido"
            RESPOND MSG="[FALHA] Toque não detectado!"
            G1 Z5 F1500  # Subir para posição segura
            SET_GCODE_VARIABLE MACRO=CHECK1 VARIABLE=sondagem_ativa VALUE=0
        {% elif posicao_z < limite_min %}
            UPDATE_DELAYED_GCODE ID=processo_sondagem_check1 DURATION=0
            RESPOND MSG="[ERRO] Limite mínimo atingido (Z={limite_min}mm)"
            RESPOND MSG="[FALHA] Toque não detectado!"
            G1 Z5 F1500  # Subir para posição segura
            SET_GCODE_VARIABLE MACRO=CHECK1 VARIABLE=sondagem_ativa VALUE=0
        {% else %}
            # Descer incrementalmente
            G1 Z{posicao_z} F300
            M400  # Aguardar conclusão do movimento
            RESPOND MSG="[DESCENDO] Z={posicao_z|round(4)}mm (Iteração {iteracao + 1}/{max_iter})"
            
            # Atualizar e verificar sensor
            ATUALIZAR_SENSOR_TOQUE_HOST
            {% set sensor_state = printer['gcode_macro SENSOR_TOQUE_HOST'].sensor_ativo %}
            {% set estado_inicial = printer['gcode_macro CHECK1'].estado_inicial_sensor %}
            RESPOND MSG="[DEBUG] Estado sensor: {sensor_state}, Estado inicial: {estado_inicial}"
            
            # Verificar se toque foi detectado (sensor em estado LOW)
            {% if sensor_state == 0 %}
                # Toque detectado!
                {% set posicao_atual = printer.toolhead.position.z %}
                # Parar delayed_gcode imediatamente
                UPDATE_DELAYED_GCODE ID=processo_sondagem_check1 DURATION=0
                
                SET_GCODE_VARIABLE MACRO=CHECK1 VARIABLE=toque_detectado VALUE=1
                SET_GCODE_VARIABLE MACRO=CHECK1 VARIABLE=posicao_toque VALUE={posicao_atual}
                SET_GCODE_VARIABLE MACRO=CHECK1 VARIABLE=sondagem_ativa VALUE=0
                
                RESPOND MSG="[TOQUE DETECTADO] Sensor LOW - Z={posicao_atual|round(4)}mm"
                RESPOND MSG="[ALTURA DO TOQUE] {posicao_atual|round(4)}mm"
                RESPOND MSG="[SUCESSO] Sondagem concluída - processo parado!"
                
                # Subir para posição segura
                G1 Z{posicao_atual + 2} F1500
                RESPOND MSG="[SEGURO] Subiu para Z={posicao_atual + 2|round(4)}mm"
            {% else %}
                # Continuar sondagem - atualizar variáveis para próxima iteração
                {% set nova_posicao_z = posicao_z - incremento %}
                {% set nova_iteracao = iteracao + 1 %}
                SET_GCODE_VARIABLE MACRO=CHECK1 VARIABLE=posicao_z_atual VALUE={nova_posicao_z}
                SET_GCODE_VARIABLE MACRO=CHECK1 VARIABLE=iteracao_atual VALUE={nova_iteracao}
                
                # Agendar próxima verificação
                UPDATE_DELAYED_GCODE ID=processo_sondagem_check1 DURATION=0.2
            {% endif %}
        {% endif %}
    {% endif %}

    {% endif %}
#####################################################################
#                    SENSOR DE TOQUE HOST GPIO22                   #
#####################################################################
# Configuração do sensor de toque no host GPIO22
# Estado normal: 1 (3.3V)
# Estado tocado: 0 (0V)
#####################################################################

[gcode_macro SENSOR_TOQUE_HOST]
description: Monitoramento do sensor de toque host:gpio22
variable_sensor_ativo: 1  # Estado inicial (não tocado)
gcode:
    # Esta macro será atualizada pelo sistema de monitoramento
    RESPOND MSG="[SENSOR] Estado atual: {printer['gcode_macro SENSOR_TOQUE_HOST'].sensor_ativo}"

[gcode_macro ATUALIZAR_SENSOR_TOQUE_HOST]
description: Atualiza o estado do sensor lendo o GPIO atual
gcode:
    # Força a leitura do estado atual do GPIO
    # O estado é automaticamente atualizado pelos press_gcode/release_gcode
    # Esta macro serve para garantir sincronia durante a sondagem
    {% set estado_atual = printer['gcode_macro SENSOR_TOQUE_HOST'].sensor_ativo %}
    RESPOND MSG="[SENSOR_UPDATE] Estado: {estado_atual}"

[gcode_macro TESTAR_SENSOR_MANUAL]
description: Manually tests the probe sensor state
# Descrição: Testa manualmente o estado do sensor de sondagem
gcode:
    RESPOND MSG="[TESTE] Iniciando teste manual do sensor..."
    QUERY_PROBE
    {% set estado_sensor = printer.probe.last_query %}
    RESPOND MSG="[TESTE] Estado atual do sensor: {estado_sensor}"
    {% if estado_sensor == 1 %}
        RESPOND MSG="[TESTE] Sensor em estado NORMAL (3.3V - não tocado)"
    {% else %}
        RESPOND MSG="[TESTE] Sensor em estado TOCADO (0V - acionado)"
    {% endif %}
    RESPOND MSG="[TESTE] Pressione o sensor e execute novamente para verificar mudança"
# MACRO AUXILIAR REMOVIDA - Agora usa delayed_gcode para controle de fluxo

# Configuração do botão/sensor no host
[gcode_button sensor_toque_gpio22]
pin: ^!host:gpio22  # Pull-up interno habilitado, lógica invertida
press_gcode:
    # Sensor tocado (transição para LOW devido à lógica invertida)
    SET_GCODE_VARIABLE MACRO=SENSOR_TOQUE_HOST VARIABLE=sensor_ativo VALUE=0
    RESPOND MSG="[SENSOR] TOQUE DETECTADO (LOW)"
    RESPOND MSG="[DEBUG] Press event triggered"
release_gcode:
    # Sensor liberado (transição para HIGH devido à lógica invertida)
    SET_GCODE_VARIABLE MACRO=SENSOR_TOQUE_HOST VARIABLE=sensor_ativo VALUE=1
    RESPOND MSG="[SENSOR] TOQUE LIBERADO (HIGH)"
    RESPOND MSG="[DEBUG] Release event triggered"

#####################################################################
#                    MACRO CHECK - SEQUÊNCIA COMPLETA              #
#####################################################################

[gcode_macro CHECK]
description: Executes complete probing sequence for all tools and calculates differences
# Descrição: Executa sequência completa de sondagem para todas as ferramentas e calcula diferenças
variable_ref_t0: 0.0
variable_ref_t1: 0.0
variable_ref_t2: 0.0
variable_erro_calibracao: 0
gcode:
    RESPOND MSG="[CHECK] Iniciando sequência completa com todas as ferramentas..."
    SET_GCODE_VARIABLE MACRO=CHECK VARIABLE=erro_calibracao VALUE=0

    # Passo 1: Home da impressora
    G28  # Usa BLTouch para homing
    RESPOND MSG="[CHECK] Homing concluído."

    # FERRAMENTA T0
    RESPOND MSG="[CHECK] === TESTANDO FERRAMENTA T0 ==="
    T0
    CHECK1
    {% if printer['gcode_macro CHECK1'].toque_detectado == 1 %}
        SET_GCODE_VARIABLE MACRO=CHECK VARIABLE=ref_t0 VALUE={printer['gcode_macro CHECK1'].posicao_toque}
        RESPOND MSG="[CHECK] T0 - Resultado: {printer['gcode_macro CHECK1'].posicao_toque|round(4)}mm"
    {% else %}
        SET_GCODE_VARIABLE MACRO=CHECK VARIABLE=erro_calibracao VALUE=1
        RESPOND MSG="[CHECK][ERRO] T0 falhou na detecção!"
    {% endif %}

    # FERRAMENTA T1
    {% if printer['gcode_macro CHECK'].erro_calibracao == 0 %}
        RESPOND MSG="[CHECK] === TESTANDO FERRAMENTA T1 ==="
        T1
        CHECK1
        {% if printer['gcode_macro CHECK1'].toque_detectado == 1 %}
            SET_GCODE_VARIABLE MACRO=CHECK VARIABLE=ref_t1 VALUE={printer['gcode_macro CHECK1'].posicao_toque}
            RESPOND MSG="[CHECK] T1 - Resultado: {printer['gcode_macro CHECK1'].posicao_toque|round(4)}mm"
        {% else %}
            SET_GCODE_VARIABLE MACRO=CHECK VARIABLE=erro_calibracao VALUE=1
            RESPOND MSG="[CHECK][ERRO] T1 falhou na detecção!"
        {% endif %}
    {% endif %}

    # FERRAMENTA T2
    {% if printer['gcode_macro CHECK'].erro_calibracao == 0 %}
        RESPOND MSG="[CHECK] === TESTANDO FERRAMENTA T2 ==="
        T2
        CHECK1
        {% if printer['gcode_macro CHECK1'].toque_detectado == 1 %}
            SET_GCODE_VARIABLE MACRO=CHECK VARIABLE=ref_t2 VALUE={printer['gcode_macro CHECK1'].posicao_toque}
            RESPOND MSG="[CHECK] T2 - Resultado: {printer['gcode_macro CHECK1'].posicao_toque|round(4)}mm"
        {% else %}
            SET_GCODE_VARIABLE MACRO=CHECK VARIABLE=erro_calibracao VALUE=1
            RESPOND MSG="[CHECK][ERRO] T2 falhou na detecção!"
        {% endif %}
    {% endif %}

    # Resultados finais
    {% if printer['gcode_macro CHECK'].erro_calibracao == 0 %}
        {% set diff_t0_t1 = printer['gcode_macro CHECK'].ref_t0 - printer['gcode_macro CHECK'].ref_t1 %}
        {% set diff_t0_t2 = printer['gcode_macro CHECK'].ref_t0 - printer['gcode_macro CHECK'].ref_t2 %}
        RESPOND MSG="========================================"
        RESPOND MSG="         RESULTADOS FINAIS"
        RESPOND MSG="========================================"
        RESPOND MSG="T0: {printer['gcode_macro CHECK'].ref_t0|round(4)}mm"
        RESPOND MSG="T1: {printer['gcode_macro CHECK'].ref_t1|round(4)}mm"
        RESPOND MSG="T2: {printer['gcode_macro CHECK'].ref_t2|round(4)}mm"
        RESPOND MSG="DIFERENÇAS:"
        RESPOND MSG="T0 - T1: {diff_t0_t1|round(4)}mm"
        RESPOND MSG="T0 - T2: {diff_t0_t2|round(4)}mm"
        RESPOND MSG="========================================"
        RESPOND MSG="[CHECK] Calibração completa finalizada!"
    {% else %}
        RESPOND MSG="========================================"
        RESPOND MSG="      CALIBRAÇÃO INTERROMPIDA"
        RESPOND MSG="========================================"
        RESPOND MSG="[CHECK] Erro detectado. Verifique o sensor e tente novamente."
    {% endif %}

#####################################################################
#                    MACRO DE CANCELAMENTO                         #
#####################################################################

[gcode_macro ALTURA_TOQUE_CHECK1]
description: Returns the height where the last CHECK1 probe detected a touch
# Descrição: Retorna a altura onde a última sondagem CHECK1 detectou o toque
gcode:
    {% set macro = printer['gcode_macro CHECK1'] %}
    {% if macro.toque_detectado == 1 %}
        RESPOND MSG="[CHECK1][ALTURA TOQUE] {macro.posicao_toque|round(4)}mm"
        {action_respond_info("Altura do toque: " + (macro.posicao_toque|round(4)|string) + "mm")}
    {% else %}
        RESPOND MSG="[CHECK1][ERRO] Nenhum toque detectado na última sondagem"
        {action_respond_info("Nenhum toque detectado")}
    {% endif %}

[gcode_macro CANCELAR_CHECK1]
description: Cancels an ongoing CHECK1 probe
# Descrição: Cancela uma sondagem CHECK1 em andamento
gcode:
    RESPOND MSG="[CHECK1][CANCELAR] Parando sondagem..."
    G1 Z10 F3000  # Subir para posição segura
    SET_GCODE_VARIABLE MACRO=CHECK1 VARIABLE=toque_detectado VALUE=0
    SET_GCODE_VARIABLE MACRO=CHECK1 VARIABLE=posicao_toque VALUE=0.0
    RESPOND MSG="[CHECK1][CANCELADO] Sondagem cancelada"



[gcode_macro CANCELAR_CHECK1]
description: Cancela a sondagem CHECK1 em andamento
gcode:
    RESPOND MSG="[CANCELAR] Parando sondagem CHECK1..."
    
    # Parar delayed_gcode
    UPDATE_DELAYED_GCODE ID=processo_sondagem_check1 DURATION=0
    
    # Reset das variáveis
    SET_GCODE_VARIABLE MACRO=CHECK1 VARIABLE=toque_detectado VALUE=0
    SET_GCODE_VARIABLE MACRO=CHECK1 VARIABLE=posicao_toque VALUE=0.0
    SET_GCODE_VARIABLE MACRO=CHECK1 VARIABLE=sondagem_ativa VALUE=0
    SET_GCODE_VARIABLE MACRO=CHECK1 VARIABLE=iteracao_atual VALUE=0
    
    # Subir para posição segura
    G1 Z10 F3000
    RESPOND MSG="[CANCELADO] Sondagem CHECK1 cancelada"