# =============================================================================
# SISTEMA DE CALIBRAÃ‡ÃƒO AUTOMÃTICA DE FERRAMENTAS USANDO PROBE
# =============================================================================
# 
# Este sistema usa o comando PROBE nativo do Klipper para medir automaticamente
# os offsets Z das ferramentas T0, T1, T2 na mesma posiÃ§Ã£o e gravar no variables.cfg
#
# FUNCIONAMENTO:
# 1. Mede T0 como referÃªncia (offset = 0)
# 2. Mede T1 e T2 na mesma posiÃ§Ã£o
# 3. Calcula offsets relativos a T0
# 4. Grava automaticamente no variables.cfg
# =============================================================================

# NOTA: Usa a configuraÃ§Ã£o [probe] existente do BLTouch no printer.cfg
# NÃ£o Ã© necessÃ¡rio redefinir o probe - ele compartilha automaticamente o sensor_pin

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# CONFIGURAÃ‡Ã•ES GLOBAIS - EDITAR AQUI PARA ALTERAR COORDENADAS
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

[gcode_macro _PROBE_CONFIG]
variable_probe_x: 320      # Coordenada X do ponto de mediÃ§Ã£o
variable_probe_y: 98      # Coordenada Y do ponto de mediÃ§Ã£o  
variable_probe_z: 6        # Altura Z inicial para movimentaÃ§Ã£o
variable_safe_z: 10        # Altura Z de seguranÃ§a
gcode:
    # Esta macro apenas armazena as variÃ¡veis - nÃ£o executa cÃ³digo

[gcode_macro PROBE_SEGURO]
description: Executa probe com estabilizaÃ§Ã£o, mediÃ§Ã£o e reset seguro do BLTouch
gcode:
    RESPOND PREFIX="INFO" MSG="ğŸ” Probe SEGURO"
    SET_GCODE_OFFSET Z=0
    G4 P1000                        # Aguarda estabilizaÃ§Ã£o
    PROBE                           # Executa mediÃ§Ã£o

     
    PROBE PROBE_SPEED=8 LIFT_SPEED=15
    G1 Z5 F6000   ; Retrai um pouco
   # BLTOUCH_DEBUG COMMAND=reset     # Retrai o BLTouch
    # Segundo probe lento
   
    PROBE PROBE_SPEED=2 SAMPLES=3 SAMPLE_RETRACT_DIST=2.0
    G1 Z5 F6000   ; Retrai um pouco
  #  BLTOUCH_DEBUG COMMAND=reset     # Retrai o BLTouch
    RESPOND PREFIX="INFO" MSG="ğŸ” Probe executado com seguranÃ§a - Z medido: {printer.probe.last_z_result|round(6)}"

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# CONFIGURAÃ‡ÃƒO DE POSIÃ‡ÃƒO DE MEDIÃ‡ÃƒO
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# COORDENADAS CONFIGURÃVEIS: Definidas na macro _PROBE_CONFIG acima
# Para alterar as coordenadas, edite as variÃ¡veis na seÃ§Ã£o CONFIGURAÃ‡Ã•ES GLOBAIS
# PadrÃ£o atual: X=320, Y=100, Z=6 (ponto Ãºnico de referÃªncia)
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

# =============================================================================
# MACROS DE CALIBRAÃ‡ÃƒO AUTOMÃTICA
# =============================================================================

[gcode_macro CALIBRAR_FERRAMENTAS_AUTO]
description: Calibra automaticamente os offsets Z de todas as ferramentas
variable_z_t0_temp: 0.0
variable_z_t1_temp: 0.0
variable_z_t2_temp: 0.0
gcode:
    # Obter coordenadas das configuraÃ§Ãµes globais
    {% set config = printer['gcode_macro _PROBE_CONFIG'] %}
    {% set probe_x = params.X|default(config.probe_x)|float %}
    {% set probe_y = params.Y|default(config.probe_y)|float %}
    {% set probe_z = params.Z|default(config.probe_z)|float %}
    
    RESPOND PREFIX="INFO" MSG="ğŸ”§ Iniciando calibraÃ§Ã£o automÃ¡tica das ferramentas..."
    RESPOND PREFIX="INFO" MSG="ğŸ“ PosiÃ§Ã£o de mediÃ§Ã£o: X{probe_x} Y{probe_y} Z{probe_z}"
    
    # VerificaÃ§Ãµes iniciais
    {% if not printer.toolhead.homed_axes %}
        RESPOND PREFIX="ERROR" MSG="âŒ Impressora nÃ£o estÃ¡ em home! Execute G28 primeiro."
        { action_raise_error("Impressora nÃ£o estÃ¡ em home") }
    {% endif %}
    
    # Medir T0 (referÃªncia)
    RESPOND PREFIX="INFO" MSG="ğŸ” Medindo ferramenta T0 (referÃªncia)..."
    TOOLx_OFFSET TOOL=0 PROBE=1
    SET_GCODE_VARIABLE MACRO=CALIBRAR_FERRAMENTAS_AUTO VARIABLE=z_t0_temp VALUE={printer.probe.last_z_result}
    RESPOND PREFIX="INFO" MSG="ğŸ“ T0 medido: Z={printer.probe.last_z_result|round(6)}"
    
    # Medir T1
    RESPOND PREFIX="INFO" MSG="ğŸ” Medindo ferramenta T1..."
    TOOLx_OFFSET TOOL=1 PROBE=1
    SET_GCODE_VARIABLE MACRO=CALIBRAR_FERRAMENTAS_AUTO VARIABLE=z_t1_temp VALUE={printer.probe.last_z_result}
    {% set offset_t1 = printer.probe.last_z_result - printer['gcode_macro CALIBRAR_FERRAMENTAS_AUTO'].z_t0_temp %}
    RESPOND PREFIX="INFO" MSG="ğŸ“ T1 medido: Z={printer.probe.last_z_result|round(6)}, Offset: {offset_t1|round(6)}"
    SAVE_VARIABLE VARIABLE=tool_0_offset_z VALUE={offset_t1}
    
    # Medir T2
    RESPOND PREFIX="INFO" MSG="ğŸ” Medindo ferramenta T2..."
    TOOLx_OFFSET TOOL=2 PROBE=1
    SET_GCODE_VARIABLE MACRO=CALIBRAR_FERRAMENTAS_AUTO VARIABLE=z_t2_temp VALUE={printer.probe.last_z_result}
    {% set offset_t2 = printer.probe.last_z_result - printer['gcode_macro CALIBRAR_FERRAMENTAS_AUTO'].z_t0_temp %}
    RESPOND PREFIX="INFO" MSG="ğŸ“ T2 medido: Z={printer.probe.last_z_result|round(6)}, Offset: {offset_t2|round(6)}"
    SAVE_VARIABLE VARIABLE=tool_1_offset_z VALUE={offset_t2}
    
    # Aplicar offsets imediatamente
    SET_GCODE_OFFSET Z=0.0  # Reset offset
    
    # Retornar para T0
    TOOLx_OFFSET TOOL=0 PROBE=0
    
    # RelatÃ³rio final
    RESPOND PREFIX="INFO" MSG="âœ… CalibraÃ§Ã£o concluÃ­da com sucesso!"
    RESPOND PREFIX="INFO" MSG="ğŸ“Š RESULTADOS:"
    RESPOND PREFIX="INFO" MSG="   T0 (referÃªncia): {printer['gcode_macro CALIBRAR_FERRAMENTAS_AUTO'].z_t0_temp|round(6)}"
    RESPOND PREFIX="INFO" MSG="   T1 medido: {printer['gcode_macro CALIBRAR_FERRAMENTAS_AUTO'].z_t1_temp|round(6)}, offset: {printer.save_variables.variables.tool_0_offset_z|default(0.0)|round(6)}"
    RESPOND PREFIX="INFO" MSG="   T2 medido: {printer['gcode_macro CALIBRAR_FERRAMENTAS_AUTO'].z_t2_temp|round(6)}, offset: {printer.save_variables.variables.tool_1_offset_z|default(0.0)|round(6)}"
    RESPOND PREFIX="INFO" MSG="ğŸ’¾ Offsets salvos: tool_0_offset_z e tool_1_offset_z"
    
    # Sistema otimizado - apenas offsets essenciais sÃ£o mantidos

[gcode_macro VERIFICAR_OFFSETS]
description: Verifica os offsets salvos no variables.cfg
gcode:
    {% set t0_offset = 0.0 %}  # T0 sempre Ã© referÃªncia
    {% set t1_offset = printer.save_variables.variables.tool_0_offset_z|default(0.0) %}
    {% set t2_offset = printer.save_variables.variables.tool_1_offset_z|default(0.0) %}
    
    RESPOND PREFIX="INFO" MSG="ğŸ“Š OFFSETS SALVOS:"
    RESPOND PREFIX="INFO" MSG="   T0: {t0_offset|round(6)}"
    RESPOND PREFIX="INFO" MSG="   T1: {t1_offset|round(6)}"
    RESPOND PREFIX="INFO" MSG="   T2: {t2_offset|round(6)}"
    
    # Sistema limpo - apenas offsets essenciais

[gcode_macro APLICAR_OFFSET_FERRAMENTA]
description: Aplica o offset Z da ferramenta ativa
gcode:
    {% set current_tool = printer.toolhead.extruder %}
    {% set offset = 0.0 %}
    
    {% if current_tool == "extruder" %}
        {% set offset = 0.0 %}  # T0 sempre Ã© referÃªncia
    {% elif current_tool == "extruder1" %}
        {% set offset = printer.save_variables.variables.tool_0_offset_z|default(0.0) %}
    {% elif current_tool == "extruder2" %}
        {% set offset = printer.save_variables.variables.tool_1_offset_z|default(0.0) %}
    {% endif %}
    
    SET_GCODE_OFFSET Z={offset}
    RESPOND PREFIX="INFO" MSG="ğŸ”§ Offset Z aplicado para {current_tool}: {offset|round(6)}"

[gcode_macro TESTE_PROBE_POSICAO]
description: Testa o probe na posiÃ§Ã£o especificada
gcode:
    {% set config = printer['gcode_macro _PROBE_CONFIG'] %}
    {% set probe_x = params.X|default(config.probe_x)|float %}
    {% set probe_y = params.Y|default(config.probe_y)|float %}
    {% set probe_z = params.Z|default(config.probe_z)|float %}
    
    RESPOND PREFIX="INFO" MSG="ğŸ” Testando probe na posiÃ§Ã£o X{probe_x} Y{probe_y} Z{probe_z}"
    G90
    PROBE_SEGURO
        
    {% if printer.probe is defined %}
        {% set result_z = printer.probe.last_z_result %}
        RESPOND PREFIX="INFO" MSG="ğŸ“ Resultado: Z={result_z|round(6)}"
    {% else %}
        RESPOND PREFIX="ERROR" MSG="âŒ Probe nÃ£o configurado - nÃ£o Ã© possÃ­vel obter resultado"
    {% endif %}

# =============================================================================
# MACROS DE TROCA DE FERRAMENTA COM OFFSET AUTOMÃTICO
# =============================================================================

[gcode_macro TOOLx_OFFSET]
description: Seleciona ferramenta e aplica offset (parÃ¢metro TOOL=0,1,2)
gcode:
    {% set tool_num = params.TOOL|default(0)|int %}
    
    {% if tool_num == 0 %}
        T0  # Troca fÃ­sica da ferramenta T0
        {% set tool_name = "T0" %}
        {% set offset = 0.0 %}  # T0 sempre Ã© referÃªncia
    {% elif tool_num == 1 %}
        T1  # Troca fÃ­sica da ferramenta T1
        {% set offset = printer.save_variables.variables.tool_0_offset_z|default(0.0) %}
        {% set tool_name = "T1" %}
    {% elif tool_num == 2 %}
        T2  # Troca fÃ­sica da ferramenta T2
        {% set offset = printer.save_variables.variables.tool_1_offset_z|default(0.0) %}
        {% set tool_name = "T2" %}
    {% else %}
        RESPOND PREFIX="ERROR" MSG="âŒ Ferramenta invÃ¡lida: {tool_num}. Use TOOL=0, 1 ou 2"
        {% set tool_name = "INVALID" %}
    {% endif %}
    SET_GCODE_OFFSET Z=0.0  # Reset offset
    {% if tool_name != "INVALID" %}
        # Posicionar na coordenada de mediÃ§Ã£o usando configuraÃ§Ãµes globais
        {% set config = printer['gcode_macro _PROBE_CONFIG'] %}
        {% set probe_x = config.probe_x %}
        {% set probe_y = config.probe_y %}
        {% set probe_z = config.probe_z %}
        G90  # Modo absoluto
        G0 X{probe_x} Y{probe_y} Z{probe_z} F3000
        
        # Executar mediÃ§Ã£o com probe se parÃ¢metro PROBE=1 for passado
        {% if params.PROBE|default(0)|int == 1 %}
            SET_GCODE_OFFSET Z=0.0  # Zerar offset Z antes da mediÃ§Ã£o
            PROBE_SEGURO  # Executa probe com todos os procedimentos de seguranÃ§a
            RESPOND PREFIX="INFO" MSG="ğŸ”§ {tool_name} ativada para MEDIÃ‡ÃƒO - offset Z zerado"
        {% else %}
            SET_GCODE_OFFSET Z={offset}
            RESPOND PREFIX="INFO" MSG="ğŸ”§ {tool_name} ativada, offset Z: {offset|round(6)}"
        {% endif %}
    {% endif %}

[gcode_macro TESTE_CALCULO_OFFSETS]
description: Testa o cÃ¡lculo de offsets com valores simulados (para debug)
gcode:
    RESPOND PREFIX="INFO" MSG="ğŸ§ª TESTE DE CÃLCULO DE OFFSETS"
    
    # Simular valores de mediÃ§Ã£o (apenas para cÃ¡lculo local)
    {% set z_t0 = 5.123 %}
    {% set z_t1 = 5.456 %}
    {% set z_t2 = 4.789 %}
    {% set offset_t1 = z_t1 - z_t0 %}
    {% set offset_t2 = z_t2 - z_t0 %}
    
    RESPOND PREFIX="INFO" MSG="ğŸ“ Valores simulados:"
    RESPOND PREFIX="INFO" MSG="   T0: {z_t0|round(6)}"
    RESPOND PREFIX="INFO" MSG="   T1: {z_t1|round(6)}"
    RESPOND PREFIX="INFO" MSG="   T2: {z_t2|round(6)}"
    RESPOND PREFIX="INFO" MSG="ğŸ“Š Offsets calculados:"
    RESPOND PREFIX="INFO" MSG="   T1: {offset_t1|round(6)}"
    RESPOND PREFIX="INFO" MSG="   T2: {offset_t2|round(6)}"
    
    # Salvar offsets finais
    SAVE_VARIABLE VARIABLE=tool_0_offset_z VALUE={offset_t1}
    SAVE_VARIABLE VARIABLE=tool_1_offset_z VALUE={offset_t2}
    
    RESPOND PREFIX="INFO" MSG="âœ… Teste concluÃ­do - execute VERIFICAR_OFFSETS para confirmar"

# =============================================================================
# INSTRUÃ‡Ã•ES DE USO
# =============================================================================
#
# CALIBRAÃ‡ÃƒO INICIAL:
# 1. Execute G28 para fazer home
# 2. Execute CALIBRAR_FERRAMENTAS_AUTO (usa coordenadas configuradas)
# 3. O sistema medirÃ¡ automaticamente T0, T1, T2 e salvarÃ¡ os offsets
#
# VERIFICAÃ‡ÃƒO:
# - VERIFICAR_OFFSETS: mostra os offsets salvos
# - TESTE_PROBE_POSICAO: testa o probe na posiÃ§Ã£o configurada
# - TESTE_CALCULO_OFFSETS: testa o cÃ¡lculo com valores simulados (debug)
#
# USO NORMAL:
# - T0, T1, T2: troca de ferramenta com aplicaÃ§Ã£o automÃ¡tica do offset
# - TOOLx_OFFSET TOOL=X: troca manual com offset aplicado
# - TOOLx_OFFSET TOOL=X PROBE=1: troca com mediÃ§Ã£o (offset Z zerado automaticamente)
# - Os offsets sÃ£o aplicados automaticamente a cada troca
#
# RECALIBRAÃ‡ÃƒO:
# - Execute CALIBRAR_FERRAMENTAS_AUTO novamente quando necessÃ¡rio
# - Os novos valores sobrescreverÃ£o os anteriores no variables.cfg
# - Durante mediÃ§Ãµes com probe, o offset Z Ã© automaticamente zerado
#
# SOLUÃ‡ÃƒO DE PROBLEMAS:
# - Se offsets saem como 0: problema corrigido com uso de variÃ¡veis temporÃ¡rias
# - Execute TESTE_CALCULO_OFFSETS para verificar se o cÃ¡lculo funciona
# - Verifique se o probe estÃ¡ funcionando corretamente
# =============================================================================