#############################################
# ‚öôÔ∏è INICIALIZA√á√ÉO
#############################################

[gcode_macro STARTUP]
gcode:
  {% set saved_tool = printer.save_variables.variables.tool|default(1)|int %}
  {% set show_t = saved_tool - 1 %}  # Para exibir T0..T2
  
  # Verificar presen√ßa de tool usando EXECUTA_ACOES (sensor de presen√ßa)
  VERIFICA_CONEXAO_TOOL ACAO=3 TOOL=0  # 3=verifica - verifica estado atual
  {% set tool_present = printer["gcode_macro EXECUTA_ACOES"].endstop_x|default(0)|int %}
  RESPOND PREFIX="INFO" MSG="üîç Verificando presen√ßa de tool (sensor: {tool_present})"
  
  # Com sensor ativo, verificar presen√ßa f√≠sica
  {% if tool_present == 1 %}
    RESPOND PREFIX="INFO" MSG="‚úÖ Tool detectada - restaurando estado salvo"
    SET_GCODE_VARIABLE MACRO=TOOL_STATE VARIABLE=tool VALUE={saved_tool}
    RESPOND PREFIX="INFO" MSG="üîÑ Estado restaurado: T{show_t} (TOOL={saved_tool})"
  {% else %}
    RESPOND PREFIX="WARNING" MSG="‚ö†Ô∏è Nenhuma tool detectada - aguardando comando manual"
    RESPOND PREFIX="INFO" MSG="üí° Sistema aguardando: Use T0, T1 ou T2 para carregar ferramenta"
    SET_GCODE_VARIABLE MACRO=TOOL_STATE VARIABLE=tool VALUE=0  # Estado vazio
    SAVE_VARIABLE VARIABLE=tool VALUE=0
    {% set saved_tool = 0 %}
    {% set show_t = "?" %}
    M117 Aguardando ferramenta...
    # N√£o aplicar offsets nem ativar extrusora - aguardar comando
    # Loop infinito para parar execu√ß√£o (substitui RETURN)
    {% for i in range(999999) %}
      G4 P1000  # Aguarda 1 segundo eternamente
    {% endfor %}
  {% endif %}
  
  M117 Sistema iniciando: T{show_t}
  
  # Carregar offsets Z
  INIT_TOOL_OFFSETS
  
  # Aguardar um momento para garantir que os valores foram carregados
  G4 P200
  
  # Ativar extrusora correta e aplicar offsets
  {% set vars = printer.save_variables.variables %}
  {% set extruders = {
    1: "extruder", 2: "extruder1", 3: "extruder2", 4: "extruder3"
  } %}
  
  {% if saved_tool == 1 %}
    # T0 sempre tem offset zero (refer√™ncia)
    ACTIVATE_EXTRUDER EXTRUDER=extruder
    SET_GCODE_OFFSET X=0.0 Y=0.0 Z=0.0
    RESPOND PREFIX="INFO" MSG="üéØ T0: Extruder ativado, offset ZERO aplicado (refer√™ncia BLTouch)"
  {% elif saved_tool == 2 %}
    # T1 - X/Y fixos do TOOL_DATA, Z direto do variables.cfg
    ACTIVATE_EXTRUDER EXTRUDER=extruder1
    {% set x = printer['gcode_macro TOOL_DATA']['offset_x2']|default(0)|float %}
    {% set y = printer['gcode_macro TOOL_DATA']['offset_y2']|default(0)|float %}
    {% set z = vars.get('tool_0_offset_z', 0.0)|float %}
    SET_GCODE_OFFSET X={x} Y={y} Z={z}
    RESPOND PREFIX="INFO" MSG="üéØ T1: Extruder1 ativado, offset aplicado X={x} Y={y} Z={z} (Z direto de variables.cfg)"
  {% elif saved_tool == 3 %}
    # T2 - X/Y fixos do TOOL_DATA, Z direto do variables.cfg
    ACTIVATE_EXTRUDER EXTRUDER=extruder2
    {% set x = printer['gcode_macro TOOL_DATA']['offset_x3']|default(0)|float %}
    {% set y = printer['gcode_macro TOOL_DATA']['offset_y3']|default(0)|float %}
    {% set z = vars.get('tool_1_offset_z', 0.0)|float %}
    SET_GCODE_OFFSET X={x} Y={y} Z={z}
    RESPOND PREFIX="INFO" MSG="üéØ T2: Extruder2 ativado, offset aplicado X={x} Y={y} Z={z} (Z direto de variables.cfg)"
  {% elif saved_tool == 4 %}
    # T3 - X/Y fixos do TOOL_DATA, Z direto do variables.cfg
    ACTIVATE_EXTRUDER EXTRUDER=extruder3
    {% set x = printer['gcode_macro TOOL_DATA']['offset_x4']|default(0)|float %}
    {% set y = printer['gcode_macro TOOL_DATA']['offset_y4']|default(0)|float %}
    {% set z = vars.get('tool_2_offset_z', 0.0)|float %}
    SET_GCODE_OFFSET X={x} Y={y} Z={z}
    RESPOND PREFIX="INFO" MSG="üéØ T3: Extruder3 ativado, offset aplicado X={x} Y={y} Z={z} (Z direto de variables.cfg)"
  {% elif saved_tool == 5 %}
    # T4 - X/Y fixos do TOOL_DATA, Z direto do variables.cfg
    ACTIVATE_EXTRUDER EXTRUDER=extruder4
    {% set x = printer['gcode_macro TOOL_DATA']['offset_x5']|default(0)|float %}
    {% set y = printer['gcode_macro TOOL_DATA']['offset_y5']|default(0)|float %}
    {% set z = vars.get('tool_3_offset_z', 0.0)|float %}
    SET_GCODE_OFFSET X={x} Y={y} Z={z}
    RESPOND PREFIX="INFO" MSG="üéØ T4: Extruder4 ativado, offset aplicado X={x} Y={y} Z={z} (Z direto de variables.cfg)"
  {% endif %} 
  
  RESPOND PREFIX="INFO" MSG="‚úÖ Sistema inicializado - T{show_t} ativa com extrusora e offsets corretos"
  M117 Sistema pronto - T{show_t} ativa

#############################################
# üñ®Ô∏è ROTINAS DE IMPRESS√ÉO
#############################################

[gcode_macro PRINT_START]
description: "In√≠cio autom√°tico da impress√£o"
gcode:
  PSU_ON_SAFE
  SAVE_VARIABLE VARIABLE=ignore_init_tool_check VALUE=True
  SET_VELOCITY_LIMIT ACCEL=1500 ACCEL_TO_DECEL=1500
  G28
  G29
  {% set start_tool = params.TOOL|default(params.START_TOOL|default(0))|int %}
  M117 Verificando ferramenta...
  G4 P1000
  
  # Verificar presen√ßa de tool usando EXECUTA_ACOES (sensor de presen√ßa)
  VERIFICA_CONEXAO_TOOL ACAO=3 TOOL=0  # 3=verifica - verifica estado atual
  {% set tool_present = printer["gcode_macro EXECUTA_ACOES"].endstop_x|default(0)|int %}
  RESPOND PREFIX="INFO" MSG="üîç Verificando presen√ßa de tool (sensor: {tool_present})"
  
  # L√≥gica de verifica√ß√£o de ferramenta
  {% if tool_present == 1 %}
    RESPOND PREFIX="INFO" MSG="‚úÖ Tool detectada - continuando"
  {% else %}
    RESPOND PREFIX="WARNING" MSG="‚ö†Ô∏è Nenhuma tool detectada - aguarde comando Tn do G-code"
    #PAUSE
  {% endif %}
  
  #Z_TILT_ADJUST
   # SET_GCODE_VARIABLE MACRO=G29 VARIABLE=mesh_done VALUE=True
  #BED_MESH_PROFILE LOAD=default
  G12
  
  M117 Impress√£o iniciada

[gcode_macro PRINT_END]
gcode:

  G91
  G1 Z10 x10 y10 F600
  G90
  SAVE_VARIABLE VARIABLE=ignore_init_tool_check VALUE=False
  M104 T0 S0
  M104 T1 S0
  M104 T2 S0
  M104 T3 S0
  M104 T4 S0
  M140 S0
  M106 S0
  #G28XY
  #DESCARREGAR
  G1 X0 Y200 F16000
  #M84
  M117 Fim da impress√£o 

#############################################
# üîÑ INICIALIZA√á√ÉO DO SISTEMA
#############################################

[gcode_macro STARTUP]
description: "Inicializa√ß√£o autom√°tica do sistema"
gcode:
  {% set saved_tool = printer.save_variables.variables.tool|default(1)|int %}
  {% set show_t = saved_tool - 1 %}  # Para exibir T0..T2
  
  # Verificar se LIDAR est√° ativo para detec√ß√£o f√≠sica
  {% if printer["gcode_macro LIDAR_MODE"].status %}
    {% set lidar = printer["gcode_macro DISTANCIA_VL53"].distancia|float %}
    RESPOND PREFIX="INFO" MSG="üîç LIDAR ativo - verificando presen√ßa f√≠sica (LIDAR: {lidar}mm)"
    
    # Com LIDAR ativo, verificar presen√ßa f√≠sica
    {% if lidar <= 110 %}
      RESPOND PREFIX="INFO" MSG="‚úÖ Ferramenta f√≠sica detectada - restaurando estado salvo"
      SET_GCODE_VARIABLE MACRO=TOOL_STATE VARIABLE=tool VALUE={saved_tool}
      RESPOND PREFIX="INFO" MSG="üîÑ Estado restaurado: T{show_t} (TOOL={saved_tool})"
    {% else %}
      RESPOND PREFIX="WARNING" MSG="‚ö†Ô∏è Nenhuma ferramenta f√≠sica detectada - aguardando comando manual"
      RESPOND PREFIX="INFO" MSG="üí° Sistema aguardando: Use T0, T1 ou T2 para carregar ferramenta"
      SET_GCODE_VARIABLE MACRO=TOOL_STATE VARIABLE=tool VALUE=0  # Estado vazio
      SAVE_VARIABLE VARIABLE=tool VALUE=0
      {% set saved_tool = 0 %}
      {% set show_t = "?" %}
      M117 Aguardando ferramenta...
      # N√£o aplicar offsets nem ativar extrusora - aguardar comando
      RETURN
    {% endif %}
  {% else %}
    # LIDAR desativado - confiar no estado salvo
    RESPOND PREFIX="INFO" MSG="üö´ LIDAR desativado - confiando no estado salvo"
    SET_GCODE_VARIABLE MACRO=TOOL_STATE VARIABLE=tool VALUE={saved_tool}
    RESPOND PREFIX="INFO" MSG="üîÑ Estado restaurado: T{show_t} (TOOL={saved_tool})"
    RESPOND PREFIX="WARNING" MSG="üí° Ative o LIDAR com 'LIDAR_ON' para detec√ß√£o f√≠sica"
  {% endif %}
  
  M117 Sistema iniciando: T{show_t}
  
  # Carregar offsets Z
  INIT_TOOL_OFFSETS

#############################################
# üîß UTILIT√ÅRIOS
#############################################

[gcode_macro WHOAMI]
gcode:
  {% if printer["gcode_macro TOOL_DATA"].debugativo %}
    RESPOND PREFIX="DEBUG" MSG="tool={printer['gcode_macro TOOL_STATE'].tool} active_extruder={printer.toolhead.extruder}"
  {% endif %}

[gcode_macro QUAL_EXTRUSORA]
gcode:
  {% if printer["gcode_macro TOOL_DATA"].debugativo %}
    {% set tool = printer["gcode_macro TOOL_STATE"].tool|int %}
    {% set ext = printer.toolhead.extruder %}
    RESPOND PREFIX="DEBUG" MSG="TOOL={tool} extruder={ext}"
  {% endif %}

[gcode_macro SET_PRESSURE_ADVANCE]
rename_existing: SET_PRESSURE_ADVANCE_ORIG
gcode:
  {% set adv = params.ADVANCE|default(printer["extruder_stepper belted_extruder"].pressure_advance)|float %}
  {% set st = params.SMOOTH_TIME|default(printer["extruder_stepper belted_extruder"].pressure_advance_smooth_time|default(0.2))|float %}
  SET_PRESSURE_ADVANCE_ORIG EXTRUDER=belted_extruder ADVANCE={adv} SMOOTH_TIME={st}
  {% if printer["gcode_macro TOOL_DATA"].debugativo %}
    RESPOND PREFIX="INFO" MSG="PA aplicado no belted_extruder: A={adv} ST={st}"
  {% endif %}

[gcode_macro M572]
gcode:
  {% set k = params.K|default(0)|float %}
  {% set s = params.S|default(0.2)|float %}
  SET_PRESSURE_ADVANCE ADVANCE={k} SMOOTH_TIME={s}

[gcode_macro G29]
description: "Nivelamento com salvamento autom√°tico, feito uma √∫nica vez por sess√£o"
variable_mesh_done: False
gcode:
    PSU_ON_SAFE
    {% set homed = printer.toolhead.homed_axes.upper() %}
    {% if 'X' in homed and 'Y' in homed and 'Z' in homed %}
        {% if printer["gcode_macro G29"].mesh_done %}
            M117 Mesh j√° carregado - pulando nivelamento
        {% else %}
            SET_GCODE_OFFSET X=0 Y=0 Z=0
            SAVE_GCODE_STATE NAME=mesh_state
            G91
            G1 Z10 F600
            G90
            M117 Iniciando nivelamento...
            BED_MESH_CALIBRATE MOVE_Z=8
            BED_MESH_PROFILE SAVE=default
            SET_GCODE_VARIABLE MACRO=G29 VARIABLE=mesh_done VALUE=True
            G91
            G1 Z10 F600
            G90
            RESTORE_GCODE_STATE NAME=mesh_state MOVE=1
            M117 Nivelamento salvo no perfil default
        {% endif %}
    {% else %}
        M117 Homing completo (G28) necess√°rio antes do G29
    {% endif %}
    APPLY_TOOL_OFFSET

[gcode_macro DEBUG_G29]
gcode:
  M117 STATUS G29

[gcode_macro FG29]
description: "For√ßa nivelamento: zera flag e executa G29"
gcode:
  SET_GCODE_VARIABLE MACRO=G29 VARIABLE=mesh_done VALUE=False
  RESPOND PREFIX="INFO" MSG="üîÑ For√ßando nivelamento (mesh_done=False)"
  G29

[output_pin motors_psu]
pin:host:gpio21
value: 1
shutdown_value: 1

[gcode_macro PSU_ON]
gcode:
  PSU_ON_SAFE

[gcode_macro PSU_OFF]
gcode:
  PSU_OFF_SAFE

[gcode_macro PSU_OFF_SAFE]
gcode:
  {% if printer.print_stats.state == "printing" %}
    RESPOND PREFIX="ERROR" MSG="N√£o √© seguro desligar a fonte durante a impress√£o"
    RETURN
  {% endif %}
  {% if not printer['gcode_macro PSU_STATE'].psu_on %}
    RESPOND MSG="Fonte j√° est√° desligada"
    RETURN
  {% endif %}
  {% if printer.extruder is defined %}SET_HEATER_TEMPERATURE HEATER=extruder TARGET=0{% endif %}
  {% if printer.extruder1 is defined %}SET_HEATER_TEMPERATURE HEATER=extruder1 TARGET=0{% endif %}
  {% if printer.extruder2 is defined %}SET_HEATER_TEMPERATURE HEATER=extruder2 TARGET=0{% endif %}
  {% if printer.extruder3 is defined %}SET_HEATER_TEMPERATURE HEATER=extruder3 TARGET=0{% endif %}
  {% if printer.heater_bed is defined %}SET_HEATER_TEMPERATURE HEATER=heater_bed TARGET=0{% endif %}
  {% set threshold = 100 %}
  {% if printer["gcode_macro PSU_STATE"] is defined %}
    {% set threshold = printer["gcode_macro PSU_STATE"].threshold|default(100)|int %}
  {% endif %}
  {% set hotends = [] %}
  {% if printer.extruder is defined %}{% set _ = hotends.append('extruder') %}{% endif %}
  {% if printer.extruder1 is defined %}{% set _ = hotends.append('extruder1') %}{% endif %}
  {% if printer.extruder2 is defined %}{% set _ = hotends.append('extruder2') %}{% endif %}
  {% if printer.extruder3 is defined %}{% set _ = hotends.append('extruder3') %}{% endif %}
  {% for h in hotends %}
    TEMPERATURE_WAIT SENSOR={h} MAXIMUM={threshold}
  {% endfor %}
  M84
  SET_TMC_CURRENT STEPPER=stepper_x CURRENT=0.01 HOLDCURRENT=0.01
  SET_TMC_CURRENT STEPPER=stepper_y CURRENT=0.01 HOLDCURRENT=0.01
  SET_TMC_CURRENT STEPPER=stepper_z CURRENT=0.01 HOLDCURRENT=0.01
  SET_TMC_CURRENT STEPPER=stepper_z1 CURRENT=0.01 HOLDCURRENT=0.01
  SET_TMC_CURRENT STEPPER=stepper_z2 CURRENT=0.01 HOLDCURRENT=0.01
  SET_TMC_CURRENT STEPPER=stepper_z3 CURRENT=0.01 HOLDCURRENT=0.01
  SET_PIN PIN=motors_psu VALUE=0
  SET_GCODE_VARIABLE MACRO=PSU_STATE VARIABLE=psu_on VALUE=False
  RESPOND MSG="Fonte desligada"

[gcode_macro PSU_ON_SAFE]
gcode:
  {% if not printer['gcode_macro PSU_STATE'].psu_on %}
    SET_PIN PIN=motors_psu VALUE=1
    SET_GCODE_VARIABLE MACRO=PSU_STATE VARIABLE=psu_on VALUE=True
    G4 P800
    INIT_TMC STEPPER=stepper_x
    INIT_TMC STEPPER=stepper_y
    INIT_TMC STEPPER=stepper_z
    INIT_TMC STEPPER=stepper_z1
    INIT_TMC STEPPER=stepper_z2
    INIT_TMC STEPPER=stepper_z3
    {% set s = printer.configfile.settings %}
    {% set x_run = s["tmc2209 stepper_x"].run_current|float %}
    {% set x_hold = s["tmc2209 stepper_x"].hold_current|float %}
    {% set y_run = s["tmc2209 stepper_y"].run_current|float %}
    {% set y_hold = s["tmc2209 stepper_y"].hold_current|float %}
    {% set z_run = s["tmc2209 stepper_z"].run_current|float %}
    {% set z_hold = s["tmc2209 stepper_z"].hold_current|float %}
    {% set z1_run = s["tmc2209 stepper_z1"].run_current|float %}
    {% set z1_hold = s["tmc2209 stepper_z1"].hold_current|float %}
    {% set z2_run = s["tmc2209 stepper_z2"].run_current|float %}
    {% set z2_hold = s["tmc2209 stepper_z2"].hold_current|float %}
    {% set z3_run = s["tmc2209 stepper_z3"].run_current|float %}
    {% set z3_hold = s["tmc2209 stepper_z3"].hold_current|float %}
    SET_TMC_CURRENT STEPPER=stepper_x CURRENT={x_run} HOLDCURRENT={x_hold}
    SET_TMC_CURRENT STEPPER=stepper_y CURRENT={y_run} HOLDCURRENT={y_hold}
    SET_TMC_CURRENT STEPPER=stepper_z CURRENT={z_run} HOLDCURRENT={z_hold}
    SET_TMC_CURRENT STEPPER=stepper_z1 CURRENT={z1_run} HOLDCURRENT={z1_hold}
    SET_TMC_CURRENT STEPPER=stepper_z2 CURRENT={z2_run} HOLDCURRENT={z2_hold}
    SET_TMC_CURRENT STEPPER=stepper_z3 CURRENT={z3_run} HOLDCURRENT={z3_hold}
    {% if 
    "tmc2209 manual_stepper trocador" in s %}
      INIT_TMC STEPPER=trocador
      {% set t_run = s["tmc2209 manual_stepper trocador"].run_current|float %}
      {% set t_hold = s["tmc2209 manual_stepper trocador"].hold_current|float %}
      SET_TMC_CURRENT STEPPER=trocador CURRENT={t_run} HOLDCURRENT={t_hold}
    {% endif %}
  {% endif %}

[gcode_macro PSU_STATE]
variable_off_pending: False
variable_cancel: False
variable_threshold: 100
variable_psu_on: True
gcode:

[gcode_macro M106]
gcode:
  {% set speed = params.S|default(255)|int %}
  {% set fan_speed = speed / 255.0 %}
  SET_FAN_SPEED fan=Print_Cooling SPEED={fan_speed}

[gcode_macro M107]
gcode:
  SET_FAN_SPEED fan=Print_Cooling SPEED=0.0

