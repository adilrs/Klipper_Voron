#Se quiser ainda um m√≠nimo (por exemplo, nunca descer abaixo de 150¬∞C), defina:
#- SET_GCODE_VARIABLE MACRO=TROCA VARIABLE=min_standby VALUE=150

[gcode_macro TOOL_DATA]
variable_debugativo: False
variable_z_antes: 0.0
variable_dist_tool: 67.5  # Ajustado para T4=279mm exato mantendo T0=9mm refer√™ncia
# üìç Posi√ß√µes f√≠sicas no dock
variable_dock_x1: 9.0
variable_dock_x2: 90.0
variable_dock_x3: 169.0
variable_dock_x4: 249.0
variable_dock_x5: 0.0

variable_standby_temp_T1: 170
variable_standby_temp_T2: 170
variable_standby_temp_T3: 170
variable_standby_temp_T4: 170

# üõ†Ô∏è Offsets da ferramenta T0~T3 (apenas X/Y - Z lido diretamente de variables.cfg)
#  T0   AMARELO (refer√™ncia BLTouch)
variable_offset_x1: 0 #@-0.1 #0.1 #0.0
variable_offset_y1: 0 #-0.1 #0.1  #0.0

#  T1 BRANCO - X/Y fixos calibrados manualmente
variable_offset_x2: 0.60 #0.2  #0.1 # Valor fixo calibrado manualmente
variable_offset_y2: -0.50 #-0.8  #-1.0 #1.1 # -0.3   # Valor fixo calibrado manualmente

#  T2 ROXO - X/Y fixos calibrados manualmente
variable_offset_x3: 1.0 #0.9 #0.8 # Valor fixo calibrado manualmente
variable_offset_y3: -0.50 #-1.8  #-1.1 #0.0  #0.1   # Valor fixo calibrado manualmente
#  T3 - X/Y iniciais para calibra√ß√£o posterior
variable_offset_x4: 0 #0.1
variable_offset_y4: 0 #@0.1
### üéØ Resumo Pr√°tico
#Com os valores atuais offset_x3: 0.2 e offset_y3: 0.5 , a ferramenta T2 est√° sendo compensada:
#- 0.2mm para a direita (eixo X)
#- 0.5mm para frente (eixo Y)
#X POSITIVO MOVE PRA DIREITA
#Y POSITIVO MOVE PARA CIMA


# offset_z4 removido - Z lido diretamente de variables.cfg como tool_2_offset_z

# üß† Dados auxiliares
variable_tool_y: 277 #278  # Posi√ß√£o necess√°ria para travamento magn√©tico das ferramentas
variable_secure_y: 200
variable_approach_speed: 8000
variable_feedrate_troca: 20000
variable_servo_open_min_y: 260


gcode:
  {% if printer["gcode_macro TOOL_DATA"].debugativo %}
    RESPOND MSG="TOOL_DATA carregada"
  {% endif %}
  {% set base_x = printer["gcode_macro TOOL_DATA"].dock_x1|float %}
  {% set dist = printer["gcode_macro TOOL_DATA"].dist_tool|default(0)|float %}
  {% if dist > 0 %}
    {% set x2 = base_x + dist %}
    {% set x3 = x2 + dist %}
    {% set x4 = x3 + dist %}
    {% set x5 = x4 + dist %}
    SET_GCODE_VARIABLE MACRO=TOOL_DATA VARIABLE=dock_x2 VALUE={x2}
    SET_GCODE_VARIABLE MACRO=TOOL_DATA VARIABLE=dock_x3 VALUE={x3}
    SET_GCODE_VARIABLE MACRO=TOOL_DATA VARIABLE=dock_x4 VALUE={x4}
    SET_GCODE_VARIABLE MACRO=TOOL_DATA VARIABLE=dock_x5 VALUE={x5}
    RESPOND PREFIX="TOOL" MSG="dock_x: [x1={base_x}, x2={x2}, x3={x3}, x4={x4}, x5={x5}] (dist={dist})"
  {% else %}
    {% set x2 = printer["gcode_macro TOOL_DATA"].dock_x2|float %}
    {% set x3 = printer["gcode_macro TOOL_DATA"].dock_x3|float %}
    {% set x4 = printer["gcode_macro TOOL_DATA"].dock_x4|float %}
    {% set x5 = printer["gcode_macro TOOL_DATA"].dock_x5|float %}
    RESPOND PREFIX="TOOL" MSG="dock_x: [x1={base_x}, x2={x2}, x3={x3}, x4={x4}, x5={x5}] (dist={dist})"
  {% endif %}

[delayed_gcode INIT_TOOL_DATA]
initial_duration: 0.3
gcode:
  TOOL_DATA
  {% set base_x = printer["gcode_macro TOOL_DATA"].dock_x1|float %}
  {% set dist = printer["gcode_macro TOOL_DATA"].dist_tool|default(0)|float %}
  {% if dist > 0 %}
    {% if printer["gcode_macro TOOL_DATA"].dock_x2|float == 0.0 %}
      SET_GCODE_VARIABLE MACRO=TOOL_DATA VARIABLE=dock_x2 VALUE={base_x + 1*dist}
    {% endif %}
    {% if printer["gcode_macro TOOL_DATA"].dock_x3|float == 0.0 %}
      SET_GCODE_VARIABLE MACRO=TOOL_DATA VARIABLE=dock_x3 VALUE={base_x + 2*dist}
    {% endif %}
    {% if printer["gcode_macro TOOL_DATA"].dock_x4|float == 0.0 %}
      SET_GCODE_VARIABLE MACRO=TOOL_DATA VARIABLE=dock_x4 VALUE={base_x + 3*dist}
    {% endif %}
    {% if printer["gcode_macro TOOL_DATA"].dock_x5|float == 0.0 %}
      SET_GCODE_VARIABLE MACRO=TOOL_DATA VARIABLE=dock_x5 VALUE={base_x + 4*dist}
    {% endif %}
  {% endif %}

[delayed_gcode INIT_TOOL_STATE]
initial_duration: 0.2
gcode:
  TOOL_STATE


  
 
[gcode_macro G12]
gcode:
  ; comandos de limpeza aqui
  #CLEAN_NOZZLE_T0

[gcode_macro CLEAN_NOZZLE_T0]
description: "Limpeza do bico usando offset correto da ferramenta ativa"
gcode:
  {% set start_x = printer.toolhead.position.x|default(0) %}
  {% set start_y = printer.toolhead.position.y|default(0) %}
  {% set start_z = printer.toolhead.position.z|default(5) %}
  {% set active_tool = printer.toolhead.extruder %}
  {% set temp = printer[active_tool].temperature|float %}
  {% if temp >= 170 %}
  #{% if printer.extruder.temperature|float >= 170 %}

     SET_SERVO SERVO=tool_servo WIDTH=1  
    ; üîß CORRE√á√ÉO: T0 deve ter offset ZERO (√© a refer√™ncia com BLTouch)
    ; T0 = ferramenta f√≠sica 1, mas offset deve ser 0,0,0 (refer√™ncia)
    {% set current_tool = printer["gcode_macro TOOL_STATE"].tool|int %}
    {% set vars = printer.save_variables.variables %}
    {% if current_tool == 1 %}
        ; T0 (ferramenta f√≠sica 1) = offset ZERO (refer√™ncia BLTouch)
        {% set x = 0.0 %}
        {% set y = 0.0 %}
        {% set z = 0.0 %}
        {% if printer["gcode_macro TOOL_DATA"].debugativo %}
            RESPOND PREFIX="INFO" MSG="T0 (refer√™ncia): Offset ZERO aplicado X={x} Y={y} Z={z}"
          {% endif %}
    {% elif current_tool == 2 %}
        ; T1 - X/Y fixos do TOOL_DATA, Z direto do variables.cfg
        {% set x = printer["gcode_macro TOOL_DATA"].get("offset_x2")|default(0)|float %}
        {% set y = printer["gcode_macro TOOL_DATA"].get("offset_y2")|default(0)|float %}
        {% set z = vars.get('tool_0_offset_z', 0.0)|float %}
        {% if printer["gcode_macro TOOL_DATA"].debugativo %}
            RESPOND PREFIX="INFO" MSG="T1: Offset aplicado X={x} Y={y} Z={z} (Z direto de variables.cfg)"
          {% endif %}
    {% elif current_tool == 3 %}
        ; T2 - X/Y fixos do TOOL_DATA, Z direto do variables.cfg
        {% set x = printer["gcode_macro TOOL_DATA"].get("offset_x3")|default(0)|float %}
        {% set y = printer["gcode_macro TOOL_DATA"].get("offset_y3")|default(0)|float %}
        {% set z = vars.get('tool_1_offset_z', 0.0)|float %}
        {% if printer["gcode_macro TOOL_DATA"].debugativo %}
            RESPOND PREFIX="INFO" MSG="T2: Offset aplicado X={x} Y={y} Z={z} (Z direto de variables.cfg)"
          {% endif %}
    {% else %}
        {% set x = printer["gcode_macro TOOL_DATA"].get("offset_x" ~ current_tool)|default(0)|float %}
        {% set y = printer["gcode_macro TOOL_DATA"].get("offset_y" ~ current_tool)|default(0)|float %}
        {% set z = vars.get('tool_' ~ (current_tool - 2) ~ '_offset_z', 0.0)|float %}
        {% if printer["gcode_macro TOOL_DATA"].debugativo %}
          RESPOND PREFIX="INFO" MSG="T{current_tool}: Offset aplicado X={x} Y={y} Z={z} (Z direto de variables.cfg)"
        {% endif %}
    {% endif %}
    SET_GCODE_OFFSET X={x} Y={y} Z={z} MOVE=1
  
  
  
    ; Aproxima pela rota segura com Y ‚â§ 200
    G90 
    G1 X235 Y200 F10000
    G1 X280 Y260 F10000
    G1 x315 Y251 F10000
    G91
    #G1 E15 F3000
    G4 P1000
    G90
    ; Posi√ß√£o de limpeza
    G1 x315 Y223 F10000
    
    ; Sequ√™ncia de limpeza
    G91
    #G1 E5 F3000
    G1 Y-12 F3000
    G4 P1000
    G1 Y12 F3000
    G90
    
    ; Retorno via rota segura
    G1 x315 Y200 F10000
    G1  Y{start_y} F10000 #X{start_x}
    G1 Z{start_z} F6000
    
    ; Aplica offset da ferramenta ativa
    APPLY_TOOL_OFFSET
    
    ; Restaura velocidade de impress√£o padr√£o
    G1 F{printer.configfile.settings.printer.max_velocity * 60}
  {% else %}
    {% if printer["gcode_macro TOOL_DATA"].debugativo %}
      RESPOND PREFIX="WARN" MSG="‚ùå Temperatura do extrusor est√° abaixo de 170 ¬∞C. Macro abortado."
    {% endif %}
  
  {% endif %}

   SET_SERVO SERVO=tool_servo WIDTH=0
  


  

#[gcode_macro TOOL_STATE]
#variable_tool: 0
#gcode:
#  {% set saved_tool = printer.save_variables.variables.tool|default(0)|int %}
#  SET_GCODE_VARIABLE MACRO=TOOL_STATE VARIABLE=tool VALUE={saved_tool}
#  RESPOND PREFIX="DEBUG" MSG="TOOL_STATE restaurado: Tool {saved_tool}"
#  M117 TOOL_STATE restaurado: Tool {saved_tool}
[gcode_macro TOOL_STATE]
variable_tool: 1
variable_switch_present: True
gcode:
  {% set saved_tool = printer.save_variables.variables.tool|default(0)|int %}
  {% set confirmed_present = 0 %}
  {% for k in range(3) %}
    QUERY_ENDSTOPS
    {% set s = printer.query_endstops.last_query["manual_stepper tool_dock_stepper"]|default(0)|int %}
    {% set confirmed_present = confirmed_present + s %}
    G4 P150
  {% endfor %}
  {% set present = (confirmed_present >= 2)|int %}
  RESPOND PREFIX="TRACK" MSG="TROCA present_maj={present} (3x)"
  {% if present and saved_tool > 0 %}
    SET_GCODE_VARIABLE MACRO=TOOL_STATE VARIABLE=tool VALUE={saved_tool}
  {% else %}
    SET_GCODE_VARIABLE MACRO=TOOL_STATE VARIABLE=tool VALUE=0
  {% endif %}
  {% if printer["gcode_macro TOOL_DATA"].debugativo %}
    RESPOND PREFIX="DEBUG" MSG="TOOL_STATE: present={present} saved_tool={saved_tool}"
  {% endif %}
  M117 TOOL_STATE: present={present} saved={saved_tool}

# [gcode_macro SET_GCODE_OFFSET] - INTERCEPTA√á√ÉO DESATIVADA
# rename_existing: SET_GCODE_OFFSET_BASE
# gcode:
#   RESPOND PREFIX="DEBUG" MSG="Interceptado: SET_GCODE_OFFSET Z={params.Z|default('')} X={params.X|default('')} Y={params.Y|default('')}"
#   SET_GCODE_OFFSET_BASE {rawparams}

[gcode_macro APPLY_TOOL_OFFSET]
gcode:
  {% set tool = printer["gcode_macro TOOL_STATE"].tool|int %}
  {% set vars = printer.save_variables.variables %}
  
  ; üîß CORRE√á√ÉO: T0 (tool=1) deve ter offset ZERO (refer√™ncia BLTouch)
  {% if tool == 1 %}
    ; T0 = ferramenta f√≠sica 1, mas √© a refer√™ncia (offset zero)
    {% set x = 0.0 %}
    {% set y = 0.0 %}
    {% set z = 0.0 %}
    RESPOND PREFIX="INFO" MSG="T0 (refer√™ncia): Offset ZERO aplicado X={x} Y={y} Z={z}"
  {% elif tool == 2 %}
    ; T1 - X/Y fixos do TOOL_DATA, Z direto do variables.cfg
    {% set x = printer["gcode_macro TOOL_DATA"].get("offset_x2")|default(0)|float %}
    {% set y = printer["gcode_macro TOOL_DATA"].get("offset_y2")|default(0)|float %}
    {% set z = vars.get('tool_0_offset_z', 0.0)|float %}
    RESPOND PREFIX="INFO" MSG="T1: Offset aplicado X={x} Y={y} Z={z} (Z direto de variables.cfg)"
  {% elif tool == 3 %}
    ; T2 - X/Y fixos do TOOL_DATA, Z direto do variables.cfg
    {% set x = printer["gcode_macro TOOL_DATA"].get("offset_x3")|default(0)|float %}
    {% set y = printer["gcode_macro TOOL_DATA"].get("offset_y3")|default(0)|float %}
    {% set z = vars.get('tool_1_offset_z', 0.0)|float %}
    RESPOND PREFIX="INFO" MSG="T2: Offset aplicado X={x} Y={y} Z={z} (Z direto de variables.cfg)"
  {% elif tool == 4 %}
    ; T3 - X/Y fixos do TOOL_DATA, Z direto do variables.cfg
    {% set x = printer["gcode_macro TOOL_DATA"].get("offset_x4")|default(0)|float %}
    {% set y = printer["gcode_macro TOOL_DATA"].get("offset_y4")|default(0)|float %}
    {% set z = vars.get('tool_2_offset_z', 0.0)|float %}
    {% if printer["gcode_macro TOOL_DATA"].debugativo %}
       RESPOND PREFIX="INFO" MSG="T3: Offset aplicado X={x} Y={y} Z={z} (Z direto de variables.cfg)"
     {% endif %}
  {% else %}
    {% set x = printer["gcode_macro TOOL_DATA"].get("offset_x" ~ tool)|default(0)|float %}
    {% set y = printer["gcode_macro TOOL_DATA"].get("offset_y" ~ tool)|default(0)|float %}
    {% set z = vars.get('tool_' ~ (tool - 2) ~ '_offset_z', 0.0)|float %}
    {% if printer["gcode_macro TOOL_DATA"].debugativo %}
       RESPOND PREFIX="INFO" MSG="TOOL={tool}: Offset aplicado X={x} Y={y} Z={z} (Z direto de variables.cfg)"
     {% endif %}
  {% endif %}
  
  G1 f10000
  M117 Offset aplicado: TOOL={tool}
  {% set homed = printer.toolhead.homed_axes %}
  {% set can_move = 'x' in homed and 'y' in homed and 'z' in homed %}
  {% if can_move %}
    SET_GCODE_OFFSET X={x} Y={y}  MOVE=1
    SET_GCODE_OFFSET Z={z}  X={x} Y={y} MOVE=1
  {% else %}
    SET_GCODE_OFFSET X={x} Y={y}
    SET_GCODE_OFFSET Z={z}  X={x} Y={y}
  {% endif %}


[gcode_macro APPLY_TOOLZ_OFFSET]
gcode:
  {% set tool = printer["gcode_macro TOOL_STATE"].tool|int %}
  {% set vars = printer.save_variables.variables %}
  
  ; üîß CORRE√á√ÉO: T0 (tool=1) deve ter offset ZERO (refer√™ncia BLTouch)
  {% if tool == 1 %}
    ; T0 = ferramenta f√≠sica 1, mas √© a refer√™ncia (offset zero) 
    {% set z = 0.0 %}
    RESPOND PREFIX="INFO" MSG="T0 (refer√™ncia): Offset ZERO aplicado X={x} Y={y} Z={z}"
  {% elif tool == 2 %}
    ; T1 - X/Y fixos do TOOL_DATA, Z direto do variables.cfg 
    {% set z = vars.get('tool_0_offset_z', 0.0)|float %}
    RESPOND PREFIX="INFO" MSG="T1: Offset aplicado X={x} Y={y} Z={z} (Z direto de variables.cfg)"
  {% elif tool == 3 %}
    ; T2 - X/Y fixos do TOOL_DATA, Z direto do variables.cfg 
    {% set z = vars.get('tool_1_offset_z', 0.0)|float %}
    RESPOND PREFIX="INFO" MSG="T2: Offset aplicado X={x} Y={y} Z={z} (Z direto de variables.cfg)"
  {% elif tool == 4 %}
    ; T3 - X/Y fixos do TOOL_DATA, Z direto do variables.cfg 
    {% set z = vars.get('tool_2_offset_z', 0.0)|float %}
    {% if printer["gcode_macro TOOL_DATA"].debugativo %}
       RESPOND PREFIX="INFO" MSG="T3: Offset aplicado X={x} Y={y} Z={z} (Z direto de variables.cfg)"
     {% endif %}
  {% else %}
    {% set z = vars.get('tool_' ~ (tool - 2) ~ '_offset_z', 0.0)|float %}
    {% if printer["gcode_macro TOOL_DATA"].debugativo %}
       RESPOND PREFIX="INFO" MSG="TOOL={tool}: Offset aplicado X={x} Y={y} Z={z} (Z direto de variables.cfg)"
     {% endif %}
  {% endif %}
  
  G1 f10000
  M117 Offset Z aplicado: TOOL={tool}
 
  SET_GCODE_OFFSET Z={z}    MOVE=1

  
[gcode_macro APPLY_TOOL_OFFSET_UNSEC]
gcode:
  {% set tool = printer["gcode_macro TOOL_STATE"].tool|int %}
  {% set vars = printer.save_variables.variables %}
  
  ; üîß CORRE√á√ÉO: T0 (tool=1) deve ter offset ZERO (refer√™ncia BLTouch)
  {% if tool == 1 %}
    ; T0 = ferramenta f√≠sica 1, mas √© a refer√™ncia (offset zero)
    {% set x = 0.0 %}
    {% set y = 0.0 %}
    {% set z = 0.0 %}
    RESPOND PREFIX="INFO" MSG="T0 (refer√™ncia): Offset ZERO aplicado X={x} Y={y} Z={z}"
  {% elif tool == 2 %}
    ; T1 - X/Y fixos do TOOL_DATA, Z direto do variables.cfg
    {% set x = printer["gcode_macro TOOL_DATA"].get("offset_x2")|default(0)|float %}
    {% set y = printer["gcode_macro TOOL_DATA"].get("offset_y2")|default(0)|float %}
    {% set z = vars.get('tool_0_offset_z', 0.0)|float %}
    RESPOND PREFIX="INFO" MSG="T1: Offset aplicado X={x} Y={y} Z={z} (Z direto de variables.cfg)"
  {% elif tool == 3 %}
    ; T2 - X/Y fixos do TOOL_DATA, Z direto do variables.cfg
    {% set x = printer["gcode_macro TOOL_DATA"].get("offset_x3")|default(0)|float %}
    {% set y = printer["gcode_macro TOOL_DATA"].get("offset_y3")|default(0)|float %}
    {% set z = vars.get('tool_1_offset_z', 0.0)|float %}
    RESPOND PREFIX="INFO" MSG="T2: Offset aplicado X={x} Y={y} Z={z} (Z direto de variables.cfg)"
  {% elif tool == 4 %}
    ; T3 - X/Y fixos do TOOL_DATA, Z direto do variables.cfg
    {% set x = printer["gcode_macro TOOL_DATA"].get("offset_x4")|default(0)|float %}
    {% set y = printer["gcode_macro TOOL_DATA"].get("offset_y4")|default(0)|float %}
    {% set z = vars.get('tool_2_offset_z', 0.0)|float %}
    RESPOND PREFIX="INFO" MSG="T3: Offset aplicado X={x} Y={y} Z={z} (Z direto de variables.cfg)"
  {% else %}
    {% set x = printer["gcode_macro TOOL_DATA"].get("offset_x" ~ tool)|default(0)|float %}
    {% set y = printer["gcode_macro TOOL_DATA"].get("offset_y" ~ tool)|default(0)|float %}
    {% set z = vars.get('tool_' ~ (tool - 2) ~ '_offset_z', 0.0)|float %}
    RESPOND PREFIX="INFO" MSG="TOOL={tool}: Offset aplicado X={x} Y={y} Z={z} (Z direto de variables.cfg)"
  {% endif %}
  
  G1 f10000
  M117 Offset aplicado: TOOL={tool}

  SET_GCODE_OFFSET X={x} Y={y}  MOVE=1 
  SET_GCODE_OFFSET Z={z}  X={x} Y={y} MOVE=1

[gcode_macro SET_DIF_TEMP]
description: "Define o delta de resfriamento na macro TROCA (ex.: SET_DIF_TEMP delta=25)"
gcode:
  {% set delta = params.DELTA|default(20)|int %}  ; Default 20 se n√£o especificado
  SET_GCODE_VARIABLE MACRO=TROCA VARIABLE=dif_temp VALUE={delta}
  RESPOND PREFIX="INFO" MSG="DIF_TEMP definido para {delta}¬∞C na macro TROCA"

 
 

# Adicionar no in√≠cio da macro TROCA (logo ap√≥s as vari√°veis)
[gcode_macro TROCA]
variable_dif_temp: 25
variable_z_antes: 0.0

variable_skip_filamento: False
variable_skip_move: False
variable_skip_extruder: False
variable_min_standby: 0
variable_next_tool: 0
variable_ignore_lidar: 0
variable_disconnected: False
gcode:
  PSU_ON_SAFE
  {% set homed = printer.toolhead.homed_axes %}
  {% set ignore_init = printer.save_variables.variables.ignore_init_tool_check|default(False) %}
  {% if 'x' not in homed or 'y' not in homed %}
    {% if ignore_init %}
      RESPOND PREFIX="WARNING" MSG="Homing bloqueado (ignore_init_tool_check ativo) ‚Äî TROCA abortada"
      G90
      G1 Y{printer['gcode_macro TOOL_DATA'].secure_y} F{printer['gcode_macro TOOL_DATA'].approach_speed}
      PAUSE
    {% else %}
      G28
    {% endif %}
  {% endif %}
  {% set ignore_lidar = params.IGNORE_LIDAR|default(0)|int %}
  {% set tool = params.TOOL|default(0)|int %}
  SET_GCODE_VARIABLE MACRO=TROCA VARIABLE=next_tool VALUE={tool}
  SET_GCODE_VARIABLE MACRO=TROCA VARIABLE=ignore_lidar VALUE={ignore_lidar}
  {% set vars = printer.save_variables.variables %}
  {% set new_temp = vars.get('tool_temp_' ~ tool, 0)|int %}
  {% set new_extr = 'extruder' if tool == 1 else 'extruder' ~ (tool - 1) %}
  {% if new_temp > 0 %}
    M104.0 T{tool - 1} S{new_temp}
    RESPOND MSG="Pr√©-aquecendo Tool {tool - 1} para {new_temp}¬∞C (early)"
  {% else %}
    RESPOND MSG="Nenhuma temperatura salva para Tool {tool - 1} ‚Äî pr√©-aquecimento ser√° aplicado quando dispon√≠vel"
  {% endif %}

  
  {% set z_atual = printer.toolhead.position.z|float %}
  SET_GCODE_VARIABLE MACRO=TROCA VARIABLE=z_antes VALUE={z_atual}
  {% set tool_y = printer["gcode_macro TOOL_DATA"].tool_y|int %}
  {% set secure_y = printer["gcode_macro TOOL_DATA"].secure_y|int %}
  {% set approach_speed = printer["gcode_macro TOOL_DATA"].approach_speed|int %}
  {% set x_pos = printer["gcode_macro TOOL_DATA"].get("dock_x" ~ tool)|float %}
  {% set approach_pre = tool_y - 10 %}
  {% set approach_slow = approach_speed // 20 %}
  {% set active_tool = printer["gcode_macro TOOL_STATE"].tool|int %}
  CHECK_SENSOR_NOW
  CHECK_SENSOR_NOW
  {% set present = printer.save_variables.variables.head_sensor_now|default(0)|int %}
  {% set extruders = {1: "extruder", 2: "extruder1", 3: "extruder2", 4: "extruder3", 5: "extruder4"} %}
  {% set standby = {
    1: printer["gcode_macro TOOL_DATA"].standby_temp_T1|default(170)|int,
    2: printer["gcode_macro TOOL_DATA"].standby_temp_T2|default(170)|int,
    3: printer["gcode_macro TOOL_DATA"].standby_temp_T3|default(170)|int,
    4: printer["gcode_macro TOOL_DATA"].standby_temp_T4|default(170)|int
  } %}
  
  # Nova l√≥gica de temperatura: Resfriar todas as outras ativas respeitando dif_temp (sem quedas cumulativas)
  {% set all_tools = [1,2,3,4] %}  # Ferramentas dispon√≠veis (ajuste se necess√°rio)
  {% for i in all_tools %}
    {% if i != tool %}
      {% set extr_name = "extruder" if i == 1 else "extruder" ~ (i - 1) %}
      {% set curr_temp = printer[extr_name].temperature|float %}
      {% if curr_temp > 50 %}  # Considera "ativa" se >50¬∞C (ajuste o limiar se quiser)
        {% set saved_temp = vars.get('tool_temp_' ~ i, 0)|int %}
        {% if saved_temp == 0 and printer[extr_name].target|default(0)|int > 0 %}
          {% set saved_temp = printer[extr_name].target|int %}
          SAVE_VARIABLE VARIABLE=tool_temp_{i} VALUE={saved_temp}
        {% endif %}
        {% if saved_temp > 0 %}
          {% set standby_temp = [saved_temp - dif_temp, printer["gcode_macro TROCA"].min_standby|default(0)]|max %}
          M104.0 T{i - 1} S{standby_temp}  # Resfria (sem wait)
          RESPOND MSG="Resfriando Tool {i - 1}: base={saved_temp} ‚Üí standby={standby_temp} (‚àí{dif_temp}¬∞C)"
        {% endif %}
      {% endif %}
    {% endif %}
  {% endfor %}
  

  {% if active_tool != tool %}
    SAVE_GCODE_STATE NAME=toolchange
    RESPOND PREFIX="TRACK" MSG="TROCA start tool={tool} active_tool={active_tool} present={present} x_pos={x_pos} tool_y={tool_y} secure_y={secure_y}"
    SET_GCODE_OFFSET X=0 Y=0 Z=0
    G90

    {% set active_tool = printer["gcode_macro TOOL_STATE"].tool|int %}
    QUERY_ENDSTOPS
    {% set endstops = printer.query_endstops.last_query %}
    {% set s = 0 %}
    {% for kk in endstops %}
      {% if 'tool_dock_stepper' in kk %}
        {% set v = endstops[kk] %}
        {% set s = 1 if (v == 1 or v|string == 'TRIGGERED' or v|string == 'triggered') else 0 %}
      {% endif %}
    {% endfor %}
    {% set saved_last = printer.save_variables.variables.last_tool|default(0)|int %}
    {% set active_eff = active_tool if active_tool > 0 else saved_last %}
    RESPOND PREFIX="TRACK" MSG="TROCA active_tool={active_tool} saved_last={saved_last} sensor={s}"
    {% if active_tool > 0 or (active_eff > 0 and s == 1) %}
      RESPOND PREFIX="TRACK" MSG="TROCA undock_decision: active_tool={active_tool} active_eff={active_eff} sensor={s} ‚Üí DESCONECTA"
      DESCONECTA NEXT_TOOL={tool}
    {% else %}
      RESPOND PREFIX="TRACK" MSG="TROCA undock_decision: active_tool={active_tool} active_eff={active_eff} sensor={s} ‚Üí SKIP"
    {% endif %}
    CONECTA TOOL={tool}
  {% else %}
    {% set msg = "Tool " ~ tool ~ " j√° est√° ativa" %}
    RESPOND MSG="{msg}"
    M117 {msg}
  {% endif %}
  G1 F20000
  G91
  G1 y-5 F18000
  G90
  # No final da macro TROCA (antes do movimento para torre de purga)

  
  G1 Y200 F{printer["gcode_macro TOOL_DATA"].feedrate_troca}  # volta na posicao segura para nao trombar as ferramentas
  #G1 X150 F11000 ; Move para a posi√ß√£o da torre de purga (sequ√™ncia segura)



[gcode_macro TROCA_DESACOPLA]
gcode:
  {% set tool = params.TOOL|default(printer["gcode_macro TROCA"].next_tool)|int %}
  TROCA TOOL={tool}

[gcode_macro TROCA_ACOPLA]
gcode:
  RESPOND PREFIX="INFO" MSG="TROCA_ACOPLA desativada (sem delayed_gcode)"

[gcode_macro T0]
gcode: 
  {% set current_tool = printer["gcode_macro TOOL_STATE"].tool|int %}
  {% set present = printer["gcode_macro TOOL_STATE"].switch_present|int %}
  {% if current_tool == 1 %}
    {% if present %}
      {% if printer["gcode_macro TOOL_DATA"].debugativo %}
        RESPOND PREFIX="INFO" MSG="T0 j√° est√° ativa"
      {% endif %}
      M117 T0 j√° ativa
    {% else %}
      RECARREGAR_FERRAMENTA TOOL=1
    {% endif %}
  {% else %}
    TROCA TOOL=1
  {% endif %}

[gcode_macro T1]
gcode: 
  {% set current_tool = printer["gcode_macro TOOL_STATE"].tool|int %}
  {% if current_tool == 2 %}
    {% if printer["gcode_macro TOOL_DATA"].debugativo %}
      RESPOND PREFIX="INFO" MSG="T1 j√° est√° ativa - recarregando ferramenta"
    {% endif %}
    M117 Recarregando T1...
    RECARREGAR_FERRAMENTA TOOL=2
  {% else %}
    TROCA TOOL=2
  {% endif %}

[gcode_macro T2]
gcode: 
  {% set current_tool = printer["gcode_macro TOOL_STATE"].tool|int %}
  {% if current_tool == 3 %}
    {% if printer["gcode_macro TOOL_DATA"].debugativo %}
      RESPOND PREFIX="INFO" MSG="T2 j√° est√° ativa - recarregando ferramenta"
    {% endif %}
    M117 Recarregando T2...
    RECARREGAR_FERRAMENTA TOOL=3
  {% else %}
    TROCA TOOL=3
  {% endif %}

[gcode_macro T3]
gcode: 
  {% set current_tool = printer["gcode_macro TOOL_STATE"].tool|int %}
  {% if current_tool == 4 %}
    {% if printer["gcode_macro TOOL_DATA"].debugativo %}
      RESPOND PREFIX="INFO" MSG="T3 j√° est√° ativa - recarregando ferramenta"
    {% endif %}
    M117 Recarregando T3...
    RECARREGAR_FERRAMENTA TOOL=4
  {% else %}
    TROCA TOOL=4
  {% endif %}

[gcode_macro T4]
gcode: 
  {% set current_tool = printer["gcode_macro TOOL_STATE"].tool|int %}
  {% if current_tool == 5 %}
    {% if printer["gcode_macro TOOL_DATA"].debugativo %}
      RESPOND PREFIX="INFO" MSG="T4 j√° est√° ativa - recarregando ferramenta"
    {% endif %}
    M117 Recarregando T4...
    RECARREGAR_FERRAMENTA TOOL=5
  {% else %}
    TROCA TOOL=5
  {% endif %}

[gcode_macro TOOL_LOCK]
variable_enabled: True
gcode:
  {% if params.ACTION|default("") == "OFF" %}
    SET_GCODE_VARIABLE MACRO=TOOL_LOCK VARIABLE=enabled VALUE=False
    {% if printer["gcode_macro TOOL_DATA"].debugativo %}
      RESPOND PREFIX="INFO" MSG="Movimentos de troca de ferramenta DESATIVADOS"
    {% endif %}
  {% elif params.ACTION|default("") == "ON" %}
    SET_GCODE_VARIABLE MACRO=TOOL_LOCK VARIABLE=enabled VALUE=True
    {% if printer["gcode_macro TOOL_DATA"].debugativo %}
      RESPOND PREFIX="INFO" MSG="Movimentos de troca de ferramenta ATIVADOS"
    {% endif %}
  {% else %}
    {% if printer["gcode_macro TOOL_DATA"].debugativo %}
      RESPOND PREFIX="INFO" MSG="Uso: TOOL_LOCK ACTION=ON ou ACTION=OFF"
    {% endif %}
  {% endif %}

[gcode_macro SHOW_TOOL_STATUS]
description: Mostra o status de todas as ferramentas
gcode:
  {% set active = printer["gcode_macro TOOL_STATE"].tool|int %}
  {% for i in range(1, 5) %}
    {% if i == active %}
      {% if printer["gcode_macro TOOL_DATA"].debugativo %}
        RESPOND PREFIX="TOOL" MSG="Tool {i} ‚Üí ATIVA"
      {% endif %}
    {% else %}
      {% if printer["gcode_macro TOOL_DATA"].debugativo %}
        RESPOND PREFIX="TOOL" MSG="Tool {i} - inativa"
      {% endif %}
    {% endif %}
  {% endfor %}
  M117 Tool ativa: {active}

[gcode_macro _ATTEMPT_DISCONNECT]
gcode:
  {% set tool_y = printer["gcode_macro TOOL_DATA"].tool_y|int %}
  {% set approach_speed = printer["gcode_macro TOOL_DATA"].approach_speed|int %}
  {% set approach_slow = approach_speed // 10 %}
  {% set present = printer["gcode_macro TOOL_STATE"].switch_present|int %}

  RESPOND PREFIX="INFO" MSG="Desconectar: antes present={present|int}"
  ABRIR SAFE=1
  G4 P300
  G1 Y{tool_y} F{approach_slow}
  G91
  G1 Y-15 F2000 #{approach_speed}
  G90
  M400
  G4 P300

  G4 P200
  CHECK_SENSOR_NOW
  CHECK_SENSOR_NOW
  {% set present2 = printer.save_variables.variables.head_sensor_now|default(0)|int %}
  RESPOND PREFIX="TRACK" MSG="DISCONNECT present2={present2} pos=({printer.toolhead.position.x},{printer.toolhead.position.y})"
  SET_GCODE_VARIABLE MACRO=TOOL_STATE VARIABLE=switch_present VALUE={present2}
  SET_GCODE_VARIABLE MACRO=TROCA VARIABLE=disconnected VALUE={(not present2)|int}
  RESPOND PREFIX="INFO" MSG="Desconectar: ap√≥s recuo present={present2|int}"
  {% if not present2 and printer["gcode_macro TOOL_DATA"].debugativo %}
    RESPOND PREFIX="INFO" MSG="‚úÖ Desconex√£o confirmada"
  {% endif %}

[gcode_macro _CHECK_DISCONNECT_FAILED]
gcode:
  G4 P150
  CHECK_SENSOR_NOW
  CHECK_SENSOR_NOW
  {% set present = printer.save_variables.variables.head_sensor_now|default(0)|int %}
  RESPOND PREFIX="TRACK" MSG="CHECK_CONNECT present={present} pos=({printer.toolhead.position.x},{printer.toolhead.position.y})"
  {% if present %}
    RESPOND PREFIX="ERROR" MSG="‚ùå Sensor ainda marca conectado"
    SET_GCODE_VARIABLE MACRO=TROCA VARIABLE=disconnected VALUE=0
  {% else %}
    SET_GCODE_VARIABLE MACRO=TROCA VARIABLE=disconnected VALUE=1
    RESPOND PREFIX="INFO" MSG="‚úÖ Desconex√£o confirmada"
  {% endif %}

[gcode_macro _ATTEMPT_CONNECT]
gcode:
  {% set approach_speed = printer["gcode_macro TOOL_DATA"].approach_speed|int %}
  CHECK_SENSOR_NOW
  CHECK_SENSOR_NOW
  {% set present0 = printer.save_variables.variables.head_sensor_now|default(0)|int %}
  RESPOND PREFIX="INFO" MSG="Conectar: antes recuo present={present0}"
  RESPOND PREFIX="TRACK" MSG="ATTEMPT_CONNECT recuo_start y={printer.toolhead.position.y}"
  G91
  G1 Y-15 F1000 #{approach_speed}
  G90
  RESPOND PREFIX="TRACK" MSG="ATTEMPT_CONNECT recuo_end y={printer.toolhead.position.y}"
  M400
  G4 P300
  {% set confirmed = 0 %}
  {% for k in range(3) %}
    QUERY_ENDSTOPS
    {% set s = printer.query_endstops.last_query["manual_stepper tool_dock_stepper"]|default(0)|int %}
    {% set confirmed = confirmed + s %}
    G4 P200
  {% endfor %}
  {% set present1 = (confirmed >= 2)|int %}
  RESPOND PREFIX="INFO" MSG="Conectar: ap√≥s recuo present={present1|int} (3x)"
  {% if present1 %}
    SET_GCODE_VARIABLE MACRO=TOOL_STATE VARIABLE=switch_present VALUE=1
    {% if printer["gcode_macro TOOL_DATA"].debugativo %}
      RESPOND PREFIX="INFO" MSG="‚úÖ Conex√£o confirmada"
    {% endif %}
  {% else %}
    SET_GCODE_VARIABLE MACRO=TOOL_STATE VARIABLE=switch_present VALUE=0
    RESPOND PREFIX="ERROR" MSG="‚ùå Conex√£o n√£o confirmada"
  {% endif %}

[gcode_macro _CHECK_CONNECT_FAILED]
gcode:
  G4 P150
  {% set confirmed = 0 %}
  {% for k in range(3) %}
    QUERY_ENDSTOPS
    {% set s = printer.query_endstops.last_query["manual_stepper tool_dock_stepper"]|default(0)|int %}
    {% set confirmed = confirmed + s %}
    G4 P150
  {% endfor %}
  {% set present = (confirmed >= 2)|int %}
  {% if not present %}
    RESPOND PREFIX="ERROR" MSG="‚ùå Falha no acoplamento: present={present|int}"
  {% endif %}

[gcode_macro DISCONNECT_EXTRUDER]
gcode:
  SET_GCODE_VARIABLE MACRO=TROCA VARIABLE=skip_extruder VALUE=True
  SET_GCODE_VARIABLE MACRO=TROCA VARIABLE=skip_filamento VALUE=True
  SET_GCODE_VARIABLE MACRO=TROCA VARIABLE=skip_move VALUE=True
  RESPOND PREFIX="INFO" MSG="üîß Modo stress: extrusora, movimento e filamento desativados"

[gcode_macro RECONNECT_EXTRUDER]
gcode:
  SET_GCODE_VARIABLE MACRO=TROCA VARIABLE=skip_extruder VALUE=False
  SET_GCODE_VARIABLE MACRO=TROCA VARIABLE=skip_filamento VALUE=False
  SET_GCODE_VARIABLE MACRO=TROCA VARIABLE=skip_move VALUE=False
  RESPOND PREFIX="INFO" MSG="üîß Modo normal: extrusora, movimento e filamento reativados"



[gcode_macro RECARREGAR_FERRAMENTA]
description: Recarrega a ferramenta atual abrindo servo a 1cm do estacionamento
gcode:
  {% set tool = params.TOOL|default(0)|int %}
  {% set homed = printer.toolhead.homed_axes %}
  {% if 'x' not in homed or 'y' not in homed %}
    {% if printer.save_variables.variables.ignore_init_tool_check|default(False) %}
      RESPOND PREFIX="WARNING" MSG="Homing bloqueado (ignore_init_tool_check ativo) ‚Äî RECARREGAR_FERRAMENTA abortada"
      PAUSE
    {% else %}
      G28
    {% endif %}
  {% endif %}
  {% set tool_y = printer["gcode_macro TOOL_DATA"].tool_y|int %}
  {% set secure_y = printer["gcode_macro TOOL_DATA"].secure_y|int %}
  {% set approach_speed = printer["gcode_macro TOOL_DATA"].approach_speed|int %}
  {% set x_pos = printer["gcode_macro TOOL_DATA"].get("dock_x" ~ tool)|float %}
  {% set approach_pre = tool_y - 10 %}  # 1cm antes do estacionamento
  {% set approach_slow = approach_speed // 10 %}
  
  {% if tool == 0 %}
    {% if printer["gcode_macro TOOL_DATA"].debugativo %}
      RESPOND PREFIX="ERROR" MSG="TOOL inv√°lida para recarregamento"
    {% endif %}
  {% else %}

  {% if printer["gcode_macro TOOL_DATA"].debugativo %}
    RESPOND PREFIX="INFO" MSG="üîÑ Recarregando ferramenta TOOL={tool} - abrindo servo a 1cm do estacionamento"
  {% endif %}
  M117 Recarregando TOOL={tool}...

  SAVE_GCODE_STATE NAME=reload_tool
  G90
  
  # Aplicar apenas offset de T0 (zero) para movimentos de troca sem mudar extrusor
  {% set x_t0 = printer["gcode_macro TOOL_DATA"].get("offset_x1")|default(0)|float %}
  {% set y_t0 = printer["gcode_macro TOOL_DATA"].get("offset_y1")|default(0)|float %}
  {% set z_t0 = 0.0 %}
  SET_GCODE_OFFSET X={x_t0} Y={y_t0} Z={z_t0}
  
  # Ir para posi√ß√£o de recarregamento (1cm antes do estacionamento)
  G1 Y200 F{printer["gcode_macro TOOL_DATA"].feedrate_troca}
  G1 X{x_pos} Y200 F{printer["gcode_macro TOOL_DATA"].feedrate_troca}
  G1 Y{approach_pre} F{approach_speed}  # Para a 1cm do estacionamento
  
  # Abrir servo para permitir reposicionamento
  ABRIR SAFE=1
  G4 P500
  
  # Avan√ßar para posi√ß√£o final e fechar
  G1 Y{tool_y} F{approach_slow}
  G4 P300
  FECHAR
  G4 P500
  
  # Retornar para posi√ß√£o segura
  G1 Y{secure_y} F{approach_speed}  # Movimento absoluto para posi√ß√£o segura
  
  # Aplicar offsets da ferramenta recarregada - dupla leitura para sincroniza√ß√£o
  CHECK_SENSOR_NOW
  CHECK_SENSOR_NOW
  {% set present = printer.save_variables.variables.head_sensor_now|default(0)|int %}
  {% if present == 1 %}
    APPLY_TOOL_OFFSET
  {% else %}
    RESPOND PREFIX="WARNING" MSG="‚ö†Ô∏è Offset n√£o aplicado: sensor n√£o confirma ferramenta"
  {% endif %}
  
  RESTORE_GCODE_STATE NAME=reload_tool
  {% if printer["gcode_macro TOOL_DATA"].debugativo %}
    RESPOND PREFIX="INFO" MSG="‚úÖ Ferramenta TOOL={tool} recarregada com sucesso"
  {% endif %}
  M117 TOOL={tool} recarregada
  {% endif %}

[gcode_macro DESCARREGAR]
description: Descarrega a ferramenta atual e retorna √† posi√ß√£o segura
gcode:
  {% set cur_tool = printer["gcode_macro TOOL_STATE"].tool|int %}
  {% set tool_y = printer["gcode_macro TOOL_DATA"].tool_y|int %}
  {% set approach_speed = printer["gcode_macro TOOL_DATA"].approach_speed|int %}
  {% set cur_x = printer["gcode_macro TOOL_DATA"].get("dock_x" ~ cur_tool)|int %}

  {% if cur_tool == 0 %}
    {% if printer["gcode_macro TOOL_DATA"].debugativo %}
      RESPOND PREFIX="INFO" MSG="Nenhuma ferramenta carregada"
    {% endif %}
  {% else %}

  {% if printer["gcode_macro TOOL_DATA"].debugativo %}
    RESPOND MSG="Descarregando ferramenta TOOL={cur_tool}"
  {% endif %}
  M117 Descarregando ferramenta TOOL={cur_tool}

  G90
  G1 Y200 F{printer["gcode_macro TOOL_DATA"].feedrate_troca}
  G1 X{cur_x} F{printer["gcode_macro TOOL_DATA"].feedrate_troca}
  G1 Y{tool_y} F{approach_speed}
  ABRIR SAFE=1
  G4 P300
  G91
  G1 Y-100 F{printer["gcode_macro TOOL_DATA"].feedrate_troca}
  G90
  SET_GCODE_VARIABLE MACRO=TOOL_STATE VARIABLE=tool VALUE=0
  SAVE_VARIABLE VARIABLE=tool VALUE=0
  M117 Tool descarregada
  {% endif %}

[gcode_macro FECHAR]
description: Fecha a trava da ferramenta (servo a 180¬∞)
gcode:
  SET_SERVO SERVO=tool_servo WIDTH=1  
  SET_SERVO SERVO=tool_servo ANGLE=180  
  G4 P300
  SET_SERVO SERVO=tool_servo ANGLE=150  
  G4 P500
  SET_SERVO SERVO=tool_servo ANGLE=180  
  G4 P300 
  # Remover: SET_SERVO SERVO=tool_servo WIDTH=0
  # Iniciar timer de 50 segundos para desligar o servo
  UPDATE_DELAYED_GCODE ID=servo_auto_off DURATION=50
  {% if printer["gcode_macro TOOL_DATA"].debugativo %}
    RESPOND MSG="Trava fechada (180¬∞) - Servo ser√° desligado em 50s"
  {% endif %}

[gcode_macro ABRIR]
description: Abre a trava da ferramenta (servo a 0¬∞)
gcode:
  {% set min_open_y = printer["gcode_macro TOOL_DATA"].servo_open_min_y|default(250)|int %}
  {% set cur_y = printer.toolhead.position.y|float %}
  {% set homed = printer.toolhead.homed_axes %}
  {% set safe = params.SAFE|default(0)|int %}
  {% if safe and ('y' in homed) and cur_y < min_open_y %}
    G90
    G1 Y{min_open_y} F{printer["gcode_macro TOOL_DATA"].approach_speed}
  {% endif %}
  {% set homed_y = ('y' in homed)|int %}
  RESPOND PREFIX="TRACK" MSG="ABRIR safe={safe} homed_y={homed_y} cur_y={cur_y} min_open_y={min_open_y}"
  UPDATE_DELAYED_GCODE ID=servo_auto_off DURATION=0
  SET_SERVO SERVO=tool_servo WIDTH=1 
  SET_SERVO SERVO=tool_servo ANGLE=0 
  G4 P1500
  SET_SERVO SERVO=tool_servo WIDTH=0
  {% if printer["gcode_macro TOOL_DATA"].debugativo %}
    RESPOND MSG="Trava aberta (0¬∞) - Timer de desligamento cancelado"
  {% endif %}

# Adicionar no final do arquivo
[delayed_gcode servo_auto_off]
gcode:
  SET_SERVO SERVO=tool_servo WIDTH=0
  {% if printer["gcode_macro TOOL_DATA"].debugativo %}
    RESPOND MSG="üîå Servo desligado automaticamente ap√≥s 50s"
  {% endif %}

[gcode_macro WHOAMI]
gcode:
  {% if printer["gcode_macro TOOL_DATA"].debugativo %}
    RESPOND PREFIX="DEBUG" MSG="tool={printer['gcode_macro TOOL_STATE'].tool} active_extruder={printer.toolhead.extruder}"
  {% endif %}

[gcode_macro QUAL_EXTRUSORA]
gcode:
  {% set t = printer["gcode_macro TOOL_STATE"].tool|int %}
  {% set extr = printer.toolhead.extruder %}
  RESPOND PREFIX="INFO" MSG="Tool ativa: T{t-1} extrusor={extr}"
  M117 Tool ativa: T{t-1}

[gcode_macro _CHECK_TOOL_OFF]
gcode:
  {% set max_attempts = 3 %}
  {% set success = 0 %}
  {% for i in range(max_attempts) %}
    CHECK_SENSOR_NOW
    CHECK_SENSOR_NOW
    {% set state = printer.save_variables.variables.head_sensor_now|default(0)|int %}
    {% if state == 0 %}
      {% set success = 1 %}
    {% endif %}
    {% if success == 0 %}
      G4 P500
    {% endif %}
  {% endfor %}
  {% if success == 1 %}
    RESPOND MSG="Tool descarregada OK!"
  {% else %}
    {action_raise_error("Timeout: Falha ao descarregar tool - switch ainda PRESSSED!")}
  {% endif %}

[gcode_macro _CHECK_TOOL_ON]
gcode:
  {% set max_attempts = 3 %}
  {% set success = 0 %}
  {% for i in range(max_attempts) %}
    CHECK_SENSOR_NOW
    CHECK_SENSOR_NOW
    {% set state = printer.save_variables.variables.head_sensor_now|default(0)|int %}
    {% if state == 1 %}
      {% set success = 1 %}
    {% endif %}
    {% if success == 0 %}
      G4 P500
    {% endif %}
  {% endfor %}
  {% if success == 1 %}
    RESPOND MSG="Tool carregada OK!"
  {% else %}
    {action_raise_error("Timeout: Falha ao carregar tool - switch ainda RELEASED!")}
  {% endif %}

 


[gcode_macro TOOL_SENSOR_TEST_LOOP]
gcode:
  G90
  G1 X9 Y200 F{printer["gcode_macro TOOL_DATA"].feedrate_troca|default(20000)}
  ABRIR
  {% set x = 142.75 %}
  {% set y1 = 265.0 %}
  {% set y2 = 277.0 %}
  {% set cycles = params.CYCLES|default(5)|int %}
  {% for i in range(cycles) %}
    ABRIR
    G1 X{x} Y{y1} F{printer["gcode_macro TOOL_DATA"].feedrate_troca|default(20000)}
    G4 P500
    {% for k in range(1) %}
      QUERY_ENDSTOPS
      {% set v = printer.query_endstops.last_query["manual_stepper tool_dock_stepper"]|default(0) %}
      {% set state = 1 if (v == 1 or v|string == 'TRIGGERED' or v|string == 'triggered') else 0 %}
      RESPOND PREFIX="TEST" MSG="tool_presence={'PRESSED' if state else 'RELEASED'} @Y={y1} sample={k+1}/10"
      G4 P200
    {% endfor %}
    G1 X{x} Y{y2} F{printer["gcode_macro TOOL_DATA"].feedrate_troca|default(20000)}
    FECHAR
    G4 P500
    {% for k in range(1) %}
      QUERY_ENDSTOPS
      {% set v = printer.query_endstops.last_query["manual_stepper tool_dock_stepper"]|default(0) %}
      {% set state = 1 if (v == 1 or v|string == 'TRIGGERED' or v|string == 'triggered') else 0 %}
      RESPOND PREFIX="TEST" MSG="tool_presence={'PRESSED' if state else 'RELEASED'} @Y={y2} sample={k+1}/10"
      G4 P200
    {% endfor %}
    ABRIR
    G4 P500
  {% endfor %}
  FECHAR

[gcode_macro _WAIT_TOOL_UNDOCKED]
gcode:
  {% set tool_y = printer["gcode_macro TOOL_DATA"].tool_y|int %}
  {% set approach = printer["gcode_macro TOOL_DATA"].approach_speed|int %}
  {% set approach_slow = approach // 10 %}
  {% set active_tool = printer["gcode_macro TOOL_STATE"].tool|int %}
  {% if active_tool > 0 %}
    {% set cur_x = printer["gcode_macro TOOL_DATA"].get("dock_x" ~ cur_tool)|float %}
    G90
    G1 Y200 F{printer["gcode_macro TOOL_DATA"].feedrate_troca}
    G1 X{cur_x} Y200 F{printer["gcode_macro TOOL_DATA"].feedrate_troca}
  {% endif %}
  {% set max_attempts = 12 %}
  {% set success = 0 %}
  {% for i in range(max_attempts) %}
    {% if success == 0 %}
      ABRIR SAFE=1
      G4 P200
      G1 Y{tool_y} F{approach_slow}
      G91
      G1 Y-15 F2000
      G90
      G4 P200
      QUERY_ENDSTOPS
      {% set endstops = printer.query_endstops.last_query %}
      {% set state = 1 %}
      {% for kk in endstops %}
        {% if 'tool_dock_stepper' in kk %}
          {% set state = endstops[kk]|int %}
        {% endif %}
      {% endfor %}
      RESPOND PREFIX="TRACK" MSG="WAIT_UNDOCK attempt={i+1} state={state} y={printer.toolhead.position.y}"
      {% if state == 0 %}
        {% set success = 1 %}
      {% endif %}
    {% endif %}
  {% endfor %}
  {% if success == 1 %}
    RESPOND MSG="Tool descarregada OK!"
  {% else %}
    {% set cnt = printer.save_variables.variables.err_wait_undocked_count|default(0)|int + 1 %}
    SAVE_VARIABLE VARIABLE=err_wait_undocked_count VALUE={cnt}
    RESPOND PREFIX="CATALOG" MSG="wait_undocked_timeout count={cnt} y={printer.toolhead.position.y}"
    RESPOND PREFIX="ERROR" MSG="Timeout esperando undock!"
  {% endif %}

[gcode_macro _WAIT_TOOL_DOCKED]
gcode:
  {% set tool_y = printer["gcode_macro TOOL_DATA"].tool_y|int %}
  {% set approach_slow = (printer["gcode_macro TOOL_DATA"].approach_speed|int) // 10 %}
  {% set max_attempts = 12 %}
  {% set success = 0 %}
  {% for i in range(max_attempts) %}
    QUERY_ENDSTOPS
    {% set state = printer.query_endstops.last_query["manual_stepper tool_dock_stepper"]|default(0)|int %}
    RESPOND PREFIX="TRACK" MSG="WAIT_DOCK attempt={i+1} state={state} y={printer.toolhead.position.y}"
    {% if state == 1 %}
      {% set success = 1 %}
    {% else %}
      G1 Y{tool_y + 0.8} F{approach_slow}
      G4 P200
      G1 Y{tool_y} F{approach_slow}
      G4 P200
    {% endif %}
  {% endfor %}
  {% if success == 1 %}
    RESPOND MSG="Tool carregada OK!"
  {% else %}
    {% set cnt = printer.save_variables.variables.err_wait_docked_count|default(0)|int + 1 %}
    SAVE_VARIABLE VARIABLE=err_wait_docked_count VALUE={cnt}
    RESPOND PREFIX="CATALOG" MSG="wait_docked_timeout count={cnt} y={printer.toolhead.position.y}"
    RESPOND PREFIX="ERROR" MSG="Timeout esperando dock!"
  {% endif %}



[gcode_macro FM104]
#rename_existing: M104_BASE
gcode:
  {% set s = params.S|default(0)|float %}
  {% if 'T' in params %}
    {% set t = params.T|int %}
    {% set extr = "extruder" if t==0 else "extruder" ~ t %}
  {% else %}
    {% set extr = printer.toolhead.extruder %}
  {% endif %}
  {% if printer["gcode_macro TOOL_DATA"].debugativo %}
    RESPOND PREFIX="DEBUG" MSG="M104 -> {extr}  S={s}"
  {% endif %}
  SET_HEATER_TEMPERATURE HEATER={extr} TARGET={s}


[gcode_macro FM109]
#rename_existing: M109_BASE
gcode:
  {% set s = params.S|default(0)|float %}
  {% if 'T' in params %}
    {% set t = params.T|int %}
    {% set extr = "extruder" if t==0 else "extruder" ~ t %}
  {% else %}
    {% set extr = printer.toolhead.extruder %}
  {% endif %}
  {% if printer["gcode_macro TOOL_DATA"].debugativo %}
    RESPOND PREFIX="DEBUG" MSG="M109 -> {extr}  S={s}"
  {% endif %}
  SET_HEATER_TEMPERATURE HEATER={extr} TARGET={s}
  TEMPERATURE_WAIT SENSOR={extr} MINIMUM={s-1} MAXIMUM={s+5}


[gcode_macro DEBUG_ATIVO]
description: Ativa ou desativa as mensagens de debug
gcode:
  {% if params.ACAO|default("") == "ON" %}
    SET_GCODE_VARIABLE MACRO=TOOL_DATA VARIABLE=debugativo VALUE=True
    RESPOND PREFIX="INFO" MSG="üîß Debug ATIVADO - mensagens ser√£o exibidas"
  {% elif params.ACAO|default("") == "OFF" %}
    SET_GCODE_VARIABLE MACRO=TOOL_DATA VARIABLE=debugativo VALUE=False
    RESPOND PREFIX="INFO" MSG="üîá Debug DESATIVADO - mensagens ocultadas"
  {% else %}
    {% set status = "ATIVO" if printer["gcode_macro TOOL_DATA"].debugativo else "INATIVO" %}
    RESPOND PREFIX="INFO" MSG="Debug est√° {status}. Use: DEBUG_ATIVO ACAO=ON ou ACAO=OFF"
  {% endif %}

#[include global_probe_config.cfg]  # CONFIGURA√á√ïES GLOBAIS DE COORDENADAS
#[include calibracao_probe_automatica.cfg]  # SISTEMA DE CALIBRA√á√ÉO AUTOM√ÅTICA COM PROBE
[gcode_macro VERIFICAR_FERRAMENTA]
description: Verifica se a ferramenta ainda est√° acoplada durante a impress√£o
gcode:
  {% set current_tool = printer["gcode_macro TOOL_STATE"].tool|int %}
  {% if current_tool > 0 %}
    {% if printer["gcode_macro TOOL_STATE"].switch_present %}
      RESPOND PREFIX="INFO" MSG="‚úÖ Ferramenta T{current_tool} OK"
    {% else %}
      RESPOND PREFIX="ERROR" MSG="‚ùå FERRAMENTA PERDIDA!"
      M117 ERRO: Ferramenta perdida!
      G90
      G1 Y{printer['gcode_macro TOOL_DATA'].secure_y} F{printer['gcode_macro TOOL_DATA'].approach_speed}
      PAUSE
    {% endif %}
  {% else %}
    RESPOND PREFIX="DEBUG" MSG="üîç Nenhuma ferramenta ativa - verifica√ß√£o ignorada"
  {% endif %}

[gcode_macro VERIFICACAO_AUTOMATICA]
description: Ativa verifica√ß√£o autom√°tica da ferramenta a cada 15 segundos
gcode:
  RESPOND PREFIX="INFO" MSG="Verifica√ß√£o autom√°tica desativada"

[delayed_gcode check_tool_timer]
gcode:
  G4 P0

#[include global_probe_config.cfg]  # CONFIGURA√á√ïES GLOBAIS DE COORDENADAS

[gcode_macro DESCONECTA]
gcode:
  {% set next = params.NEXT_TOOL|default(0)|int %}
  {% set tool_y = printer["gcode_macro TOOL_DATA"].tool_y|int %}
  {% set secure_y = printer["gcode_macro TOOL_DATA"].secure_y|int %}
  {% set approach_speed = printer["gcode_macro TOOL_DATA"].approach_speed|int %}
  {% set approach_slow = approach_speed // 10 %}
  {% set active_tool = printer["gcode_macro TOOL_STATE"].tool|int %}
  {% set extruders = {1: "extruder", 2: "extruder1", 3: "extruder2", 4: "extruder3", 5: "extruder4"} %}
  CHECK_SENSOR_NOW
  CHECK_SENSOR_NOW
  {% set sensor_present = printer.save_variables.variables.head_sensor_now|default(0)|int %}
  {% set cur_tool = active_tool if active_tool > 0 else printer.save_variables.variables.last_tool|default(0)|int %}
  {% if cur_tool != 0 or sensor_present == 1 %}
    SAVE_VARIABLE VARIABLE=last_tool VALUE={cur_tool}
    {% set cur_x = printer["gcode_macro TOOL_DATA"].get("dock_x" ~ active_tool)|float %}
    {% if cur_tool <= 5 %}
      {% set extruder_name = extruders[cur_tool] %}
      {% set atual = printer[extruder_name].temperature|float %}
      {% if not printer["gcode_macro TROCA"].skip_filamento|default(False) and atual >= 0 %}
        G91
        G1 E-5 F4000
        G90
      {% endif %}
    {% endif %}
    G1 Y200 F{printer["gcode_macro TOOL_DATA"].feedrate_troca}
    G1 X{cur_x} Y200 F{printer["gcode_macro TOOL_DATA"].feedrate_troca}
    {% set approach_pre = tool_y - 10 %}
    G1 Y{approach_pre} F{approach_speed}
    _ATTEMPT_DISCONNECT
    _CHECK_DISCONNECT_FAILED
    # Verifica se descarregou usando leitura sincronizada
    CHECK_SENSOR_NOW
    CHECK_SENSOR_NOW
    {% set tool_still_present = printer.save_variables.variables.head_sensor_now|default(0)|int %}
    {% if tool_still_present == 0 %}
      G1 Y{secure_y} F{approach_speed}
      RESPOND PREFIX="INFO" MSG="Tool descarregada - movendo para posi√ß√£o segura"
    {% else %}
      RESPOND PREFIX="WARNING" MSG="Tool ainda detectada ap√≥s tentativa de descarga"
    {% endif %}
  {% endif %}


# ============================================================
# Macro DT1 - Descarrega tool1 independentemente da tool atual
# ============================================================
[gcode_macro DT1]
gcode:
  {% set tool_y = printer["gcode_macro TOOL_DATA"].tool_y|int %}
  {% set secure_y = printer["gcode_macro TOOL_DATA"].secure_y|int %}
  {% set approach_speed = printer["gcode_macro TOOL_DATA"].approach_speed|int %}
  
  RESPOND PREFIX="DT1" MSG="Descarregando tool1..."
  
  # Move para posi√ß√£o segura
  G1 Y200 F{printer["gcode_macro TOOL_DATA"].feedrate_troca}
  
  # Move para posi√ß√£o X da tool1 (sempre dock_x1)
  {% set tool1_x = printer["gcode_macro TOOL_DATA"].dock_x2|float %}
  G1 X{tool1_x} Y200 F{printer["gcode_macro TOOL_DATA"].feedrate_troca}
  
  # Aproxima√ß√£o
  {% set approach_pre = tool_y - 10 %}
  G1 Y{approach_pre} F{approach_speed}
  G1 Y{tool_y} F{approach_speed // 10}
  ABRIR
 
  # Move para posi√ß√£o segura
  G1 Y{secure_y} F{approach_speed}
  
  {% if printer["gcode_macro TROCA"].disconnected|default(False) %}
    RESPOND PREFIX="DT1" MSG="‚úì Tool1 descarregada com sucesso"
  {% else %}
    RESPOND PREFIX="DT1" MSG="‚ö† Nenhuma tool foi descarregada (posi√ß√£o tool1)"
  {% endif %}
  
[delayed_gcode PROCESS]
gcode:
 G4 P100



# ============================================================
# Macro CONECTA - agora usa apenas a vari√°vel da HEAD_ENDSTOP_STATUS
# ============================================================
[gcode_macro CONECTA]
gcode:
  {% set tool = params.TOOL|default(0)|int %}
  {% set tool_y = printer["gcode_macro TOOL_DATA"].tool_y|int %}
  {% set secure_y = printer["gcode_macro TOOL_DATA"].secure_y|int %}
  {% set approach_speed = printer["gcode_macro TOOL_DATA"].approach_speed|int %}
  {% set approach_slow = approach_speed // 10 %}
  {% set x_pos = printer["gcode_macro TOOL_DATA"].get("dock_x" ~ tool)|float %}
  {% set extruders = {1: "extruder", 2: "extruder1", 3: "extruder2", 4: "extruder3", 5: "extruder4"} %}

  RESPOND PREFIX="TRACK" MSG="CONECTA start tool={tool} x_pos={x_pos} tool_y={tool_y} secure_y={secure_y}"

  G90
  # Verifica estado inicial - usando c√≥digo num√©rico para evitar erro de literal
  
  #SET_GCODE_VARIABLE MACRO=VERIFICA_CONEXAO_TOOL VARIABLE=acao VALUE=4  # 4=conectou
  VERIFICA_CONEXAO_TOOL  ACAO=4  TOOL={tool} # J√° setamos a vari√°vel acao internamente
     

  G1 X{x_pos} F{printer["gcode_macro TOOL_DATA"].feedrate_troca}
  #G4 P300

  # Sequ√™ncia de acoplamento
  G1 Y{tool_y - 10} F{approach_speed}
  ABRIR SAFE=1
  #G4 P300
  G1 Y{tool_y} F{approach_slow}
  G4 P1300
  FECHAR
  M400
  G4 P1000  # Tempo para o mecanismo e switch estabilizarem
  #SET_GCODE_VARIABLE MACRO=VERIFICA_CONEXAO_TOOL VARIABLE=acao VALUE=1  # 1=conecta
  VERIFICA_CONEXAO_TOOL ACAO=1 TOOL={tool}

  
[gcode_macro EXECUTA_ACOES]
# 1=conecta, 2=desconecta, 3=verifica, 4=conectou
gcode:
  # --- ler ACAO (params tem prioridade; se n√£o, tenta vari√°vel gravada no namespace da macro)
  {% set acao_param = params.get('ACAO') %}
  {% set acao_num = acao_param|int %}
  
  # --- ler TOOL (params tem prioridade; se n√£o, tenta vari√°vel gravada)
  {% set tool_param = params.get('TOOL') %}
  {% set tool = tool_param|int %}
  
  # --- ler TOOL (params tem prioridade; se n√£o, tenta vari√°vel gravada)
  {% set sensor_param = params.get('SENSOR') %}
  {% set sensor = sensor_param|int %}
 
  
  # --- TOOL_DATA (valores padr√£o para evitar erro se n√£o definidos)
  {% set tool_y = printer["gcode_macro TOOL_DATA"].tool_y|default(0)|int %}
  {% set secure_y = printer["gcode_macro TOOL_DATA"].secure_y|default(0)|int %}
  {% set approach_speed = printer["gcode_macro TOOL_DATA"].approach_speed|default(3000)|int %}
  {% set approach_slow = (approach_speed // 10) %}
  {% set x_pos = printer["gcode_macro TOOL_DATA"].get("dock_x" ~ tool)|default(0)|float %}
  {% set extruders = {1: "extruder", 2: "extruder1", 3: "extruder2", 4: "extruder3", 5: "extruder4"} %}

  RESPOND MSG="DEBUG: acao={acao_num} sensor={sensor} tool={tool} x_pos={x_pos}"

  {% if acao_num == 1 %}  # conecta
    {% if sensor == 1 %}
      RESPOND MSG="A√ß√£o CONECTA: sensor detectado - SUCESSO"
      SET_GCODE_VARIABLE MACRO=TOOL_STATE VARIABLE=switch_present VALUE=1
      SET_GCODE_VARIABLE MACRO=TOOL_STATE VARIABLE=tool VALUE={tool}
      SAVE_VARIABLE VARIABLE=tool VALUE={tool}
      {% set extruder_name = extruders.get(tool) %}
      {% if extruder_name is defined and extruder_name != none and printer[extruder_name] is defined %}
        ACTIVATE_EXTRUDER EXTRUDER={extruder_name}
        SYNC_EXTRUDER_MOTION EXTRUDER=belted_extruder MOTION_QUEUE={extruder_name}
        SET_PRESSURE_ADVANCE EXTRUDER=belted_extruder ADVANCE={printer["extruder_stepper belted_extruder"].pressure_advance}
      {% endif %}
      G90
      G1 Y200 F2000
      RESPOND PREFIX="INFO" MSG="Tool {tool} acoplada com sucesso!"
      G1 Y{secure_y} F{approach_speed}
      APPLY_TOOL_OFFSET
      G4 P300
    {% else %}
      RESPOND PREFIX="ERROR" MSG="A√ß√£o CONECTA: sensor n√£o detectado - FALHA"
      SET_GCODE_VARIABLE MACRO=TOOL_STATE VARIABLE=switch_present VALUE=0
      SET_GCODE_VARIABLE MACRO=TOOL_STATE VARIABLE=tool VALUE=0
      SAVE_VARIABLE VARIABLE=tool VALUE=0
      M117 ERRO: Troca falhou
      G90
      G1 Y{secure_y} F{approach_speed}
      PAUSE
    {% endif %}

  {% elif acao_num == 2 %}  # desconecta
    {% if sensor == 0 %}
      RESPOND PREFIX="INFO" MSG="A√ß√£o DESCONECTA: sensor n√£o detectado - SUCESSO"
      SET_GCODE_VARIABLE MACRO=TOOL_STATE VARIABLE=switch_present VALUE=0
      SET_GCODE_VARIABLE MACRO=TOOL_STATE VARIABLE=tool VALUE=0
      SAVE_VARIABLE VARIABLE=tool VALUE=0
      G90
      G1 Y{secure_y} F{approach_speed}
    {% else %}
      RESPOND PREFIX="WARNING" MSG="A√ß√£o DESCONECTA: sensor detectado - FALHA"
    {% endif %}

  {% elif acao_num == 3 %}  # verifica
    {% if sensor == 1 %}
      RESPOND MSG="A√ß√£o VERIFICA: sensor detectado - TOOL PRESENTE"
    {% else %}
      RESPOND MSG="A√ß√£o VERIFICA: sensor n√£o detectado - TOOL AUSENTE"
    {% endif %}

  {% elif acao_num == 4 %}  # conectou
    {% if sensor == 1 %}
      RESPOND MSG="A√ß√£o CONECTOU: sensor detectado - verificar"
      PAUSE
    {% else %}
      M117 ERRO: Conex√£o falhou
    {% endif %}

  {% else %}
    RESPOND MSG="A√ß√£o {acao_num} n√£o reconhecida (sensor={sensor})"
  {% endif %}



[gcode_macro SHOW_VAR]
gcode:
  #RESPOND MSG="ENDSTOP_X = {printer.gcode_variables.ENDSTOP_X}"
[gcode_macro QUERYENDSTOPS]
gcode:
  QUERY_ENDSTOPS
  QUERY_ENDSTOPS

[gcode_macro UPDATE_ENDSTOPS]
gcode:
  {% set acao = params.get('ACAO','0')|string %}
  {% set tool = params.get('TOOL','0')|string %}
  QUERYENDSTOPS
  {% set sensor_raw = printer.query_endstops.last_query['manual_stepper tool_dock_stepper'] %}
  {% set sensor = 1 if (sensor_raw == 1 or sensor_raw == true or sensor_raw|string == 'TRIGGERED') else 0 %}
  EXECUTA_ACOES ACAO={acao} TOOL={tool} SENSOR={sensor}

[gcode_macro VERIFICA_CONEXAO_TOOL]
gcode:
  # recebe ACAO e TOOL (opcional) ao ser chamado
  {% set acao = params.get('ACAO','0')|string %}
  {% set tool = params.get('TOOL','0')|string %}
  RESPOND MSG="VERIFICA_CONEXAO_TOOL chamado: ACAO={acao} TOOL={tool}"
  # 1) atualiza cache de endstops
  UPDATE_ENDSTOPS  ACAO={acao} TOOL={tool}  
  # 2) chama READ_ENDSTOP_VAR_VCT passando ACAO e TOOL (READ far√° o mapeamento e chamar√° EXECUTA_ACOES)
  #READ_ENDSTOP_VAR_VCT ACAO={acao} TOOL={tool}

  
 